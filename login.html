<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Compras</title>
    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        /* Estilos globais para a aplicação */
        body {
            background-color: #f1f5f9; /* Um cinza claro e suave */
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Esconde todas as "telas" por defeito */
        .screen {
            display: none;
        }

        /* Mostra apenas a tela ativa */
        .screen.active {
            display: block;
        }
        
        /* Animação de carregamento (spinner) */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Azul */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        .modal-backdrop {
            display: flex;
        }
        .modal-container {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        /* Sistema de Toasts - Notificações modernas */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
        }
        
        .toast {
            pointer-events: auto;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 4px 6px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(8px);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border-left: 4px solid;
            min-width: 320px;
            max-width: 400px;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast.hide {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .toast-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(21, 128, 61, 0.95) 100%);
            border-left-color: #10b981;
            color: white;
        }
        
        .toast-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(185, 28, 28, 0.95) 100%);
            border-left-color: #ef4444;
            color: white;
        }
        
        .toast-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.95) 0%, rgba(180, 83, 9, 0.95) 100%);
            border-left-color: #f59e0b;
            color: white;
        }
        
        .toast-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95) 0%, rgba(29, 78, 216, 0.95) 100%);
            border-left-color: #3b82f6;
            color: white;
        }
        
        .toast-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toast-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 6px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
        }
        
        .toast-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .toast-message {
            font-size: 13px;
            line-height: 1.5;
            opacity: 0.95;
        }
        
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 0 0 12px 12px;
            transform-origin: left;
            animation: toast-progress 5s linear forwards;
        }
        
        @keyframes toast-progress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }
        
        .toast-icon {
            font-size: 16px;
            margin-right: 2px;
        }
        .modal-panel {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-hidden {
            visibility: hidden;
            opacity: 0;
        }
        .modal-hidden .modal-panel {
            transform: scale(0.9);
            opacity: 0;
        }
        .tag-padrao {
            background-color: #e0f2fe;
            color: #0c4a6e;
            font-weight: 600;
            border: 1px solid #bae6fd;
        }
        .status-ativo { background-color: #dcfce7; color: #166534; }
        .status-inativo { background-color: #fee2e2; color: #991b1b; }
        .tag-padrao {
            background-color: #e0f2fe;
            color: #0c4a6e;
            font-weight: 600;
            border: 1px solid #bae6fd;
        }
        .status-ativo { background-color: #dcfce7; color: #166534; }
        .status-inativo { background-color: #fee2e2; color: #991b1b; }
        
        /* Estilos para a nova tela de busca de pedidos */
        .canceled-row {
            background-color: #fee2e2; /* Red-100 */
            color: #b91c1c; /* Red-700 */
        }
        .canceled-row:hover {
            background-color: #fecaca; /* Red-200 */
        }
        
        /* Spinner de loading */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilo para a marca d'água */
        .print-watermark {
            position: relative;
        }
        .print-watermark::after {
            content: 'CANCELADO';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8rem;
            color: rgba(255, 0, 0, 0.15);
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Container para toasts/notificações -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- O container principal da nossa aplicação de página única -->
    <div id="app">

        <!-- =============================================== -->
        <!-- TELA DE LOGIN                                   -->
        <!-- =============================================== -->
        <div id="screen-login" class="screen active">
            <div class="min-h-screen flex items-center justify-center p-4">
                <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-800">Portal de Compras</h2>
                        <p class="text-gray-500 mt-2">Faça login para entrar</p>
                    </div>
                    <div class="space-y-4">
                        <input type="text" id="username" placeholder="Usuário" required autofocus class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="password" placeholder="Senha" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="selectEmpresaLogin" required class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Primeiro, digite o usuário</option>
                        </select>
                    </div>
                    <button id="loginButton" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75">Entrar</button>
                    <p id="message-login" class="text-center text-sm font-medium min-h-[20px]"></p>
                    <div class="text-center">
                        <button class="text-sm text-blue-600 hover:underline" id="createAccountButton">Criar Conta</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- =============================================== -->
        <!-- TELA DE CADASTRO DE USUÁRIO                     -->
        <!-- =============================================== -->
  <!--->      <div id="screen-cadastro" class="screen">
             <div class="max-w-7xl mx-auto">
                  <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                      <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Gerenciar Usuários</h2>
                      <p class="text-center text-gray-500 mb-6">Controle de acesso, status e auditoria dos usuários.</p>
                      <p id="userManagementMessage" class="text-center text-sm font-medium min-h-[20px] mb-4 transition-opacity duration-300"></p>
                      <div class="overflow-x-auto">
                          <table class="min-w-full divide-y divide-gray-200">
                              <thead class="bg-gray-50">
                                  <tr>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresas</th>
                                      <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                  </tr>
                              </thead>
                              <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                          </table>
                      </div>
                  </div>
              </div>
          </div>

          <!-- Modal de Empresas -->
  <!--->        <div id="modal-empresas-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-container">
              <div class="absolute inset-0 bg-black/60 modal-overlay"></div>
              <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-xl modal-panel">
                  <div class="p-6">
                      <div class="flex items-start justify-between">
                          <h3 class="text-xl font-bold text-gray-800" id="modal-empresas-title"></h3>
                          <button class="modal-close-btn text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                      </div>
                      <div class="mt-6 max-h-72 overflow-y-auto pr-2">
                          <table class="min-w-full">
                              <thead class="bg-gray-50 sticky top-0"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acesso</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th><th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Padrão</th></tr></thead>
                              <tbody id="empresas-list-body"></tbody>
                          </table>
                      </div>
                  </div>
                  <div class="flex justify-end gap-4 p-4 bg-gray-50 rounded-b-2xl"><button class="modal-cancel-btn px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Cancelar</button><button id="modal-empresas-save-btn" class="px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Salvar</button></div>
              </div>
          </div>
          
          <!-- Modal de Auditoria -->
  <!--->        <div id="modal-audit-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-container">
              <div class="absolute inset-0 bg-black/60 modal-overlay"></div>
              <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-xl modal-panel">
                  <div class="p-6">
                      <div class="flex items-start justify-between">
                          <h3 class="text-xl font-bold text-gray-800" id="modal-audit-title"></h3>
                          <button class="modal-close-btn text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                      </div>
                      <div id="modal-audit-body" class="mt-6 space-y-4"></div>
                  </div>
                  <div class="flex justify-end gap-4 p-4 bg-gray-50 rounded-b-2xl"><button class="modal-cancel-btn px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Fechar</button></div>
              </div>
          </div>
         

        <!-- =============================================== -->
        <!-- TELA PRINCIPAL (após o login)                   -->
        <!-- =============================================== -->
        <div id="screen-main" class="screen">
            <!-- Barra de Navegação Superior -->
            <nav class="bg-white shadow-md sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center">
                            <span class="text-2xl font-bold text-blue-600">Portal de Compras</span>
                            <div id="empresaInfo" class="ml-6 hidden md:block text-sm text-gray-600 border-l-2 border-gray-200 pl-4"></div>
                        </div>
                        <div class="flex items-center">
                            <div class="welcome-message text-sm text-gray-700 mr-4 hidden sm:block">
                                Olá, <span id="nome" class="font-semibold"></span> (<span id="perfil"></span>)
                            </div>
                            <button id="logoutButton" class="flex items-center px-3 py-2 bg-red-500 text-white text-sm font-medium rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                                <i class="fas fa-sign-out-alt mr-2"></i>Sair
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Área de Conteúdo Principal -->
            <main id="main-content-area" class="p-4 sm:p-6 lg:p-8">
                <!-- O conteúdo das outras "telas" será injetado aqui -->
            </main>
        </div>
        
        <!-- MODAL GLOBAL DE AVISOS (para substituir alerts) -->
        <div id="global-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center space-y-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800">Aviso</h3>
                <p id="modal-message" class="text-gray-600">Sua mensagem aparecerá aqui.</p>
                <button id="modal-close-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">OK</button>
            </div>
        </div>
        
        <!-- MODAL DE REDEFINIÇÃO DE SENHA -->
        <div id="modalRedefinirSenha" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 space-y-4">
                <h3 class="text-xl font-bold text-gray-800 text-center">Redefinir senha de <span id="modalUsuario" class="text-blue-600"></span></h3>
                <input id="novaSenhaInput" type="password" placeholder="Nova senha" class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg">
                <p id="modalSenhaMsg" class="text-center text-sm font-medium min-h-[20px]"></p>
                <div class="flex space-x-4">
                    <button onclick="fecharModalRedefinirSenha()" class="w-full py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600">Cancelar</button>
                    <button onclick="confirmarRedefinirSenha()" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- MODAL DE VEICULOS -->
        <div id="modal-veiculo" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
  
        <div id="modal-veiculo-overlay" class="absolute inset-0"></div>

        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
          <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Adicionar Novo Veículo</h3>
            
            <div class="mt-4 px-7 py-3">
              <label for="nome-veiculo-input" class="sr-only">Nome do Veículo</label>
              <input type="text" id="nome-veiculo-input"
                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Digite o nome ou a placa">
            </div>

            <div class="items-center px-4 py-3 space-x-4">
              <button id="modal-cancelar-btn"
                      class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md text-base font-medium hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                Cancelar
              </button>
              <button id="modal-salvar-veiculo-btn"
                      class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Salvar
              </button>
            </div>

          </div>
        </div>


    </div>

    <!-- TODO O SEU JAVASCRIPT, ADAPTADO PARA O MODELO SPA -->
    <script>
        // ===============================================
        // SETUP INICIAL E CONTROLO DE TELAS (SPA)
        // ===============================================
        const appDiv = document.getElementById('app');
        const mainContentArea = document.getElementById('main-content-area');

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                
                // Chamar função de setup específica para cada tela
                if (screenId === 'screen-login') {
                    setTimeout(() => setupLoginScreen(), 100);
                } else if (screenId === 'screen-cadastro') {
                    setTimeout(() => setupCadastroScreen(), 100);
                }
                
                console.log('Tela', screenId, 'ativada com sucesso');
            } else {
                console.error(`Tela com ID "${screenId}" não encontrada.`);
            }
        }
        
       function loadPageContent(pageName, callback, ...args) {
            mainContentArea.innerHTML = `<div class="flex justify-center items-center p-10"><div class="spinner"></div></div>`;
            const pageHtml = getPageTemplate(pageName, ...args);

            if (pageHtml) {
                mainContentArea.innerHTML = pageHtml;
                if (callback && typeof callback === 'function') {
                    setTimeout(() => callback(...args), 50);
                }
            } else {
                 mainContentArea.innerHTML = `<div class="text-center text-red-500 font-bold p-10">Erro: Conteúdo para a página "${pageName}" não encontrado.</div>`;
            }
        }


        function getPageTemplate(pageName, ...args) {
            const templates = {
                Menu: `
                    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
            
                    <div class="lg:col-span-1 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Ações da Empresa</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="selectEmpresa" class="block text-sm font-medium text-gray-700 mb-1">Trocar de Empresa:</label>
                                    <select id="selectEmpresa" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"></select>
                                </div>
                                <button id="btnSelecionarEmpresa" class="w-full text-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Confirmar Troca</button>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Menu Principal</h3>
                            <div id="menuOptionsGroup" class="space-y-3"></div>
                        </div>
                    </div>

                    <div id="company-dashboard-container" class="lg:col-span-2 space-y-8">
                        
                        
                            <div id="approval-card-wrapper" class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-check-double text-green-500 mr-3"></i>
                                Aprovações Pendentes
                            </h3>
                            <div id="approval-queue-container" class="flex space-x-4 overflow-x-auto py-2">
                                <p class="text-sm text-gray-500">A carregar...</p>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-bullhorn mr-3 text-orange-500"></i>
                                Mural de Avisos
                            </h3>
                            <div id="notice-board-content" class="text-sm text-gray-600 space-y-3 p-3 bg-slate-50 rounded-md border border-slate-200 max-h-48 overflow-y-auto">
                                <p class="text-sm text-gray-500">A carregar...</p>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Ultimos Pedidos</h3>
                            <div id="dashboard-content-area">
                                <div class="text-center py-10 text-gray-500">
                                    <div class="spinner mx-auto"></div>
                                    <p class="mt-4">A carregar...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`,
                GerenciarUsuarios: `                    
                     <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Gerenciar Usuários</h2>
                        <p class="text-center text-gray-500 mb-6">Controle de acesso, status e auditoria dos usuários.</p>
                        <p id="userManagementMessage" class="text-center text-sm font-medium min-h-[20px] mb-4 transition-opacity duration-300"></p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Empresas</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="backToMenuFromUsersButton" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Voltar ao Início</button>
                        </div>
                    </div>
                    
                    <!-- Modal de Empresas -->
                    <div id="modal-empresas-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-container">
                        <div class="absolute inset-0 bg-black/60 modal-overlay"></div>
                        <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-xl modal-panel">
                            <div class="p-6">
                                <div class="flex items-start justify-between">
                                    <h3 class="text-xl font-bold text-gray-800" id="modal-empresas-title"></h3>
                                    <button class="modal-close-btn text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                                </div>
                                <div class="mt-6 max-h-72 overflow-y-auto pr-2">
                                    <table class="min-w-full">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Acesso</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Empresa</th>
                                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Padrão</th>
                                            </tr>
                                        </thead>
                                        <tbody id="empresas-list-body"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="flex justify-end gap-4 p-4 bg-gray-50 rounded-b-2xl">
                                <button class="modal-cancel-btn px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Cancelar</button>
                                <button id="modal-empresas-save-btn" class="px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Salvar</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal de Auditoria -->
                    <div id="modal-audit-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-hidden modal-container">
                        <div class="absolute inset-0 bg-black/60 modal-overlay"></div>
                        <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-xl modal-panel">
                            <div class="p-6">
                                <div class="flex items-start justify-between">
                                    <h3 class="text-xl font-bold text-gray-800" id="modal-audit-title"></h3>
                                    <button class="modal-close-btn text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                                </div>
                                <div id="modal-audit-body" class="mt-6 space-y-4"></div>
                            </div>
                            <div class="flex justify-end gap-4 p-4 bg-gray-50 rounded-b-2xl">
                                <button class="modal-cancel-btn px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Fechar</button>
                            </div>
                        </div>
                    </div>`,
                CadastroFornecedor: `
                    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-6">
                        <h2 class="text-2xl font-bold text-center text-gray-800">Cadastro de Fornecedor</h2>
                        <form id="form-fornecedor" autocomplete="off" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1">
                                    <label for="codigo" class="block text-sm font-medium text-gray-700">Código</label>
                                    <p id="display-codigo" class="mt-1 block w-full px-3 py-2 bg-gray-100 text-gray-500 rounded-md">Gerando...</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="cnpj" class="block text-sm font-medium text-gray-700">CNPJ</label>
                                    <div class="mt-1 flex rounded-md shadow-sm">
                                        <input type="text" id="cnpj" name="cnpj" required placeholder="Digite o CNPJ" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md px-3 py-2 border-gray-300">
                                        <button type="button" id="consultarCnpjBtn" class="inline-flex items-center px-4 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-sm font-medium text-gray-700 hover:bg-gray-100">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="razao" class="block text-sm font-medium text-gray-700">Razão Social</label>
                                <input type="text" id="razao" name="razao" required placeholder="Digite a Razão Social" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                                <input type="hidden" id="regimeTributarioInput">
                            </div>
                            <div>
                                <label for="fantasia" class="block text-sm font-medium text-gray-700">Nome Fantasia</label>
                                <input type="text" id="fantasia" name="fantasia" required placeholder="Digite o Nome Fantasia" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
                                <input type="text" id="endereco" name="endereco" required placeholder="Endereço completo do fornecedor" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="estado" class="block text-sm font-medium text-gray-700">Estado (UF)</label>
                                <select id="estado" name="estado" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                    <option value="">Carregando estados...</option>
                                </select>
                            </div>
                            <div>
                                <label for="cidade" class="block text-sm font-medium text-gray-700">Cidade</label>
                                <input type="text" id="cidade" name="cidade" required placeholder="Cidade do fornecedor" class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="condicao" class="block text-sm font-medium text-gray-700">Condição de Pagamento</label>
                                    <select id="condicao" name="condicao" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"></select>
                                </div>
                                <div>
                                    <label for="forma" class="block text-sm font-medium text-gray-700">Forma de Pagamento</label>
                                    <select id="forma" name="forma" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"></select>
                                </div>                              
                            </div>
                            <div>
                            <div id="grupo-container" class="hidden">
                                <label for="grupo" class="block text-sm font-medium text-gray-700">Grupo do Fornecedor</label>
                                <select id="grupo" name="grupo" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                          <option value="OBRIGATORIO">OBRIGATORIO</option>
                                          <option value="LIVRE">LIVRE</option>
                                </select>
                            </div>
                            </div>
                            <p id="msgFornecedor" class="text-center text-sm font-medium min-h-[20px]"></p>
                            <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                                <button type="button" id="cancelButton" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Cancelar</button>
                                <button type="button" id="saveButton" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Salvar</button>
                            </div>
                        </form>
                    </div>`,
                Pedido: `
                    <style>
                        /* Faz o card de totais "flutuar" na lateral em telas grandes */
                        .sticky-summary {
                            position: sticky;
                            top: 2rem;
                        }
                        
                        /* Estilo para campos obrigatórios */
                        .campo-obrigatorio {
                            border-left: 4px solid #f59e0b;
                        }
                        
                        /* Indicador de rascunho */
                        .draft-indicator {
                            background: linear-gradient(45deg, #fbbf24, #f59e0b);
                        }
                    </style>
                    
                    <div class="max-w-7xl mx-auto">
                        <header class="mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 id="page-title" class="text-3xl font-bold text-gray-800">Novo Pedido de Compra</h1>
                                    <p id="page-subtitle" class="text-gray-500">Preencha os dados e adicione os itens.</p>
                                </div>
                                <div id="draft-status" class="hidden px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg border border-yellow-300">
                                    <i class="fas fa-edit mr-2"></i>Rascunho
                                </div>
                            </div>
                            <p id="msgPedido" class="text-center text-sm font-medium min-h-[20px] mt-2"></p>
                        </header>

                        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Coluna Principal (Esquerda) -->
                            <div class="lg:col-span-2 space-y-8">
                                <!-- Dados do Pedido e Fornecedor -->
                                <div class="bg-white p-6 rounded-xl shadow-lg">
                                    <h3 class="font-bold text-lg text-gray-700 mb-4">1. Informações do Pedido</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                        <div>
                                            <label for="numeroPedido" class="block text-sm font-medium text-gray-700">Número do Pedido</label>
                                            <input type="text" id="numeroPedido" name="numeroPedido" placeholder="------" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 text-gray-500 rounded-md cursor-not-allowed">
                                        </div>
                                        <div>
                                            <label for="dataPedido" class="block text-sm font-medium text-gray-700">Data do Pedido</label>
                                            <input type="date" id="dataPedido" name="dataPedido" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 text-gray-500 rounded-md cursor-not-allowed">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Estado (UF)</label>
                                            <p id="fornecedor-estado" class="mt-1 block w-full px-3 py-2 bg-gray-100 text-gray-500 rounded-md">Selecione</p>
                                        </div>
                                        <div>
                                            <label for="aliquota-display" class="block text-sm font-medium text-gray-700">Alíquota</label>
                                            <p id="aliquota-display" class="mt-1 block w-full px-3 py-2 bg-gray-100 text-gray-500 rounded-md">-- %</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <label for="fornecedorPedido" class="block text-sm font-medium text-gray-700">Fornecedor <span class="text-red-500">*</span></label>
                                            <select id="fornecedorPedido" name="fornecedorPedido" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                                                <option value="">-- Selecione um Fornecedor --</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                            <!-- Informações Adicionais -->
                                <div class="bg-white p-6 rounded-xl shadow-lg">
                                    <h3 class="font-bold text-lg text-gray-700 mb-4">2. Informações Adicionais</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                        <div>
                                            <label for="nomeVeiculo" class="block text-sm font-medium text-gray-700">
                                                Nome do Veículo <span id="veiculo-required" class="text-red-500 hidden">*</span>
                                            </label>
                                            <div class="mt-1 flex rounded-md shadow-sm">
                                                <select id="nomeVeiculo" name="nomeVeiculo" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md px-3 py-2 border-gray-300">
                                                    <option value="">-- Selecione um Veículo --</option>
                                                </select>
                                                <button type="button" id="addVeiculoButton" title="Adicionar Novo Veículo" class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 rounded-r-md bg-green-500 text-white hover:bg-green-600">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="placaVeiculo" class="block text-sm font-medium text-gray-700">
                                                Placa <span id="placa-required" class="text-red-500 hidden">*</span>
                                            </label>
                                            <input type="text" id="placaVeiculo" name="placaVeiculo" placeholder="" class="mt-1 block w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-md auto-uppercase">
                                        </div>
                                    </div>
                                    <div>
                                        <label for="observacoesPedido" class="block text-sm font-medium text-gray-700">
                                            Observações do Pedido <span id="obs-required" class="text-red-500 hidden">*</span>
                                        </label>
                                        <textarea id="observacoesPedido" name="observacoesPedido" rows="3" placeholder="Adicione observações importantes para o pedido..." class="mt-1 block w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-md auto-uppercase"></textarea>
                                    </div>
                                </div>

                                <!-- Seção dos Itens existentes foi removida para não conflitar com o layout atual -->

                                <!-- Formulário para Adicionar Itens -->
                                <div class="bg-white p-6 rounded-xl shadow-lg">
                                    <h3 class="font-bold text-lg text-gray-700 mb-4">3. Adicionar Itens ao Pedido</h3>
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                                            <div class="md:col-span-2">
                                                <label for="itemDescricao" class="block text-sm font-medium text-gray-700">Descrição do Item</label>
                                                <input type="text" id="itemDescricao" name="itemDescricao" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm auto-uppercase" placeholder="Ex: Paralama Random">
                                            </div>
                                            <div class="md:col-span-2">
                                                <label for="CodigoFornecedor" class="block text-sm font-medium text-gray-700">Código Produto Fornecedor</label>
                                                <input type="text" id="itemProdutoFornecedor" name="produtoFornecedor" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm auto-uppercase" placeholder="Ex: S10037">
                                            </div>
                                            <div>
                                                <label for="itemQuantidade" class="block text-sm font-medium text-gray-700">Qtd.</label>
                                                <input type="number" id="itemQuantidade" name="itemQuantidade" value="0" min="0.01" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                            </div>
                                            <div>
                                                <label for="itemUnidade" class="block text-sm font-medium text-gray-700">Unid.</label>
                                                <select id="itemUnidade" name="itemUnidade" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                                    <option value="UN">UN</option>
                                                    <option value="MT">MT</option>
                                                    <option value="L">L</option>
                                                    <option value="RL">RL</option>
                                                    <option value="CX">CX</option>
                                                </select>
                                            </div>
                                            <div class="md:col-span-2">
                                                <label for="itemPrecoUnitario" class="block text-sm font-medium text-gray-700">Valor Unit. (R$)</label>
                                                <input type="text" id="itemPrecoUnitario" name="itemPrecoUnitario" placeholder="0,00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-right">
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center pt-4 border-t">
                                            <span class="text-sm text-gray-500">Subtotal do item: <strong id="live-subtotal" class="text-gray-800">R$ 0,00</strong></span>
                                            <button type="button" id="addItemButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 flex items-center justify-center">
                                                <i class="fas fa-plus mr-2"></i> Adicionar ao Pedido
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tabela de Itens Adicionados -->
                                <div class="bg-white rounded-xl shadow-lg">
                                    <h3 class="font-bold text-lg text-gray-700 p-6">4. Itens no Pedido</h3>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full">
                                            <thead class="bg-gray-50">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descrição</th>
                                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cod. Forn.</th>
                                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Qtd.</th>
                                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Unid.</th>
                                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Vl. Unit.</th>
                                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Subtotal</th>
                                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="itensTableBody" class="bg-white divide-y divide-gray-200">
                                                <tr id="no-items-row"><td colspan="6" class="text-center text-gray-500 py-10">Nenhum item adicionado.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>    

                            <!-- Coluna de Resumo (Direita) -->
                            <div class="lg:col-span-1">
                                <div class="bg-white p-6 rounded-xl shadow-lg sticky-summary space-y-4">
                                    <h3 class="font-bold text-lg text-gray-700 border-b pb-3">Resumo Financeiro</h3>
                                    
                                    <div class="flex justify-between text-gray-600">
                                        <span>Soma dos Itens</span>
                                        <span id="totalGeral">R$ 0,00</span>
                                    </div>
                                    <div class="flex justify-between text-gray-600">
                                        <span>Impostos (ICMS ST)</span>
                                        <span id="valor-imposto">R$ 0,00</span>
                                    </div>
                                    
                                    <div class="border-t-2 border-dashed pt-4">
                                        <div class="flex justify-between items-center font-bold text-xl text-gray-800">
                                            <span>Total Geral</span>
                                            <span id="summary-total">R$ 0,00</span>
                                        </div>
                                    </div>

                                    <div class="pt-6 space-y-3">
                                        <button id="salvarRascunhoButton" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-600">
                                            <i class="fas fa-save mr-2"></i>Salvar Rascunho
                                        </button>
                                        <button id="salvarPedidoButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700">
                                            <i class="fas fa-check mr-2"></i>Finalizar e Salvar Pedido
                                        </button>
                                        <button id="cancelarPedidoButton" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300">
                                            <i class="fas fa-times mr-2"></i>Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>`,
                MeusPedidos: `
                        <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Meus Pedidos Aprovados</h2>
                                <p class="text-gray-500">Aqui está o histórico de todos os seus pedidos que já foram aprovados.</p>
                            </div>
                            <button onclick="loadPageContent('Menu', setupMenuScreen)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                                &larr; Voltar ao Menu
                            </button>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Nº Pedido</th>
                                            <th scope="col" class="px-6 py-3">Data</th>
                                            <th scope="col" class="px-6 py-3">Fornecedor</th>
                                            <th scope="col" class="px-6 py-3">Empresa</th>
                                            <th scope="col" class="px-6 py-3 text-right">Valor Total</th>
                                            <th scope="col" class="px-6 py-3 text-center">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabela-meus-pedidos">
                                        <!-- O conteúdo da tabela será carregado aqui -->
                                        <tr>
                                            <td colspan="6" class="text-center p-8">
                                                <div class="spinner mx-auto"></div>
                                                <p class="mt-2 text-gray-500">Carregando seus pedidos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`, 
                PedidoSalvo: `
                    <div class="text-center p-8 bg-white rounded-2xl shadow-xl space-y-6 max-w-lg mx-auto">
                        <i class="fas fa-check-circle text-6xl text-green-500"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Pedido Salvo!</h2>
                        <p class="text-gray-600">O pedido <strong>${args[0]}</strong> foi salvo com sucesso.</p>
                        <div class="flex justify-center space-x-4">
                            <button id="voltarMenuPrincipalButton" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700">Voltar ao Início</button>
                            <button id="printPedidoButton" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">
                                <i class="fas fa-print mr-2"></i>Imprimir Pedido
                            </button>
                        </div>
                    </div>`,
                PedidoImpressao: `
                     <div>
                        <style>
                            body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #fff; -webkit-print-color-adjust: exact; color-adjust: exact; }
                            .print-container { width: 210mm; min-height: 297mm; margin: 10mm auto; border: 1px solid #ccc; box-shadow: 0 0 5px rgba(0,0,0,0.1); background-color: #fff; padding: 15mm; box-sizing: border-box; }
                            .header-section { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
                            .company-info { display: flex; align-items: flex-start; flex: 2; text-align: left; }
                            .company-logo { width: 60px; height: 60px; margin-right: 15px; border: 1px solid #eee; padding: 5px; }
                            .company-details { font-size: 0.8em; line-height: 1.2; }
                            .company-details strong { font-size: 1.2em; display: block; margin-bottom: 3px; }
                            .company-details p { margin: 0; }
                            .order-info { flex: 1; display: flex; flex-direction: column; align-items: flex-end; font-size: 0.9em; gap: 5px; }
                            .info-box { border: 1px solid #000; padding: 5px 10px; text-align: center; width: 100%; box-sizing: border-box; background-color: #f0f0f0; }
                            .info-box span:first-child { display: block; font-weight: bold; margin-bottom: 2px; font-size: 0.9em; }
                            .info-box span:last-child { font-size: 1.1em; font-weight: bold; color: #0056b3; }
                            .supplier-section { display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 10px; font-size: 0.85em; }
                            .supplier-details, .supplier-meta { flex: 1; text-align: left; }
                            .supplier-section p { margin: 2px 0; }
                            .supplier-details { padding-right: 15px; }
                            .vehicle-section { border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 10px; font-size: 0.85em; text-align: left; }
                            .vehicle-section p { margin: 2px 0; display: inline-block; margin-right: 20px; }
                            .items-table-section { margin-bottom: 15px; }
                            table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
                            th, td { border: 1px solid #000; padding: 6px 8px; text-align: left; vertical-align: top; }
                            th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
                            td { white-space: normal; word-wrap: break-word; }
                            .total-notes-section { border: 1px solid #000; padding: 10px; margin-top: 20px; margin-bottom: 20px; background-color: #f5f5f5; }
                            .total-value { font-size: 1.1em; font-weight: bold; text-align: right; margin-bottom: 10px; }
                            .notes { font-size: 0.8em; text-align: center; line-height: 1.3; }
                            .attention-text { font-weight: bold; color: #dc3545; }
                            .signature-section { text-align: center; margin-top: 30px; font-size: 0.9em; font-weight: bold; }
                            .signature-section p { margin: 2px 0; }
                            @media print { .print-container { border: none; box-shadow: none; margin: 0; width: 100%; min-height: auto; padding: 0; } body { margin: 0; padding: 0; } }
                        </style>
                        <div class="print-container">
                            <div class="header-section">
                                <div class="company-info">
                                    <img src="https://placehold.co/100x100/eeeeee/black?text=LOGO" alt="Logo da Empresa" class="company-logo">
                                    <div class="company-details">
                                        <strong id="empresaNomePrint"></strong><p id="empresaEnderecoPrint"></p><p id="empresaCidadeUfPrint"></p>
                                        <p>CNPJ: <span id="empresaCnpjPrint"></span></p><p id="empresaEmailPrint"></p><p id="empresaTelefonePrint"></p>
                                    </div>
                                </div>
                                <div class="order-info">
                                    <div class="info-box date-box"><span>DATA DA EMISSÃO</span><span id="dataEmissaoPrint"></span></div>
                                    <div class="info-box order-number-box"><span>NÚMERO DO PEDIDO</span><span id="numeroPedidoPrint"></span></div>
                                </div>
                            </div>
                            <div class="supplier-section">
                                <div class="supplier-details">
                                    <p><strong>FORNECEDOR:</strong> <span id="fornecedorPrint"></span></p><p><strong>ENDEREÇO:</strong> <span id="enderecoFornecedorPrint"></span></p><p><strong>FORMA PGTO:</strong> <span id="formaPagamentoPrint"></span></p>
                                </div>
                                <div class="supplier-meta">
                                    <p><strong>CNPJ:</strong> <span id="cnpjFornecedorPrint"></span></p><p><strong>CONDIÇÃO PGTO:</strong> <span id="condicaoPagamentoPrint"></span></p>
                                </div>
                            </div>
                            <div class="vehicle-section">
                                <p><strong>PLACA:</strong> <span id="placaVeiculoPrint"></span></p><p><strong>VEÍCULO:</strong> <span id="nomeVeiculoPrint"></span></p>
                            </div>
                            <div class="items-table-section">
                                <table>
                                    <thead><tr><th style="width: 5%;">CÓD.</th><th style="width: 40%;">DESCRIÇÃO</th><th style="width: 15%;">UNIDADE</th><th style="width: 10%;">QTD.</th><th style="width: 15%;">VALOR UNIT.</th><th style="width: 15%;">SUBTOTAL</th></tr></thead>
                                    <tbody id="printItemsTableBody"></tbody>
                                </table>
                            </div>
                            <div class="total-notes-section">
                                <div class="total-value"><strong>VALOR TOTAL DA NOTA:</strong> <span id="totalGeralPrint"></span></div>
                                <div class="notes"><p id="observacoesPedidoPrint" class="note-text"></p><p class="attention-text">Atenção: Qualquer alteração só pode ser realizada mediante autorização prévia, sob risco de não pagamento.</p></div>
                            </div>
                            <div class="signature-section">
                                <p><strong id="usuarioLogadoPrint"></strong></p><p id="funcaoUsuarioLogadoPrint"></p>
                            </div>
                        </div>
                    </div>`,
                BuscarPedido: `
                    <div class="max-w-7xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Buscar Ordem de Compra</h2>

                        <!-- Filtros de Busca -->
                        <div class="space-y-4">
                            <!-- Filtro Principal -->
                            <div class="flex flex-col sm:flex-row gap-4">
                                <input type="text" id="mainSearch" placeholder="Buscar por Nº do Pedido ou Fornecedor..." class="flex-grow w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button id="searchButton" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                                    <i class="fas fa-search mr-2"></i>Buscar
                                </button>
                            </div>
                            <!-- Botão para Filtros Avançados -->
                            <div>
                                <button id="toggleAdvancedFilters" class="text-sm text-blue-600 hover:underline">
                                    Filtros Avançados <i class="fas fa-chevron-down ml-1 transition-transform"></i>
                                </button>
                            </div>
                            <!-- Filtros Avançados (escondidos por defeito) -->
                            <div id="advancedFilters" class="hidden pt-4 border-t border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="date" id="dateStart" title="Data Inicial" class="px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                    <input type="date" id="dateEnd" title="Data Final" class="px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                    <input type="text" id="plateSearch" placeholder="Placa do Veículo" class="px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                    <!-- CAMPO ADICIONAL PARA ADMIN -->
                                    <div id="filtro-admin-usuario" class="hidden">
                                        <input type="text" id="busca-usuario-criador" placeholder="Usuário que criou" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                    </div>
                                    <button id="clearFiltersButton" class="md:col-span-2 w-full h-full bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Limpar Filtros</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tabela de Resultados -->
                        <div class="mt-8 overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fornecedor</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="searchResultsBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Linhas de resultados serão inseridas aqui -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Botão Voltar -->
                        <div class="mt-6 text-center">
                            <button id="backToMenuFromSearchButton" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Voltar ao Início</button>
                        </div>
                    </div>
                    
                    <!-- Modal para Simulação de Impressão -->
                    <div id="print-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
                        <div id="print-content" class="bg-white p-8 rounded-lg max-w-2xl w-full">
                            <!-- Conteúdo da impressão simulada aqui -->
                            <h3 class="text-xl font-bold">Pedido #<span id="print-pedido-id"></span></h3>
                            <p>Conteúdo do pedido...</p>
                            <button id="close-print-modal" class="mt-4 w-full py-2 bg-gray-500 text-white rounded-lg">Fechar</button>
                        </div>
                    </div>
                `,
                Dashboard: `
                    <body class="p-4 sm:p-6 lg:p-8">
                                <div class="max-w-7xl mx-auto">
                                    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6">
                                        <div>
                                            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Dashboard de Análise</h1>
                                            <p id="nomeEmpresa" class="text-gray-500">Carregando Empresa...</p> </div>
                                            <button id="backToMenuFromDashboard" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 flex items-center space-x-2">
                                              <i class="fas fa-arrow-left"></i>
                                              <span>Voltar ao Menu</span>
                                          </button>
                                        </div>
                                    </header>

                                    <details class="bg-white rounded-xl shadow-md p-6 mb-6">
                                        <summary class="font-semibold text-lg text-gray-700 cursor-pointer flex justify-between items-center">
                                            Filtros Avançados
                                            <i class="fas fa-chevron-down chevron-icon"></i>
                                        </summary>
                                        <div class="mt-4 pt-4 border-t">
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                                <div>
                                                    <label for="dateStart" class="block text-sm font-medium text-gray-700">Data de Início</label>
                                                    <input type="date" id="dateStart" class="mt-1 w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                                </div>
                                                <div>
                                                    <label for="dateEnd" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                                                    <input type="date" id="dateEnd" class="mt-1 w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                                </div>
                                                <div>
                                                    <label for="supplier" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                                                    <select id="supplier" class="mt-1 w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                                        <option value="">Todos</option>
                                                        </select>
                                                </div>
                                                <div>
                                                    <label for="state" class="block text-sm font-medium text-gray-700">Estado (UF)</label>
                                                    <select id="state" class="mt-1 w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                                                        <option value="">Todos</option>
                                                        </select>
                                                </div>
                                            </div>
                                            <div class="flex justify-end space-x-3 mt-4 pt-4 border-t">
                                                <button id="clearFiltersButton" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Limpar</button>
                                                <button id="applyFiltersButton" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Aplicar Filtros</button>
                                            </div>
                                        </div>
                                    </details>

                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        
                                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                                            <div class="bg-blue-100 p-4 rounded-full"><i class="fas fa-dollar-sign fa-2x text-blue-600"></i></div>
                                            <div>
                                                <p class="text-gray-500 text-sm">Valor Total Gasto</p>
                                                <p id="totalGasto" class="text-3xl font-bold text-gray-800">Carregando...</p> 
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                                            <div class="bg-green-100 p-4 rounded-full"><i class="fas fa-receipt fa-2x text-green-600"></i></div>
                                            <div>
                                                <p class="text-gray-500 text-sm">Total de Pedidos</p>
                                                <p id="totalPedidos" class="text-3xl font-bold text-gray-800">Carregando...</p>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                                            <div class="bg-yellow-100 p-4 rounded-full"><i class="fas fa-chart-pie fa-2x text-yellow-600"></i></div>
                                            <div>
                                                <p class="text-gray-500 text-sm">Ticket Médio por Pedido</p>
                                                <p id="ticketMedio" class="text-3xl font-bold text-gray-800">Carregando...</p>
                                            </div>
                                        </div>

                                        <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-md">
                                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pedidos e Gastos por Mês</h3>
                                            <div class="h-72"><canvas id="monthlyAnalysisChart"></canvas></div>
                                        </div>

                                        <div class="md:col-span-1 bg-white p-6 rounded-xl shadow-md">
                                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 5 Fornecedores (por valor)</h3>
                                            <div class="h-72"><canvas id="topSuppliersChart"></canvas></div>
                                        </div>

                                        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pedidos Recentes</h3>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pedido</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fornecedor</th>
                                                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Valor</th>
                                                            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="recentOrdersTableBody" class="divide-y divide-gray-200">
                                                        </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                                <i class="fas fa-lightbulb mr-3 text-purple-500"></i>
                                                Análise e Sugestões da IA
                                            </h3>
                                            <div id="iaSuggestions" class="space-y-3 text-sm text-gray-700">
                                                </div>
                                        </div>

                                    </div>
                                </div>

                `,
                Relatorios: `
                    <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-6">
                        <h2 class="text-2xl font-bold text-center text-gray-800">Relatórios de Compras</h2>
                        <form id="reportForm" autocomplete="off" class="space-y-6">
                            <div class="p-4 border border-gray-200 rounded-lg">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Filtros</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="startDate" class="block text-sm font-medium text-gray-700">Data Inicial:</label>
                                        <input type="date" id="startDate" name="startDate" class="mt-1 block w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-md">
                                    </div>
                                    <div>
                                        <label for="endDate" class="block text-sm font-medium text-gray-700">Data Final:</label>
                                        <input type="date" id="endDate" name="endDate" class="mt-1 block w-full px-3 py-2 bg-gray-50 border-gray-300 rounded-md">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="supplierSelect" class="block text-sm font-medium text-gray-700">Fornecedor:</label>
                                        <select id="supplierSelect" name="supplierSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                            <option value="todos">Todos os Fornecedores</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 border border-gray-200 rounded-lg">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Tipo de Relatório</h3>
                                <div class="flex flex-col space-y-2">
                                    <label class="flex items-center">
                                        <input type="radio" id="reportTypeDetailed" name="reportType" value="detailed" checked class="h-4 w-4 text-blue-600 border-gray-300">
                                        <span class="ml-3 text-sm text-gray-700">Detalhado (por Data/Fornecedor)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" id="reportTypeFinancial" name="reportType" value="financial" class="h-4 w-4 text-blue-600 border-gray-300">
                                        <span class="ml-3 text-sm text-gray-700">Financeiro (Resumo)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <p id="reportMessage" class="text-center text-sm font-medium min-h-[20px]"></p>

                            <div id="reportPreviewArea" class="hidden text-center p-4 bg-blue-50 rounded-lg">
                                <a id="downloadLink" href="#" target="_blank" class="text-blue-600 font-semibold hover:underline">
                                    <i class="fas fa-download mr-2"></i>Baixar Relatório
                                </a>
                            </div>

                            <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                                <button type="button" id="backToMenuFromReportsButton" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Voltar</button>
                                <button type="button" id="generatePdfButton" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700"><i class="fas fa-file-pdf mr-2"></i>Gerar PDF</button>
                                <button type="button" id="generateXlsButton" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700"><i class="fas fa-file-excel mr-2"></i>Gerar XLSX</button>
                                <button type="button" id="testBackendButton" class="px-6 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600">
                                    <i class="fas fa-plug mr-2"></i>Testar Backend
                                </button>
                            </div>
                        </form>
                    </div>`,
                GerenciarFornecedores: `
                    <div class="bg-white rounded-2xl shadow-xl p-6 sm:p-8">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Gerenciar Fornecedores</h2>
                        <p id="fornecedorListMessage" class="text-center text-sm font-medium min-h-[20px] mb-4"></p>
                        <div class="flex justify-start mb-4">
                            <button id="addNewFornecedorBtn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Adicionar Novo
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Razão Social</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome Fantasia</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CNPJ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Grupo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="fornecedoresTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                        <div class="mt-6 text-center">
                            <button id="backToMenuFromSuppliersButton" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Voltar ao Início</button>
                        </div>
                    </div>`,
                TrocarSenha: `
                    <div class="max-w-md mx-auto bg-white rounded-2xl shadow-xl p-8 space-y-6">
                        <h2 class="text-2xl font-bold text-center text-gray-800">Trocar Senha</h2>
                        <p id="msgTrocaSenha" class="text-center text-sm font-medium min-h-[20px]"></p>
                        <div class="space-y-4">
                            <div>
                                <label for="senhaAtual" class="block text-sm font-medium text-gray-700">Senha Atual:</label>
                                <input type="password" id="senhaAtual" autocomplete="current-password" class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label for="novaSenha" class="block text-sm font-medium text-gray-700">Nova Senha:</label>
                                <input type="password" id="novaSenha" autocomplete="new-password" class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label for="confirmaSenha" class="block text-sm font-medium text-gray-700">Confirme a Nova Senha:</label>
                                <input type="password" id="confirmaSenha" autocomplete="new-password" class="mt-1 w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div class="flex space-x-4 pt-4 border-t border-gray-200">
                            <button id="btnVoltarMenuSenha" class="w-full py-3 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600">Voltar</button>
                            <button id="btnSalvarSenha" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Salvar</button>
                        </div>
                    </div>`,
                GerenciarRascunhos: `
                    <div class="max-w-7xl mx-auto">
                        <header class="mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h1 class="text-3xl font-bold text-gray-800">Gerenciar Rascunhos</h1>
                                    <p class="text-gray-500">Visualize, edite ou finalize seus rascunhos salvos.</p>
                                </div>
                                <button id="backToMenuFromRascunhosButton" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">
                                    <i class="fas fa-arrow-left mr-2"></i>Voltar ao Menu
                                </button>
                            </div>
                            <p id="rascunhosMessage" class="text-center text-sm font-medium min-h-[20px] mt-2"></p>
                        </header>

                        <main class="bg-white p-6 rounded-xl shadow-lg">
                            <div class="mb-4 flex items-center justify-between">
                                <h3 class="text-lg font-bold text-gray-700">Rascunhos Salvos</h3>
                                <span id="totalRascunhos" class="text-sm text-gray-500">Carregando...</span>
                            </div>
                            
                            <!-- Filtros -->
                            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="filtroFornecedor" class="block text-sm font-medium text-gray-700">Fornecedor</label>
                                    <select id="filtroFornecedor" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md">
                                        <option value="">Todos os fornecedores</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filtroDataInicio" class="block text-sm font-medium text-gray-700">Data Início</label>
                                    <input type="date" id="filtroDataInicio" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label for="filtroDataFim" class="block text-sm font-medium text-gray-700">Data Fim</label>
                                    <input type="date" id="filtroDataFim" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>

                            <!-- Tabela de Rascunhos -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fornecedor</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Itens</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Última Edição</th>
                                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rascunhosTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Conteúdo será carregado dinamicamente -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Estado vazio -->
                            <div id="emptyStateRascunhos" class="hidden text-center py-10">
                                <div class="bg-gray-100 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-inbox text-gray-400 text-xl"></i>
                                </div>
                                <p class="text-gray-500 text-lg mb-2">Nenhum rascunho encontrado</p>
                                <p class="text-gray-400 text-sm">Comece criando um novo pedido e salvando como rascunho.</p>
                                <button onclick="criarNovoPedidoFromRascunho()" class="mt-4 px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200">
                                    <i class="fas fa-plus mr-2"></i>Criar Novo Pedido
                                </button>
                            </div>
                        </main>
                    </div>`
            };
            return templates[pageName] || null;
        }

        // ===============================================
        // FUNÇÃO AUXILIAR PARA CRIAR NOVO PEDIDO
        // ===============================================
        function criarNovoPedidoFromRascunho() {
            // Limpar dados de visualização
            localStorage.removeItem('modoVisualizacao');
            localStorage.removeItem('origemVisualizacao'); 
            localStorage.removeItem('pedidoParaVisualizar');
            localStorage.removeItem('empresaOriginalAdmin');
            localStorage.removeItem('numeroPedidoVisualizacao');
            
            // Carregar tela de novo pedido
            loadPageContent('Pedido', setupPedidoScreen);
        }

        // ===============================================
        // FUNÇÃO PARA SALVAR EDIÇÃO DE PEDIDO
        // ===============================================
        
        function salvarEdicaoPedido() {
            console.log('💾 Iniciando salvamento de edição do pedido');

            const dadosOriginais = EdicaoPedido.getDados();

            if (!dadosOriginais) {
                showToast('Erro: Dados do pedido não encontrados.', 'error', 'Erro Interno');
                return;
            }
            
            // Verificar se ainda está em modo de edição válido
            if (!verificarSePermiteEdicao(dadosOriginais)) {
                showToast('Tempo de edição expirado ou dados inválidos. Redirecionando...', 'warning', 'Tempo Expirado');
                setTimeout(() => {
                    EdicaoPedido.limpar();
                    loadPageContent('BuscarPedido', setupBuscaScreen);
                }, 2000);
                return;
            }

            if (!window.itensAdicionados || window.itensAdicionados.length === 0) {
                showToast('Adicione pelo menos um item ao pedido.', 'error', 'Itens Obrigatórios');
                return;
            }            

            const salvarButton = document.getElementById('salvarPedidoButton');
            // Validar campos obrigatórios básicos
            const fornecedor = document.getElementById('fornecedorPedido')?.value;
            if (!fornecedor) {
                showToast('Por favor, selecione um fornecedor.', 'error', 'Campo Obrigatório');
                return;
            }

             // Coleta os itens diretamente da variável global, que já contém todas as alterações.
              const itens = window.itensAdicionados.map(item => ({
                  descricao: item.descricao,
                  quantidade: item.quantidade,
                  unidade: item.unidade,
                  precoUnitario: item.precoUnitario,
                  totalItem: item.subtotal || (item.quantidade * item.precoUnitario) // Garante que o subtotal seja calculado
              }));

              const totalGeral = itens.reduce((total, item) => total + item.totalItem, 0);
              
            // Coletar dados do formulário (reutilizando a lógica existente)
            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
            const idDaEmpresa = empresaAtual.id || empresaAtual.codigo;
            
             const valorImpostoTexto = document.getElementById('valor-imposto')?.textContent || 'R$ 0,00';
              const valorImpostoNumerico = parseFloat(
                  valorImpostoTexto.replace('R$', '').replace(/\./g, '').replace(',', '.')
              ) || 0;

            // Preparar dados para edição
            const dadosEdicao = {
                numeroDoPedido: dadosOriginais.numeroDoPedido,
                fornecedor: fornecedor,
                nomeVeiculo: document.getElementById('nomeVeiculo')?.value || '',
                placaVeiculo: document.getElementById('placaVeiculo')?.value || '',
                observacoes: document.getElementById('observacoes')?.value || '',
                itens: itens,
                totalGeral: totalGeral,
                valorIcms: valorImpostoNumerico,
                empresaId: idDaEmpresa,
                dataCriacao: dadosOriginais.dataCriacao,
                usuarioCriador: dadosOriginais.usuarioCriador
            };
            
            console.log('📤 Dados para edição:', dadosEdicao);
            
            // Desabilitar botão e mostrar loading
            if (salvarButton) {
                salvarButton.disabled = true;
                salvarButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando Alterações...';
            }
            
            showToast('Salvando alterações no pedido...', 'info', 'Processando');
            
            // Enviar para o backend
            google.script.run
                .withSuccessHandler(response => {
                    console.log('✅ Resposta da edição:', response);
                    
                    if (salvarButton) {
                        salvarButton.disabled = false;
                        salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Alterações';
                    }
                    
                    if (response && response.status === 'success') {
                        showToast('Pedido editado com sucesso!', 'success', 'Sucesso');
                        EdicaoPedido.limpar();                        
                        setTimeout(() => {
                            loadPageContent('BuscarPedido', setupBuscaScreen);
                        }, 1500);
                    } else {
                        showToast(response.message || 'Erro ao salvar alterações.', 'error', 'Erro no Salvamento');
                    }
                })
                .withFailureHandler(error => {
                    console.error('❌ Erro ao salvar edição:', error);
                    
                    if (salvarButton) {
                        salvarButton.disabled = false;
                        salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Alterações';
                    }
                    
                    showToast('Erro de comunicação ao salvar alterações.', 'error', 'Erro de Comunicação');
                })
                .editarPedido(dadosEdicao);
        }

        // ===============================================
        // FUNÇÕES UTILITÁRIAS GLOBAIS
        // ===============================================
        
        function showGlobalModal(title, message, type = 'info') {
            const modal = document.getElementById('global-modal');
            if(!modal) return;
            const modalTitle = modal.querySelector('#modal-title');
            const modalMessage = modal.querySelector('#modal-message');
            if(modalTitle) modalTitle.textContent = title;
            if(modalMessage) modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            const modal = document.getElementById('global-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });
        document.getElementById('global-modal').addEventListener('click', (event) => {
            if (event.target === document.getElementById('global-modal')) {
                const modal = document.getElementById('global-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });

        function showMessage(text, type = 'error', targetId) {
            // Função de compatibilidade - agora usa o sistema de toasts
            // Se targetId for fornecido, tenta usar toast com fallback
            if (targetId) {
                return showToast(text, type, null, 5000, targetId);
            }
            
            // Sem targetId, usa toast diretamente
            return showToast(text, type);
        }

        
        // ===============================================
        // SISTEMA DE TOASTS - NOTIFICAÇÕES MODERNAS
        // ===============================================
        
        let toastCounter = 0;
        
        function showToast(message, type = 'info', title = null, duration = 5000, targetId = null) {
            // Gerar ID único para o toast
            toastCounter++;
            const toastId = `toast-${toastCounter}`;
            
            // Se targetId for fornecido, verificar se elemento existe e está visível
            if (targetId) {
                const targetElement = document.getElementById(targetId);
                if (targetElement && targetElement.offsetParent !== null) {
                    // Elemento existe e está visível - usar sistema antigo
                    if (targetElement) {
                        targetElement.textContent = message;
                        targetElement.classList.remove('text-red-500', 'text-green-500', 'text-blue-500', 'text-yellow-500');
                        if (type === 'error') targetElement.classList.add('text-red-500');
                        if (type === 'success') targetElement.classList.add('text-green-500');
                        if (type === 'info') targetElement.classList.add('text-blue-500');
                        if (type === 'warning') targetElement.classList.add('text-yellow-500');
                        return toastId; // Retorna ID mesmo quando usa sistema antigo
                    }
                }
                // Se elemento não existe ou não está visível, continua para usar toast
            }
            
            // Configurações por tipo
            const toastConfig = {
                success: {
                    icon: 'fa-check-circle',
                    title: title || 'Sucesso',
                    class: 'toast-success'
                },
                error: {
                    icon: 'fa-exclamation-circle',
                    title: title || 'Erro',
                    class: 'toast-error'
                },
                warning: {
                    icon: 'fa-exclamation-triangle',
                    title: title || 'Atenção',
                    class: 'toast-warning'
                },
                info: {
                    icon: 'fa-info-circle',
                    title: title || 'Informação',
                    class: 'toast-info'
                }
            };
            
            const config = toastConfig[type] || toastConfig.info;
            
            // Criar elemento do toast
            const toastElement = document.createElement('div');
            toastElement.id = toastId;
            toastElement.className = `toast ${config.class}`;
            
            toastElement.innerHTML = `
                <div class="toast-header">
                    <div class="toast-title">
                        <i class="fas ${config.icon} toast-icon"></i>
                        ${config.title}
                    </div>
                    <button class="toast-close" onclick="hideToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="toast-message">${message}</div>
                ${duration > 0 ? '<div class="toast-progress"></div>' : ''}
            `;
            
            // Adicionar ao container
            const container = document.getElementById('toast-container');
            if (container) {
                container.appendChild(toastElement);
                
                // Trigger animation
                setTimeout(() => {
                    toastElement.classList.add('show');
                }, 10);
                
                // Auto-remove se duration for especificado
                if (duration > 0) {
                    setTimeout(() => {
                        hideToast(toastId);
                    }, duration);
                }
            }
            
            return toastId;
        }
        
        
        function hideToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                toast.classList.add('hide');
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }
        
        function hideAllToasts() {
            const container = document.getElementById('toast-container');
            if (container) {
                const toasts = container.querySelectorAll('.toast');
                toasts.forEach(toast => {
                    hideToast(toast.id);
                });
            }
        }
        
        // Função de conveniência para substituir showMessage
        function showToastMessage(text, type = 'info', targetId = null) {
            // Se targetId for fornecido, usar o método antigo para compatibilidade
            if (targetId) {
                return showMessage(text, type, targetId);
            }
            
            // Usar o novo sistema de toasts
            return showToast(text, type);
        }
        
        /**
         * Gerencia a navegação com a tecla Enter no formulário de login.
         * @param {KeyboardEvent} event O objeto do evento de teclado.
         */
        function handleEnterKeyNavigation(event) {
            // Se a tecla pressionada não for 'Enter', não faz nada.
            if (event.key !== 'Enter') {
                return;
            }

            // Impede o comportamento padrão do Enter (como submeter um formulário e recarregar a página)
            event.preventDefault();

            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            const empresaSelect = document.getElementById('selectEmpresaLogin');

            // Descobre qual elemento está ativo no momento
            const activeElementId = document.activeElement.id;

            switch (activeElementId) {
                case 'username':
                    // Se estiver no campo de usuário, pula para a senha
                    if (passwordField) {
                        passwordField.focus();
                    }
                    break;

                case 'password':
                    // Se estiver no campo de senha, pula para o seletor de empresa
                    if (empresaSelect) {
                        empresaSelect.focus();
                    }
                    break;

                case 'selectEmpresaLogin':
                    // Se estiver no seletor de empresa, tenta fazer o login
                    // (A função logar() já deve ter as validações internas)
                    logar();
                    break;
            }
        }

        // ===============================================
        // LÓGICA DA TELA DE LOGIN
        // ===============================================
        function setupLoginScreen() {
            console.log("Inicializando listeners da tela de login...");
    
            const loginButton = document.getElementById('loginButton');
            const createAccountButton = document.getElementById('createAccountButton');
            const usernameField = document.getElementById('username');
            const passwordField = document.getElementById('password');
            //const screenLogin = document.getElementById('screen-login');
            //const empresaSelect = document.getElementById('selectEmpresaLogin');
            
            if (loginButton) {
                loginButton.addEventListener('click', logar);
            }
            
            if (createAccountButton) {
                createAccountButton.addEventListener('click', () => showScreen('screen-cadastro'));
            }
            
            if (usernameField) {
                usernameField.addEventListener('blur', carregarEmpresasParaLogin);
                usernameField.addEventListener('keydown', handleEnterKeyNavigation);
            }

            if (passwordField) {
              passwordField.addEventListener('keydown', handleEnterKeyNavigation);
            }

            //if (empresaSelect) {
             // empresaField.addEventListener('keydown', handleEnterKeyNavigation);
           // }
            
            //if (screenLogin) {
              //  screenLogin.addEventListener('keydown', (e) => {
              //      if (e.key === 'Enter') logar();
              //  });
           // }
        }

        /**
         * Reseta o formulário de login para seu estado inicial e limpo.
         * Deve ser chamada toda vez que a tela de login for exibida após um logout.
         */
        function resetarFormularioLogin() {
            console.log("Resetando formulário de login...");

            const usernameInput = document.getElementById('username');
            if (usernameInput) usernameInput.value = '';

            const passwordInput = document.getElementById('password');
            if (passwordInput) passwordInput.value = '';

            const empresaSelect = document.getElementById('selectEmpresaLogin');
            if (empresaSelect) {
                empresaSelect.innerHTML = '<option value="">Primeiro, digite o usuário</option>';
                empresaSelect.disabled = false;
            }

            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.disabled = false;
                loginButton.innerHTML = 'Entrar';
            }
            
            const messageLogin = document.getElementById('message-login');
            if (messageLogin) messageLogin.textContent = '';

            if (usernameInput) usernameInput.focus();
        }

        function carregarEmpresasParaLogin() {
            const username = document.getElementById('username').value.trim();
            const selectEmpresa = document.getElementById('selectEmpresaLogin');
            
            if (!username) {
                selectEmpresa.innerHTML = `<option value="">Primeiro, digite o usuário</option>`;
                return;
            }
            
            selectEmpresa.innerHTML = `<option value="">Carregando empresas...</option>`;
            
            google.script.run
                .withSuccessHandler(response => {
                    if (!selectEmpresa || !response || !response.empresas) {
                        if (selectEmpresa) {
                            selectEmpresa.innerHTML = `<option value="">Nenhuma empresa disponível</option>`;
                        }
                        return;
                    }
                    
                    selectEmpresa.innerHTML = `<option value="">Selecione a empresa</option>`;
                    
                    response.empresas.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.nome;
                        selectEmpresa.appendChild(option);
                    });
                    
                    if (response.defaultEmpresaId) {
                        selectEmpresa.value = response.defaultEmpresaId;
                    } else if (selectEmpresa.options.length > 1) {
                        selectEmpresa.selectedIndex = 1;
                    }
                })
                .withFailureHandler(err => {
                    console.error('Erro ao obter empresas:', err);
                    if (selectEmpresa) {
                        selectEmpresa.innerHTML = `<option value="">Erro ao carregar</option>`;
                    }
                })
                .obterEmpresasDoUsuario(username);
        }

        function logar() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const selectEmpresa = document.getElementById('selectEmpresaLogin');
            const empresaSelecionadaId = selectEmpresa.value;
            const empresaSelecionadaNome = selectEmpresa.options[selectEmpresa.selectedIndex].text;
            const loginButton = document.getElementById('loginButton');

            if (!username || !password || !empresaSelecionadaId) {
                showToast('Preencha usuário, senha e selecione a empresa.', 'warning', 'Campos Obrigatórios');
                return;
            }

            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
            
            google.script.run
                .withSuccessHandler(res => {
                  console.log("Resposta COMPLETA recebida do validarLogin:", res);
                    if (res.status === 'ok' && res.empresa) {
                      if (res.empresa.id) {
                          res.empresa.id = String(res.empresa.id).padStart(3, '0');
                      }
                        localStorage.setItem('nome', res.nome);
                        localStorage.setItem('perfil', res.perfil);
                        localStorage.setItem('usuarioLogado', username);
                        localStorage.setItem('empresaSelecionada', JSON.stringify(res.empresa));
                        localStorage.setItem('funcao', res.funcao);
                        
                        showToast(`Bem-vindo, ${res.nome}!`, 'success', 'Login Realizado');
                        
                        google.script.run
                            .withSuccessHandler(() => {
                                showScreen('screen-main');
                                setupMainScreen();
                            })
                            .registrarLoginUsuario(res.idUsuario, res.nomeUsuario, empresaSelecionadaId, empresaSelecionadaNome);
                    } else {
                        showToast(res.message || 'Usuário, senha ou empresa inválidos!', 'error', 'Falha no Login');
                        loginButton.disabled = false;
                        loginButton.textContent = 'Entrar';
                    }
                })
                .withFailureHandler(err => {
                    showToast('Erro de comunicação. Tente novamente.', 'error', 'Falha na Conexão');
                    loginButton.disabled = false;
                    loginButton.textContent = 'Entrar';
                    console.error("Erro em validarLogin:", err);
                })
                .validarLogin(username, password, empresaSelecionadaId);
        }

        // ===============================================
        // LÓGICA DA TELA DE CADASTRO DE USUÁRIO
        // ===============================================
        function setupCadastroScreen() {
            const registerButton = document.getElementById('registerButton');
            const backButton = document.getElementById('backToLoginButton');
            const nomeCompletoInput = document.getElementById('name');
            const usernameInput = document.getElementById('username-cadastro');
            
            if (registerButton) {
                registerButton.addEventListener('click', cadastrarUsuario);
            }
            
            if (backButton) {
                backButton.addEventListener('click', () => showScreen('screen-login'));
            }
            
            if (nomeCompletoInput && usernameInput) {
                nomeCompletoInput.addEventListener('input', function() {
                    const nomeDigitado = this.value;
                    const nomes = nomeDigitado.trim().toLowerCase().split(' ');
                    const primeiro = nomes[0];
                    const ultimo = nomes.length > 1 ? nomes[nomes.length - 1] : '';
                    let usernameSugerido = ultimo ? `${primeiro}.${ultimo}` : primeiro;
                    usernameSugerido = usernameSugerido.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9.]/g, '');
                    usernameInput.value = usernameSugerido;
                });
            }
        }

        function cadastrarUsuario() {
            const nome = document.getElementById('name').value.trim();
            const usuario = document.getElementById('username-cadastro').value.trim();
            const senha = document.getElementById('password-cadastro').value.trim();
            const registerButton = document.getElementById('registerButton');

            if (!nome || !usuario || !senha) {
                showToast('Preencha todos os campos!', 'error', 'message-cadastro');
                return;
            }
            if (senha.length < 6) {
                showToast('A senha deve ter no mínimo 6 caracteres.', 'error', 'message-cadastro');
                return;
            }

            registerButton.disabled = true;
            registerButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cadastrando...';

            google.script.run
                .withSuccessHandler(res => {
                    if (res.status === 'ok') {
                        showGlobalModal('Sucesso!', res.message || 'Solicitação enviada. Aguarde aprovação.');
                        showScreen('screen-login');
                    } else {
                        showToast(res.message, 'error', 'message-cadastro');
                    }
                    registerButton.disabled = false;
                    registerButton.textContent = 'Solicitar Cadastro';
                })
                .withFailureHandler(err => {
                    showToast('Erro de comunicação.', 'error', 'message-cadastro');
                    registerButton.disabled = false;
                    registerButton.textContent = 'Solicitar Cadastro';
                    console.error("Erro em criarUsuario:", err);
                })
                .criarUsuario(nome, usuario, senha, '', 'usuario');
        }

        // ===============================================
        // LÓGICA DA TELA PRINCIPAL E MENU
        // ===============================================
        function setupMainScreen() {
            const nome = localStorage.getItem("nome") || "Usuário";
            const perfil = (localStorage.getItem("perfil") || "").toLowerCase();
            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');

            document.getElementById('nome').textContent = nome;
            document.getElementById('perfil').textContent = perfil;
            document.getElementById('empresaInfo').textContent = empresaAtual.nome || empresaAtual.empresa || "N/A";
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            loadPageContent('Menu', setupMenuScreen);
        }
        
        function logout() {
            // Limpar todos os dados do localStorage
            localStorage.clear();
            showScreen('screen-login');
            resetarFormularioLogin();
        }
        
        
        // Variavel Global 
        let AppCache = {
            userCompanies: []
        };

        // Função para buscar e salvar a lista de empresas
        function loadUserCompanies() {
            return new Promise((resolve, reject) => {
                const usuarioLogado = localStorage.getItem('usuarioLogado');
                google.script.run
                    .withSuccessHandler(response => {
                        if (response && response.empresas) {
                            AppCache.userCompanies = response.empresas; // Salva a lista de empresas
                            console.log('Cache de empresas carregado:', AppCache.userCompanies);
                            resolve();
                        } else {
                            reject('Resposta inválida ao buscar empresas.');
                        }
                    })
                    .withFailureHandler(reject)
                    .obterEmpresasDoUsuario(usuarioLogado);
            });
        } 


        async function setupMenuScreen() {
          try {
              // 1. PRIMEIRO, carrega a lista de empresas e espera terminar
              await loadUserCompanies();
            const perfil = (localStorage.getItem("perfil") || "").toLowerCase();
            const approvalCardContainer = document.getElementById('approval-card-wrapper');
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
            
            if (perfil === 'admin'){
              // Se for Admin, mostra o card e carrega os dados
              if (approvalCardContainer) approvalCardContainer.style.display = 'block';
              loadApprovalQueue();
            } else {
              // Se NÃO for Admin, esconde completamente o card de aprovações
              if (approvalCardContainer) approvalCardContainer.style.display = 'none';
            }

            const switcherSelect = document.getElementById('selectEmpresa');
            google.script.run
                .withSuccessHandler(response => {
                    if (!switcherSelect || !response || !Array.isArray(response.empresas)) return;
                    switcherSelect.innerHTML = '';
                    response.empresas.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.nome;
                        switcherSelect.appendChild(option);
                    });
                    if (empresaAtual.id) {
                        switcherSelect.value = empresaAtual.id;
                    }
                })
                .obterEmpresasDoUsuario(usuarioLogado);
            
            document.getElementById('btnSelecionarEmpresa').addEventListener('click', () => {
                const novaEmpresaId = switcherSelect.value;
                showGlobalModal('Atenção', 'Trocando de empresa...', 'info');
                google.script.run
                    .withSuccessHandler(novaEmpresaObjeto => {
                        if (novaEmpresaObjeto) {
                            localStorage.setItem('empresaSelecionada', JSON.stringify(novaEmpresaObjeto));
                            setupMainScreen();
                            document.getElementById('global-modal').classList.add('hidden');
                        }
                    })
                    ._getEmpresaDataById(novaEmpresaId);
            });

            const menuOptionsGroup = document.getElementById('menuOptionsGroup');
            menuOptionsGroup.innerHTML = '';

            createMenuButton('Novo Pedido', () => {
                // Limpar dados de visualização antes de criar novo pedido
                localStorage.removeItem('modoVisualizacao');
                localStorage.removeItem('origemVisualizacao');
                localStorage.removeItem('pedidoParaVisualizar');
                localStorage.removeItem('empresaOriginalAdmin');
                localStorage.removeItem('numeroPedidoVisualizacao');
                console.log('🔧 Variáveis de visualização limpas para novo pedido');
                loadPageContent('Pedido', setupPedidoScreen);
            }, menuOptionsGroup);
            createMenuButton('Meus Pedidos Aprovados', () => loadPageContent('MeusPedidos', setupMeusPedidosScreen), menuOptionsGroup);
            createMenuButton('Gerenciar Rascunhos', () => loadPageContent('GerenciarRascunhos', setupGerenciarRascunhosScreen), menuOptionsGroup);
            createMenuButton('Cadastro de Fornecedores', () => loadPageContent('CadastroFornecedor', setupCadastroFornecedorScreen), menuOptionsGroup);
            createMenuButton('Buscar Pedido', () => loadPageContent('BuscarPedido', setupBuscaScreen), menuOptionsGroup);
            createMenuButton('Trocar Senha', () => loadPageContent('TrocarSenha', setupTrocarSenhaScreen), menuOptionsGroup);
                        
            if (perfil === "admin") {
                createMenuButton('Dashboard Completo', () => loadPageContent('Dashboard', setupDashboardScreen), menuOptionsGroup);
                createMenuButton('Relatórios', () => loadPageContent('Relatorios', setupRelatoriosScreen), menuOptionsGroup);
                createMenuButton('Gerenciar Usuários', () => loadPageContent('GerenciarUsuarios', setupGerenciarUsuariosScreen), menuOptionsGroup);
                createMenuButton('Gerenciar Fornecedores', () => loadPageContent('GerenciarFornecedores', setupGerenciarFornecedoresScreen), menuOptionsGroup);
            }
            
            loadAdminDashboardCards();
            loadNoticeBoard();
             
        function createMenuButton(text, onClick, container) {
            const button = document.createElement('button');
            button.className = 'w-full text-left px-4 py-3 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-blue-300 transition-colors duration-200 flex items-center justify-between group';
            button.innerHTML = `
                <span class="text-gray-700 group-hover:text-blue-600 font-medium">${text}</span>
                <i class="fas fa-chevron-right text-gray-400 group-hover:text-blue-600"></i>
            `;
            button.addEventListener('click', onClick);
            container.appendChild(button)
        }

        // --- ERRO 2 CORRIGIDO AQUI ---
          } catch (error) { // <-- ADICIONADO O BLOCO 'catch' QUE FALTAVA
              console.error("Erro fatal durante o setup do menu:", error);
              showGlobalModal("Erro Crítico", "Ocorreu um erro ao carregar o menu principal. Por favor, recarregue a página.");
        } 
}
        // ===============================================
        // NOVAS FUNÇÕES PARA CARREGAR OS CARDS
        // ===============================================

        function loadApprovalQueue() {
           const container = document.getElementById('approval-queue-container');
    if (!container) return;
    container.innerHTML = '<p class="text-sm text-gray-500">A carregar aprovações...</p>';

    google.script.run
        .withSuccessHandler(approvals => {
            if (!approvals || approvals.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Nenhuma aprovação pendente no momento. ✨</p>';
                return;
            }

            let html = '';
            approvals.forEach(pedido => {
                const numeroPedido = pedido.numeroDoPedido || 'N/D';
                const empresaId = pedido.empresaId || '';
                
                // A busca que já confirmamos que funciona:
                const empresaObj = AppCache.userCompanies.find(c => String(c.id).trim() == String(empresaId).trim());
                
                // Usamos o resultado da busca para definir o nome
                const empresaNome = empresaObj ? empresaObj.nome : 'Empresa não identificada';

                const valorFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(pedido.totalGeral || 0);

                // =========================================================
                // HTML FINAL E CORRIGIDO
                // =========================================================
                html += `
                    <div id="approval-card-${numeroPedido}" class="flex-shrink-0 min-w-[300px] p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg">
                        <div class="flex justify-between items-start mb-1">
                            <p class="font-bold text-gray-800 truncate">Pedido #${numeroPedido}</p>
                            <span class="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full truncate" title="${empresaNome}">${empresaNome}</span>
                        </div>
                        <p class="text-sm text-gray-600 truncate mb-2">Fornecedor: ${pedido.fornecedor}</p>
                        <p class="text-lg font-bold text-yellow-800 mt-1">${valorFormatado}</p>
                        <div class="flex space-x-2 mt-3">
                            <button onclick="visualizarPedidoExistente('${numeroPedido}', '${empresaId}', '${empresaNome}')" class="w-full py-1 text-xs bg-gray-500 text-white rounded-md hover:bg-gray-600">Visualizar</button>
                            <button onclick="processarAprovacao('${numeroPedido}', 'Rejeitado')" class="w-full py-1 text-xs bg-red-500 text-white rounded-md hover:bg-red-600">Rejeitar</button>
                            <button onclick="processarAprovacao('${numeroPedido}', 'Aprovado')" class="w-full py-1 text-xs bg-green-500 text-white rounded-md hover:bg-green-600">Aprovar</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        })
        .getPendingApprovals();
}

        // ===============================================
        // NOVAS FUNÇÕES DO CARD DE APROVAÇÃO
        // ===============================================
        /**
           * Processa a aprovação ou rejeição de um pedido.
           * @param {string} numeroPedido O número do pedido a ser processado.
           * @param {string} novoStatus O novo status ("Aprovado" ou "Rejeitado").
           */
          function processarAprovacao(numeroPedido, novoStatus) {
              const cardElement = document.getElementById(`approval-card-${numeroPedido}`);
              if (!cardElement) return;

              // 1. Fornece feedback visual imediato para o usuário
              const buttons = cardElement.querySelectorAll('button');
              buttons.forEach(button => button.disabled = true);
              cardElement.style.opacity = '0.5';

              console.log(`Processando pedido #${numeroPedido} para o status: ${novoStatus}...`);

              // 2. Chama a função do backend
              google.script.run
                  .withSuccessHandler(response => {
                      if (response.status === 'success') {
                          console.log(response.message);
                          // Animação de remoção suave e depois remove o elemento
                          cardElement.style.transition = 'transform 0.5s, opacity 0.5s';
                          cardElement.style.transform = 'scale(0.9)';
                          cardElement.style.opacity = '0';
                          setTimeout(() => {
                              cardElement.remove();
                              // Verifica se ainda há cards pendentes
                              const container = document.getElementById('approval-queue-container');
                              if (container && container.children.length === 0) {
                                  container.innerHTML = '<p class="text-sm text-gray-500">Nenhuma aprovação pendente no momento. ✨</p>';
                              }
                          }, 500); // Espera a animação terminar

                          showToast(response.message, 'success'); // Supondo que você tenha uma função de notificação
                      } else {
                          // Em caso de erro vindo do backend, reverte o estado visual
                          console.error("Erro do backend:", response.message);
                          showGlobalModal("Erro", response.message);
                          buttons.forEach(button => button.disabled = false);
                          cardElement.style.opacity = '1';
                      }
                  })
                  .withFailureHandler(error => {
                      // Em caso de falha na comunicação, reverte o estado visual
                      console.error("Falha na comunicação:", error);
                      showGlobalModal("Erro de Comunicação", "Não foi possível processar a solicitação. Tente novamente.");
                      buttons.forEach(button => button.disabled = false);
                      cardElement.style.opacity = '1';
                  })
                  .atualizarStatusPedido(numeroPedido, novoStatus);
          }

        function loadNoticeBoard() {
            const container = document.getElementById('notice-board-content');
            if (!container) return;
            container.innerHTML = '<p class="text-sm text-gray-500">A carregar avisos...</p>';

            google.script.run
                .withSuccessHandler(notices => {
                    if (!notices || notices.length === 0) {
                        container.innerHTML = '<p class="text-sm text-gray-500">Nenhum aviso no momento.</p>';
                        return;
                    }

                    let html = '';
                    notices.forEach((notice, index) => {
                        html += `<p><strong>${notice.data}:</strong> ${notice.mensagem}</p>`;
                        if (index < notices.length - 1) {
                            html += '<hr>';
                        }
                    });
                    container.innerHTML = html;
                })
                .getNotices(); 
        }

        function loadAdminDashboardCards() {
      const perfil = (localStorage.getItem("perfil") || "").toLowerCase();
      const contentArea = document.getElementById('dashboard-content-area');
      if (!contentArea) {
          console.error("ERRO: 'dashboard-content-area' não foi encontrado.");
          return;
      }

    // Lógica para USUÁRIO NORMAL
    if (perfil !== 'admin') {
        const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
        const idDaEmpresa = empresaAtual.id || empresaAtual.codigo;
        
        contentArea.innerHTML = `<div class="text-center py-10 text-gray-500"><div class="spinner mx-auto"></div><p class="mt-4">Carregando seus últimos pedidos...</p></div>`;

        google.script.run
            .withSuccessHandler(response => {
                if (response.status === 'success' && response.data.length > 0) {
                    const pedidosOrdenados = response.data.sort((a, b) => new Date((b.dataCriacao || b.data).replace(' ', 'T')) - new Date((a.dataCriacao || a.data).replace(' ', 'T')));
                    console.log("🚨 Pedidos ordenados:", pedidosOrdenados.map(p => ({
                      id: p.id,
                      data: (p.dataCriacao || p.data),
                      dataFormatada: new Date((p.dataCriacao || p.data).replace(' ', 'T'))
                    })));
                    const ultimosPedidos = pedidosOrdenados.slice(0, 2); 

                    let cardsHtml = '';
                    ultimosPedidos.forEach((pedido, index) => {
                        cardsHtml += createOrderCardHTML(pedido, empresaAtual, index === 0);
                    });

                    contentArea.innerHTML = `
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div class="p-5 border-b border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800">Seus Últimos Pedidos - ${empresaAtual.nome}</h3>
                            </div>
                            <div class="p-5">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">${cardsHtml}</div>
                            </div>
                            <div class="px-5 py-4 bg-gray-50 text-center">
                                <button class="text-sm font-medium text-blue-600 hover:text-blue-800">Ver todos os pedidos</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Card para quando não há pedidos
                    contentArea.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                           <div class="bg-gray-100 rounded-full h-16 w-16 flex items-center justify-center mx-auto mb-4"><i class="fas fa-inbox text-gray-400 text-xl"></i></div>
                           <p class="text-gray-500 text-lg mb-2">Nenhum pedido encontrado</p>
                           <p class="text-gray-400 text-sm">Você ainda não criou nenhum pedido para esta empresa.</p>
                           <button onclick="loadPageContent(templates.Pedido, setupPedidoScreen)" class="mt-4 px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200"><i class="fas fa-plus mr-2"></i>Criar Primeiro Pedido</button>
                        </div>`;
                }
            })
            .withFailureHandler(err => {
                contentArea.innerHTML = `<p class="text-red-500">Erro ao carregar pedidos.</p>`;
                console.error("Erro ao buscar pedidos do usuário:", err);
            })
            .buscarPedidosv2(params);
        return;
    }
    
    // Lógica para ADMINISTRADOR
    const usuarioLogado = localStorage.getItem('usuarioLogado');
    contentArea.innerHTML = `<div class="text-center py-10 text-gray-500"><div class="spinner mx-auto"></div><p class="mt-4">Carregando resumos das empresas...</p></div>`;
    
    google.script.run
        .withSuccessHandler(dadosCompletos => {
            if (!dadosCompletos || !dadosCompletos.empresas || dadosCompletos.empresas.length === 0) {
                contentArea.innerHTML = '<p>Nenhuma empresa encontrada.</p>';
                return;
            }
            
            contentArea.innerHTML = ''; // Limpa o "carregando"
            const gridContainer = document.createElement('div');
            gridContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';
            contentArea.appendChild(gridContainer);

            dadosCompletos.empresas.forEach(empresaAtual => {
                const cardEmpresa = document.createElement('div');
                cardEmpresa.className = 'bg-white rounded-xl shadow-lg overflow-hidden transition-shadow hover:shadow-xl flex flex-col';
                cardEmpresa.innerHTML = `
                    <div class="p-5 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-bold text-gray-800">${empresaAtual.nome}</h4>
                            <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded-full">Ativa</span>
                        </div>
                    </div>
                    <div id="card-content-${empresaAtual.id}" class="p-5 space-y-4 flex-grow">
                        <div class="spinner-small mx-auto"></div> </div>
                     
                `;
                gridContainer.appendChild(cardEmpresa);
                
                // Buscar os últimos 2 pedidos desta empresa
                const params = { empresaId: empresaAtual.id };
                google.script.run
                    .withSuccessHandler(responsePedidos => {
                      console.log(`--- RELATÓRIO DE DIAGNÓSTICO (Empresa ${empresaAtual.id}) ---`, responsePedidos);
                        
                        const elementoCard = document.getElementById(`card-content-${empresaAtual.id}`);
                        if (responsePedidos && responsePedidos.status === 'success' && responsePedidos.data.length > 0) {
                            const pedidosOrdenados = responsePedidos.data.sort((a, b) => new Date((b.dataCriacao || b.data).replace(' ', 'T')) - new Date((a.dataCriacao || a.data).replace(' ', 'T')));
                            console.log("🚨 Pedidos ordenados:", pedidosOrdenados.map(p => ({
                              id: p.id,
                              data: (p.dataCriacao || p.data),
                              dataFormatada: new Date((p.dataCriacao || p.data).replace(' ', 'T'))
                            })));
                            const ultimosDoisPedidos = pedidosOrdenados.slice(0, 2);
                            
                            let cardsHtml = '';
                            ultimosDoisPedidos.forEach((pedido, index) => {
                                cardsHtml += createOrderCardHTML(pedido, empresaAtual, index === 0);
                            });
                            elementoCard.innerHTML = cardsHtml;
                        } else {
                            elementoCard.innerHTML = '<p class="text-sm text-gray-500 text-center italic">Nenhum pedido encontrado para esta empresa.</p>';
                        }
                    })
                    .buscarPedidosv2(params);
            });
        })
        .obterEmpresasDoUsuario(usuarioLogado);
}


// =================================================================
// NOVA FUNÇÃO AUXILIAR PARA CRIAR CARDS DE PEDIDOS
// =================================================================
function createOrderCardHTML(pedido, empresa, isRecente = false) {
    const numeroPedido = pedido.numeroDoPedido || 'N/D';
    const valorTotal = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(pedido.totalGeral || 0);
    const dataFormatada = new Date((pedido.dataCriacao || pedido.data).replace(' ', 'T')).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    const tagLabel = isRecente ? 'Mais Recente' : 'Anterior';
    const tagBgColor = isRecente ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';

    return `
        <div class="border border-gray-200 rounded-lg p-4 space-y-3">
            <div class="flex justify-between items-start">
                <p class="font-bold text-gray-800">Pedido ${numeroPedido}</p>
                <span class="text-xs font-semibold px-2.5 py-1 rounded-full ${tagBgColor}">${tagLabel}</span>
            </div>
            <div class="text-sm space-y-1">
                <p><i class="fas fa-truck fa-fw text-gray-400 mr-2"></i>${pedido.fornecedor}</p>
                <p><i class="fas fa-calendar-alt fa-fw text-gray-400 mr-2"></i>${dataFormatada}</p>
                <p><i class="fas fa-info-circle fa-fw text-gray-400 mr-2"></i>Estado: <span class="font-semibold">${pedido.estado || 'N/A'}</span></p>
                <p><i class="fas fa-money-bill-wave fa-fw text-gray-400 mr-2"></i><span class="font-semibold">${valorTotal}</span></p>
            </div>
            <div class="flex gap-2 pt-3 border-t border-gray-200">
                <button onclick="visualizarPedidoExistente('${numeroPedido}', '${empresa.id}', '${empresa.nome}')" class="flex-1 text-xs px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">
                    Visualizar
                </button>
                <button onclick="iniciarImpressao('${numeroPedido}', '${empresa.id}')" class="flex-1 text-xs px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md transition-colors">
                    <i class="fas fa-print mr-1"></i> Imprimir
                </button>
            </div>
        </div>
    `;
  }
        
        
        
        // ===============================================
        // FUNÇÕES ESPECÍFICAS PARA ADMIN NO DASHBOARD
        // ===============================================

        function abrirImpressaoPedidoAdmin(numeroPedido, empresaId, nomeEmpresa) {
              if (!numeroPedido || !empresaId) {
                  showGlobalModal('Erro', 'Dados incompletos para abrir o pedido.');
                  return;
              }
              
              console.log(`Admin abrindo pedido ${numeroPedido} da empresa ${nomeEmpresa} (ID: ${empresaId})`);
              showToast('Aguarde', `Preparando impressão do pedido ${numeroPedido} da empresa ${nomeEmpresa}...`, 'info');

              google.script.run
                  .withSuccessHandler(function(pedidoData) {
                      if (!pedidoData) {
                          showGlobalModal('Erro', 'Dados do pedido não encontrados para impressão.');
                          return;
                      }
                      
                      // Salvar temporariamente os dados da empresa para impressão
                      const empresaTemp = {
                          id: empresaId,
                          nome: nomeEmpresa
                      };
                      
                      abrirJanelaImpressaoAdmin(pedidoData, empresaTemp);
                  })
                  .withFailureHandler(err => {
                      showGlobalModal('Erro', `Não foi possível carregar os dados do pedido: ${err.message}`);
                      console.error("Erro ao buscar pedido admin:", err);
                  })
                  .getDadosPedidoParaImpressaoAdmin(numeroPedido, empresaId); // Nova função que aceita empresa
          }

          function imprimirPedidoAdmin(numeroPedido, empresaId, nomeEmpresa) {
              // Mesma lógica que abrirImpressaoPedidoAdmin
              abrirImpressaoPedidoAdmin(numeroPedido, empresaId, nomeEmpresa);
          }

          function abrirJanelaImpressaoAdmin(pedidoData, empresaTemp) {
              document.getElementById('global-modal').classList.add('hidden');

              const pageHtml = getPageTemplate('PedidoImpressao');
              const printWindow = window.open('', '_blank');
              
              if (!printWindow) {
                  showGlobalModal("Pop-up bloqueado!", "Por favor, permita pop-ups para este site para poder imprimir o pedido.");
                  return;
              }

              printWindow.document.write(pageHtml);
              printWindow.document.close();

              printWindow.onload = function() {
                  const doc = printWindow.document;
                  doc.title = `Pedido de Compra - ${pedidoData.numeroDoPedido}`;
                  
                  // Para admin, usar os dados da empresa passados como parâmetro
                  doc.getElementById('empresaNomePrint').textContent = empresaTemp.nome || '';
                  doc.getElementById('empresaEnderecoPrint').textContent = pedidoData.enderecoEmpresa || '';
                  doc.getElementById('empresaCidadeUfPrint').textContent = pedidoData.cidadeUfEmpresa || '';
                  doc.getElementById('empresaCnpjPrint').textContent = pedidoData.cnpjEmpresa || '';
                  doc.getElementById('empresaEmailPrint').textContent = `Email: ${pedidoData.emailEmpresa || ''}`;
                  doc.getElementById('empresaTelefonePrint').textContent = `Telefone: ${pedidoData.telefoneEmpresa || ''}`;

                  doc.getElementById('numeroPedidoPrint').textContent = pedidoData.numeroDoPedido || '';
                  
                  const dataPedidoObj = new Date(pedidoData.data + 'T12:00:00');
                  const formattedDate = dataPedidoObj.toLocaleDateString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                  const now = new Date();
                  const formattedTime = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                  doc.getElementById('dataEmissaoPrint').textContent = `${formattedDate} ${formattedTime}`;

                  doc.getElementById('fornecedorPrint').textContent = pedidoData.fornecedor || '';
                  doc.getElementById('enderecoFornecedorPrint').textContent = pedidoData.enderecoFornecedor || '';
                  doc.getElementById('formaPagamentoPrint').textContent = pedidoData.formaPagamentoFornecedor || '';
                  doc.getElementById('cnpjFornecedorPrint').textContent = pedidoData.cnpjFornecedor || '';
                  doc.getElementById('condicaoPagamentoPrint').textContent = pedidoData.condicaoPagamentoFornecedor || '';
                  
                  doc.getElementById('placaVeiculoPrint').textContent = pedidoData.placaVeiculo || 'N/A';
                  doc.getElementById('nomeVeiculoPrint').textContent = pedidoData.nomeVeiculo || 'N/A';
                  
                  doc.getElementById('totalGeralPrint').textContent = `R$ ${parseFloat(pedidoData.totalGeral || 0).toFixed(2).replace('.', ',')}`;
                  doc.getElementById('observacoesPedidoPrint').textContent = pedidoData.observacoes || 'Sem observações.';

                  const printItemsTableBody = doc.getElementById('printItemsTableBody');
                  printItemsTableBody.innerHTML = '';
                  if (pedidoData.itens && Array.isArray(pedidoData.itens)) {
                      pedidoData.itens.forEach((item, index) => {
                          const row = printItemsTableBody.insertRow();
                          row.insertCell(0).textContent = index + 1;
                          row.insertCell(1).textContent = item.descricao;
                          row.insertCell(2).textContent = item.unidade || '';
                          row.insertCell(3).textContent = item.quantidade;
                          row.insertCell(4).textContent = `R$ ${parseFloat(item.precoUnitario || 0).toFixed(2).replace('.', ',')}`;
                          row.insertCell(5).textContent = `R$ ${parseFloat(item.totalItem || 0).toFixed(2).replace('.', ',')}`;
                      });
                  }
                  
                  const nomeUsuario = localStorage.getItem('nome') || 'Usuário Desconhecido';
                  const perfilUsuario = localStorage.getItem('perfil') || 'Sem Função';
                  doc.getElementById('usuarioLogadoPrint').textContent = nomeUsuario.toUpperCase();
                  doc.getElementById('funcaoUsuarioLogadoPrint').textContent = perfilUsuario.toUpperCase();
                };
          }

        // ===============================================
        // VISUALIZAR PEDIDO USANDO TELA EXISTENTE
        // ===============================================

        function visualizarPedidoExistente(numeroPedido, empresaId, nomeEmpresa, origem = 'menu-principal') {
            console.log(`🔍 Visualizando pedido: ${numeroPedido} a partir de ${origem}`);
    
            localStorage.setItem('modoVisualizacao', 'true');
            localStorage.setItem('origemVisualizacao', origem); 
            localStorage.setItem('numeroPedidoVisualizacao', numeroPedido);
            
            const params = { empresaId: empresaId, mainSearch: numeroPedido };

            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success' && response.data.length > 0) {
                        const pedidoEncontrado = response.data[0];
                        if (pedidoEncontrado) {
                            localStorage.setItem('pedidoParaVisualizar', JSON.stringify(pedidoEncontrado));
                            loadPageContent('Pedido', setupPedidoScreen);
                        } else {
                            showGlobalModal("Erro", `Pedido ${numeroPedido} não encontrado.`);
                        }
                    } else {
                        showGlobalModal("Erro", "Pedido não encontrado ou falha na busca.");
                    }
                })
                .withFailureHandler(error => {
                    showGlobalModal("Erro", "Erro ao carregar pedido: " + error.message);
                })
                .buscarPedidosv2(params);
        }

        // Função específica para visualização no dashboard admin
        function visualizarPedidoAdmin(numeroPedido, empresaId, nomeEmpresa) {
            console.log(`🔍 Admin visualizando pedido: ${numeroPedido} da empresa ${nomeEmpresa}`);
            
            // Definir que veio do dashboard admin
            localStorage.setItem('modoVisualizacao', 'true');
            localStorage.setItem('origemVisualizacao', 'dashboard-admin');
            localStorage.setItem('numeroPedidoVisualizacao', numeroPedido);
            localStorage.setItem('empresaOriginalAdmin', JSON.stringify({
                id: empresaId,
                nome: nomeEmpresa
            }));
            
            // PRIMEIRO: Buscar dados do pedido
            console.log('🔍 Buscando dados do pedido antes de carregar a tela...');
            google.script.run
                .withSuccessHandler(async (response) => {
                    if (response.status === 'success' && response.data.length > 0) {
                        console.log("📄 Dados do pedido recebidos (Admin):", response.data);
                        
                        // Encontrar o pedido específico
                        let pedidoEncontrado = response.data.find(p => p.numeroDoPedido == numeroPedido);
                        
                        if (!pedidoEncontrado) {
                            // Tentar com string
                            pedidoEncontrado = response.data.find(p => String(p.numeroDoPedido) === String(numeroPedido));
                        }
                        
                        if (!pedidoEncontrado) {
                            // Tentar com padding
                            const numeroComZeros = numeroPedido.padStart(4, '0');
                            pedidoEncontrado = response.data.find(p => 
                                String(p.numeroDoPedido).padStart(4, '0') === numeroComZeros
                            );
                        }
                        
                        if (pedidoEncontrado) {
                            console.log("✅ Pedido encontrado (Admin):", pedidoEncontrado);
                            console.log("🔍 DEBUG - Campo estadoFornecedor:", pedidoEncontrado.estadoFornecedor);
                            console.log("🔍 DEBUG - Todos os campos do pedido:", Object.keys(pedidoEncontrado));
                            
                            // Salvar dados do pedido no localStorage ANTES de carregar a tela
                            localStorage.setItem('pedidoParaVisualizar', JSON.stringify(pedidoEncontrado));
                            console.log('✅ Dados salvos no localStorage');
                            
                            // AGORA carregar a tela de pedido
                            loadPageContent('Pedido', setupPedidoScreen);
                            
                        } else {
                            console.error("❌ Pedido não encontrado (Admin)");
                            showGlobalModal("Erro", `Pedido ${numeroPedido} não encontrado.`);
                        }
                        
                    } else {
                        showGlobalModal("Erro", "Pedido não encontrado");
                    }
                })
                .withFailureHandler((error) => {
                    console.error("❌ Erro ao buscar pedido (Admin):", error);
                    showGlobalModal("Erro", "Erro ao carregar pedido: " + error.message);
                })
                .buscarPedidosv2(numeroPedido, empresaId);
        }

        function preencherTelaPedidoExistente() {
           console.log("=== INICIANDO PREENCHIMENTO DA TELA (AGORA COM SEGURANÇA) ===");
              const pedidoDataString = localStorage.getItem('pedidoParaVisualizar');
               console.log("Dados brutos do localStorage:", pedidoDataString);
              if (!pedidoDataString) {
                  showGlobalModal('Erro', 'Dados do pedido não encontrados para visualização.');
                  return;
              }
              const pedidoData = JSON.parse(pedidoDataString);

              // Preenche campos simples
              if(document.getElementById('numeroPedido')) document.getElementById('numeroPedido').value = pedidoData.numeroDoPedido;
              
              // --- CORREÇÃO DA DATA ---
              const dataInput = document.getElementById('dataPedido');
              if(dataInput && pedidoData.data) {
                  try {
                      const dateString = String(pedidoData.data).replace(' ', 'T');
                      const dateObj = new Date(dateString);

                      if (isNaN(dateObj.getTime())) {
                          console.error("Erro: A data recebida é inválida:", pedidoData.data);
                          dataInput.value = '';
                      } else {
                          // Formata a data para YYYY-MM-DD
                          const ano = dateObj.getFullYear();
                          const mes = String(dateObj.getMonth() + 1).padStart(2, '0');
                          const dia = String(dateObj.getDate()).padStart(2, '0');
                          dataInput.value = `${ano}-${mes}-${dia}`;
                      }
                  } catch(e) { 
                      console.error("Erro ao formatar data:", e);
                      dataInput.value = '';
                  }
              }
              
              if(document.getElementById('placaVeiculo')) {
              document.getElementById('placaVeiculo').value = pedidoData.placa || pedidoData.placaVeiculo || '';
              }
              if(document.getElementById('nomeVeiculo')) {
                document.getElementById('nomeVeiculo').value = pedidoData.veiculo || pedidoData.nomeVeiculo || '';
              }
              if(document.getElementById('observacoesPedido')) document.getElementById('observacoesPedido').value = pedidoData.observacoes || '';

              // Seleciona Fornecedor
              const fornecedorSelect = document.getElementById('fornecedorPedido');
              if (fornecedorSelect && pedidoData.fornecedor) {
                  const nomeFornecedor = pedidoData.fornecedor;
                  const option = Array.from(fornecedorSelect.options).find(opt => opt.text === nomeFornecedor);
                  if (option) {
                      fornecedorSelect.value = option.value;
                      fornecedorSelect.dispatchEvent(new Event('change'));
                  }
              }
              
              // Seleciona Veículo
              const veiculoSelect = document.getElementById('nomeVeiculo');
              if (veiculoSelect && pedidoData.nomeVeiculo) {
                  veiculoSelect.value = pedidoData.nomeVeiculo;
              }
  
              // Preenche Itens
              if (pedidoData.itens) {
                  const itens = pedidoData.itens || [];
                  console.log("Objeto do pedido após o parse:", pedidoData);
                  if (typeof preencherItensContainer === 'function') preencherItensContainer(itens);
              }
              
              if (typeof atualizarTotaisDoPedido === 'function') atualizarTotaisDoPedido();

              // Configura a tela para o modo de apenas leitura
              setupModoVisualizacao();
          }

function processarPreenchimentoTela(pedidoData, empresaOriginal) {
    try {
        console.log('Verificando se elementos existem...');
        
        // Verificar se elementos principais existem
        const elementos = {
            numeroPedido: document.getElementById('numeroPedido'),
            dataPedido: document.getElementById('dataPedido'),
            fornecedorPedido: document.getElementById('fornecedorPedido'),
            form: document.querySelector('.max-w-7xl.mx-auto') || document.querySelector('main') || document.querySelector('body')
        };
        
        console.log('Elementos encontrados:', Object.keys(elementos).map(key => 
            `${key}: ${elementos[key] ? '✅' : '❌'}`
        ));
        
        // Verificar se pelo menos o formulário e o campo de número existem
        if (!elementos.form) {
            console.error('❌ Formulário não encontrado, tentando novamente...');
            setTimeout(() => {
                processarPreenchimentoTela(pedidoData, empresaOriginal);
            }, 1000);
            return;
        }
        
        if (!elementos.numeroPedido) {
            console.error('❌ Campo numeroPedido não encontrado, tentando novamente...');
            setTimeout(() => {
                processarPreenchimentoTela(pedidoData, empresaOriginal);
            }, 1000);
            return;
        }
        
        console.log('✅ Elementos principais encontrados, iniciando preenchimento...');
        
        // Preencher campos
        preencherCamposPedido(pedidoData);
        
        // Aguardar mais um pouco antes de desabilitar e adicionar botões
        setTimeout(() => {
            finalizarPreenchimento(pedidoData, empresaOriginal);
        }, 800);
        
    } catch (error) {
        console.error("❌ Erro no processamento:", error);
        showGlobalModal('Erro', 'Erro ao processar dados na tela.');
    }
}

function finalizarPreenchimento(pedidoData, empresaOriginal) {
    try {
        desabilitarEdicaoPedido();
        
        // Verificar origem antes de adicionar botões
        const origemVisualizacao = localStorage.getItem('origemVisualizacao');
        console.log('🔧 finalizarPreenchimento - origemVisualizacao:', origemVisualizacao);
        console.log('🔧 finalizarPreenchimento - empresaOriginal:', empresaOriginal);
        
        if (origemVisualizacao === 'dashboard-admin' && empresaOriginal) {
            console.log('🔧 Adicionando botões do dashboard admin');
            adicionarBotaoVoltarDashboard(empresaOriginal);
            // Também aplicar modo visualização para desabilitar campos
            setupModoVisualizacao();
        } else if (origemVisualizacao === 'menu-usuario') {
            console.log('🔧 Adicionando botões do menu usuário via finalizarPreenchimento');
            setupModoVisualizacao();
        } else {
            console.log('🔧 Origem não identificada ou sem botões a adicionar');
        }
        
        
        
        showToast(`Pedido ${pedidoData.numeroDoPedido} carregado com sucesso!`, 'success', 'Sucesso');
        
        console.log('✅ Preenchimento concluído com sucesso');
        
        // Garantir que os campos sejam desabilitados após o preenchimento completo
        setTimeout(() => {
            console.log('🔒 Garantindo desabilitação final dos campos...');
            
            // Usar seletor mais direto
            const inputs = document.querySelectorAll('input');
            const selects = document.querySelectorAll('select');
            const textareas = document.querySelectorAll('textarea');
            const buttons = document.querySelectorAll('button');
            
            console.log(`🔒 Desabilitação final: ${inputs.length} inputs, ${selects.length} selects, ${textareas.length} textareas, ${buttons.length} buttons`);
            
            [...inputs, ...selects, ...textareas].forEach(campo => {
                if (!campo.readOnly && !campo.disabled) {
                    campo.disabled = true;
                    campo.readOnly = true;
                    campo.classList.add('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                    console.log(`🔒 Campo desabilitado (final): ${campo.id || campo.name || campo.tagName}`);
                }
            
            // Limpar dados temporários
            localStorage.removeItem('pedidoParaVisualizar');
            });
            
            // Desabilitar botões (exceto navegação)
            buttons.forEach(button => {
                const id = button.id || '';
                const isNavButton = id.includes('voltar') || id.includes('imprimir') || id.includes('Menu') || id.includes('Dashboard') || id.includes('Sair');
                
                if (!isNavButton) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                    console.log(`🔒 Botão desabilitado (final): ${button.id || button.textContent?.trim().substring(0, 20)}`);
                }
            });
        }, 500);
        
    } catch (error) {
        console.error("❌ Erro na finalização:", error);
        showGlobalModal('Erro', 'Erro ao finalizar o preenchimento.');
    }
}

function preencherCamposPedido(dadosPedido) {
    console.log("=== PREENCHENDO CAMPOS ===");
    console.log("Dados recebidos:", dadosPedido);
       
    // 1. NÚMERO DO PEDIDO
    const numeroPedido = document.getElementById('numeroPedido');
    if (numeroPedido) {
        const numeroParaPreencher = dadosPedido.numeroDoPedido || dadosPedido.numero || '';
        numeroPedido.value = numeroParaPreencher;
        console.log(`✅ Número do pedido preenchido: "${numeroParaPreencher}"`);
        
        // Forçar atualização visual
        numeroPedido.dispatchEvent(new Event('input'));
        numeroPedido.dispatchEvent(new Event('change'));
    } else {
        console.error('❌ Campo numeroPedido não encontrado no DOM');
        // Tentar novamente após delay
        setTimeout(() => {
            const numeroPedidoRetry = document.getElementById('numeroPedido');
            if (numeroPedidoRetry) {
                const numeroParaPreencher = dadosPedido.numeroDoPedido || dadosPedido.numero || '';
                numeroPedidoRetry.value = numeroParaPreencher;
                console.log(`✅ Número do pedido preenchido (retry): "${numeroParaPreencher}"`);
            }
        }, 500);
    }
    
    // 2. DATA DO PEDIDO
    const dataPedido = document.getElementById('dataPedido');
    if (dataPedido) {
        dataPedido.value = dadosPedido.data || '';
        console.log(`✅ Data: ${dadosPedido.data}`);
    } else {
        console.warn('❌ Campo dataPedido não encontrado');
    }
    
    // 3. PLACA DO VEÍCULO
    const placaVeiculo = document.getElementById('placaVeiculo');
    if (placaVeiculo) {
        placaVeiculo.value = dadosPedido.placaVeiculo || '';
        console.log(`✅ Placa: ${dadosPedido.placaVeiculo}`);
    } else {
        console.warn('❌ Campo placaVeiculo não encontrado');
    }
    
    // 4. OBSERVAÇÕES
    const observacoesPedido = document.getElementById('observacoesPedido');
    if (observacoesPedido) {
        observacoesPedido.value = dadosPedido.observacoes || '';
        console.log(`✅ Observações: ${dadosPedido.observacoes}`);
    } else {
        console.warn('❌ Campo observacoesPedido não encontrado');
    }
    
    // 5. TOTAL GERAL
    const totalGeral = document.getElementById('totalGeral');
    if (totalGeral) {
        const valorFormatado = `R$ ${parseFloat(dadosPedido.totalGeral || 0).toFixed(2).replace('.', ',')}`;
        totalGeral.value = valorFormatado;
        console.log(`✅ Total: ${valorFormatado}`);
    } else {
        console.warn('❌ Campo totalGeral não encontrado');
    }
    
    // 6. FORNECEDOR E VEÍCULO - aguardar carregamento
    setTimeout(() => {
        preencherSelectFornecedor(dadosPedido.fornecedor);
        preencherSelectVeiculo(dadosPedido.nomeVeiculo);
    }, 1500);
    
    // 7. ITENS
     let itensArray = dadosPedido.itens;

    // VERIFICA SE 'itens' É UMA STRING JSON E, SE FOR, CONVERTE PARA UM ARRAY
    if (typeof itensArray === 'string' && itensArray.startsWith('[')) {
        try {
            itensArray = JSON.parse(itensArray);
            console.log('✅ Itens convertidos de STRING para ARRAY:', itensArray);
        } catch (e) {
            console.error('❌ Erro ao fazer parse da string de itens:', e);
            itensArray = []; // Define como array vazio em caso de erro de parse
        }
    }

    // AGORA A VERIFICAÇÃO VAI FUNCIONAR CORRETAMENTE
    if (itensArray && Array.isArray(itensArray) && itensArray.length > 0) {
        console.log(`Preenchendo ${itensArray.length} itens...`);
        preencherItensContainer(itensArray); // Usa o array já convertido
    } else {
        console.warn('❌ Nenhum item encontrado ou formato inválido após a verificação.');
    }
}

function preencherSelectFornecedor(nomeFornecedor) {
    if (!nomeFornecedor) {
        console.warn('❌ Nome do fornecedor não fornecido');
        return;
    }
    
    const fornecedorSelect = document.getElementById('fornecedorPedido');
    if (fornecedorSelect && fornecedorSelect.options.length > 0) {
        console.log(`Procurando fornecedor: "${nomeFornecedor}"`);
        console.log(`Opções disponíveis:`, Array.from(fornecedorSelect.options).map(opt => opt.text));
        
        const opcoes = fornecedorSelect.options;
        for (let i = 0; i < opcoes.length; i++) {
            if (opcoes[i].text.includes(nomeFornecedor) || 
                opcoes[i].value.includes(nomeFornecedor)) {
                fornecedorSelect.selectedIndex = i;
                console.log(`✅ Fornecedor selecionado: ${opcoes[i].text}`);
                
                // Disparar evento de mudança para atualizar o estado
                const evento = new Event('change', { bubbles: true });
                fornecedorSelect.dispatchEvent(evento);
                
                return;
            }
        }
        console.warn(`❌ Fornecedor "${nomeFornecedor}" não encontrado nas opções`);
    } else {
        console.warn('❌ Select de fornecedor não carregado ainda');
        // Tentar novamente após mais tempo
        setTimeout(() => {
            preencherSelectFornecedor(nomeFornecedor);
        }, 1000);
    }
}

function preencherSelectVeiculo(nomeVeiculo) {
    if (!nomeVeiculo || nomeVeiculo.trim() === '') {
        console.warn('❌ Nome do veículo não fornecido ou vazio');
        return;
    }
    
    const veiculoSelect = document.getElementById('nomeVeiculo');
    if (veiculoSelect && veiculoSelect.options.length > 1) { // >1 porque sempre tem a opção vazia
        console.log(`Procurando veículo: "${nomeVeiculo}"`);
        console.log(`Opções disponíveis:`, Array.from(veiculoSelect.options).map(opt => opt.value).filter(v => v.trim() !== ''));
        
        const nomeVeiculoLimpo = nomeVeiculo.trim().toUpperCase();
        const opcoes = veiculoSelect.options;
        
        // Primeira tentativa: busca exata
        for (let i = 0; i < opcoes.length; i++) {
            const opcaoTexto = opcoes[i].textContent.trim().toUpperCase();
            const opcaoValue = opcoes[i].value.trim().toUpperCase();
            
            if (opcaoTexto === nomeVeiculoLimpo || opcaoValue === nomeVeiculoLimpo) {
                veiculoSelect.selectedIndex = i;
                console.log(`✅ Veículo selecionado (exato): ${opcoes[i].textContent}`);
                return;
            }
        }
        
        // Segunda tentativa: busca por conteúdo
        for (let i = 0; i < opcoes.length; i++) {
            const opcaoTexto = opcoes[i].textContent.trim().toUpperCase();
            const opcaoValue = opcoes[i].value.trim().toUpperCase();
            
            if (opcaoTexto.includes(nomeVeiculoLimpo) || 
                opcaoValue.includes(nomeVeiculoLimpo) ||
                nomeVeiculoLimpo.includes(opcaoTexto) ||
                nomeVeiculoLimpo.includes(opcaoValue)) {
                veiculoSelect.selectedIndex = i;
                console.log(`✅ Veículo selecionado (parcial): ${opcoes[i].textContent}`);
                return;
            }
        }
        
        console.warn(`❌ Veículo "${nomeVeiculo}" não encontrado nas opções disponíveis`);
    } else {
        console.warn('❌ Select de veículo não carregado ainda ou sem opções válidas');
        // Tentar novamente após mais tempo
        setTimeout(() => {
            preencherSelectVeiculo(nomeVeiculo);
        }, 1000);
    }
}

// Função que será chamada para lidar com o clique no botão
function handleAdicionarNovoVeiculo() {
  // 1. Pede ao usuário o nome do novo veículo
  const nomeVeiculo = prompt("Digite o nome ou a placa do novo veículo:");

  // 2. Verifica se o usuário cancelou ou não digitou nada
  if (!nomeVeiculo || nomeVeiculo.trim() === '') {
    console.log("Adição de veículo cancelada.");
    return; // Interrompe a função
  }

  // 3. Fornece feedback e chama o backend
  showToast('Adicionando veículo...', 'info');
  google.script.run
    .withSuccessHandler(response => {
      // 4. Lida com a resposta de sucesso do backend
      if (response && response.status === 'ok') {
        showToast(response.message || 'Veículo adicionado com sucesso!', 'success');
        
        // 5. ATUALIZA A LISTA DE VEÍCULOS NA TELA (MUITO IMPORTANTE!)
        const veiculoSelect = document.getElementById('veiculoSelect'); // <-- MUDE 'veiculoSelect' para o ID real do seu campo de veículos
        if (veiculoSelect && response.novoVeiculo) {
          // Cria uma nova opção
          const novaOpcao = document.createElement('option');
          novaOpcao.value = response.novoVeiculo; // Assumindo que o backend retorna o nome do novo veículo
          novaOpcao.textContent = response.novoVeiculo;
          
          // Adiciona a nova opção à lista e a seleciona
          veiculoSelect.appendChild(novaOpcao);
          veiculoSelect.value = response.novoVeiculo;
        }
      } else {
        // Lida com um erro de lógica retornado pelo backend
        showToast(response ? response.message : 'Erro ao adicionar veículo.', 'error');
      }
    })
    .withFailureHandler(err => {
      // Lida com um erro de comunicação com o backend
      showToast('Erro de comunicação. Tente novamente.', 'error');
      console.error('Erro ao chamar adicionarNovoVeiculo:', err);
    })
    .adicionarNovoVeiculo(nomeVeiculo.trim());
}


// Função para obter data/hora local no formato correto
function obterDataHoraLocal() {
    const agora = new Date();
    const ano = agora.getFullYear();
    const mes = String(agora.getMonth() + 1).padStart(2, '0');
    const dia = String(agora.getDate()).padStart(2, '0');
    const hora = String(agora.getHours()).padStart(2, '0');
    const minuto = String(agora.getMinutes()).padStart(2, '0');
    const segundo = String(agora.getSeconds()).padStart(2, '0');
    
    return `${ano}-${mes}-${dia} ${hora}:${minuto}:${segundo}`;
}

function preencherItensContainer(itens) {
    console.log("Preenchendo tabela de itens com", itens.length, "itens");
    
    const tabelaBody = document.getElementById('itensTableBody');
    if (!tabelaBody) {
        console.error("❌ Tabela de itens não encontrada");
        return;
    }
    
    // Limpar tabela (remover linha "nenhum item")
    tabelaBody.innerHTML = '';
    
    // Adicionar cada item como linha da tabela
    itens.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        
        const precoFormatado = `R$ ${parseFloat(item.precoUnitario || 0).toFixed(2).replace('.', ',')}`;
        const totalFormatado = `R$ ${parseFloat(item.totalItem || 0).toFixed(2).replace('.', ',')}`;
        
        row.innerHTML = `
            <td class="px-6 py-4 text-sm text-gray-900">${item.descricao || ''}</td>
            <td class="px-6 py-4 text-sm text-gray-900">${item.produtoFornecedor || ''}</td>
            <td class="px-6 py-4 text-sm text-gray-900 text-center">${item.quantidade || ''}</td>
            <td class="px-6 py-4 text-sm text-gray-900 text-center">${item.unidade || ''}</td>
            <td class="px-6 py-4 text-sm text-gray-900 text-right">${precoFormatado}</td>
            <td class="px-6 py-4 text-sm font-bold text-blue-600 text-right">${totalFormatado}</td>
            <td class="px-6 py-4 text-center">
                <button onclick="removerItem(${index})" class="text-red-600 hover:text-red-800 text-sm" title="Remover item">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tabelaBody.appendChild(row);
    });
    
    console.log(`✅ Tabela preenchida com ${itens.length} itens`);
    
    // Calcular e atualizar total geral após carregar itens
    setTimeout(() => {
        const totalCalculado = itens.reduce((total, item) => {
            return total + (parseFloat(item.totalItem || 0));
        }, 0);
        
        const totalGeralElement = document.getElementById('totalGeral');
        const summaryTotalElement = document.getElementById('summary-total');
        
        if (totalGeralElement) {
            const valorFormatado = `R$ ${totalCalculado.toFixed(2).replace('.', ',')}`;
            totalGeralElement.textContent = valorFormatado;
            console.log(`✅ Total geral recalculado: ${valorFormatado}`);
        }
        
        if (summaryTotalElement) {
            const valorFormatado = `R$ ${totalCalculado.toFixed(2).replace('.', ',')}`;
            summaryTotalElement.textContent = valorFormatado;
            console.log(`✅ Summary total atualizado: ${valorFormatado}`);
        }
    }, 150);
}

        // Função para remover item da lista
        function removerItem(indexOuId) {
            if (confirm('Tem certeza que deseja remover este item?')) {
                console.log('🗑️ Removendo item:', indexOuId);
                
                // Se é um número simples (índice), remover do array window.itensAdicionados
                if (typeof indexOuId === 'number' && window.itensAdicionados && window.itensAdicionados[indexOuId]) {
                    console.log('🗑️ Removendo item do array (modo edição):', window.itensAdicionados[indexOuId]);
                    
                    // Remover do array
                    window.itensAdicionados.splice(indexOuId, 1);
                    
                    // Atualizar a tabela
                    preencherItensContainer(window.itensAdicionados);
                    
                    // Recalcular e atualizar total
                    const novoTotal = window.itensAdicionados.reduce((total, item) => {
                        return total + (parseFloat(item.subtotal || item.totalItem || 0));
                    }, 0);
                    
                    const totalGeralElement = document.getElementById('totalGeral');
                    const summaryTotalElement = document.getElementById('summary-total');
                    
                    if (totalGeralElement) {
                        totalGeralElement.textContent = `R$ ${novoTotal.toFixed(2).replace('.', ',')}`;
                    }
                    
                    if (summaryTotalElement) {
                        summaryTotalElement.textContent = `R$ ${novoTotal.toFixed(2).replace('.', ',')}`;
                    }
                    
                    showToast('Item removido com sucesso!', 'success');
                    console.log('✅ Item removido. Total atualizado:', novoTotal);
                } 
                // Se é um ID específico (novo item), remover da tabela diretamente
                else {
                    const row = document.querySelector(`tr[data-item-id="${indexOuId}"]`);
                    if (row) {
                        console.log('🗑️ Removendo linha da tabela (novo item):', row);
                        
                        // Remover do array global se existir
                        if (window.itensAdicionados) {
                            const itemIndex = window.itensAdicionados.findIndex(item => item.id === indexOuId);
                            if (itemIndex !== -1) {
                                window.itensAdicionados.splice(itemIndex, 1);
                            }
                        }
                        
                        row.remove();
                        calcularTotalGeral();
                        showToast('Item removido com sucesso!', 'success');
                    } else {
                        console.warn('⚠️ Linha com ID não encontrada:', indexOuId);
                    }
                }
            }
        }

        function desabilitarEdicaoPedido() {
          // Desabilitar todos os campos do formulário
          const form = document.querySelector('.max-w-7xl.mx-auto') || document.querySelector('main');
          if (form) {
              const inputs = form.querySelectorAll('input:not([readonly]), select, textarea');
              inputs.forEach(input => {
                  input.disabled = true;
                  input.classList.add('bg-gray-100', 'text-gray-600');
              });
              
              // Desabilitar botões específicos mas manter alguns
              const botoes = form.querySelectorAll('button');
              botoes.forEach(botao => {
                  const id = botao.id || '';
                  const texto = botao.textContent.toLowerCase();
                  
                  // Manter apenas botões permitidos
                  if (!id.includes('voltar') && 
                      !id.includes('imprimir') && 
                      !texto.includes('voltar') && 
                      !texto.includes('imprimir')) {
                      botao.disabled = true;
                      botao.classList.add('opacity-50', 'cursor-not-allowed');
                  }
              });
              
              console.log('✅ Modo visualização ativado - campos desabilitados');
          }
      }


        function adicionarBotaoVoltarDashboard(empresaOriginal) {
          console.log('🔧 adicionarBotaoVoltarDashboard chamado - empresaOriginal:', empresaOriginal);
          
          const form = document.querySelector('.max-w-7xl.mx-auto') || document.querySelector('main');
          if (!form) {
              console.warn('Container principal não encontrado para adicionar botões');
              return;
          }
          
          // Verificar se já existe
              if (document.getElementById('botoes-admin-visualizacao')) {
                  console.log('⚠️ Botões de admin já existem - não adicionando novamente');
                  return;
              }
              
              console.log('🔧 Adicionando botões de admin para visualização');
              
              // Encontrar a div dos botões existentes
              const botoesExistentes = form.querySelector('.flex.justify-end.space-x-4');
              if (botoesExistentes) {
                  console.log('🔧 Botões existentes encontrados - escondendo');
                  // Esconder botões originais (salvar/cancelar)
                  botoesExistentes.style.display = 'none';
                  
                  // Adicionar novos botões
                  const novosBotoes = document.createElement('div');
                  novosBotoes.id = 'botoes-admin-visualizacao';
                  novosBotoes.className = 'flex justify-end space-x-4 pt-4 border-t border-gray-200';
                  novosBotoes.innerHTML = `
                      <div class="flex items-center text-sm text-gray-500 mr-4">
                          <i class="fas fa-eye mr-2"></i>
                          Visualizando em modo somente leitura (Admin)
                      </div>
                      <button id="btn-voltar-dashboard-admin" 
                              class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">
                          <i class="fas fa-arrow-left mr-2"></i>Voltar ao Dashboard
                      </button>
                      <button id="btn-imprimir-pedido-atual" 
                              class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">
                          <i class="fas fa-print mr-2"></i>Imprimir Pedido
                      </button>
                  `;
                  
                  // Inserir após os botões originais
                  botoesExistentes.parentNode.insertBefore(novosBotoes, botoesExistentes.nextSibling);
                  
                  // Adicionar event listeners aos novos botões
                  const btnVoltar = document.getElementById('btn-voltar-dashboard-admin');
                  const btnImprimir = document.getElementById('btn-imprimir-pedido-atual');
                  
                  if (btnVoltar) {
                      btnVoltar.addEventListener('click', function(e) {
                          e.preventDefault();
                          e.stopPropagation();
                          voltarDashboardAdmin(empresaOriginal || '');
                      });
                  }
                  
                  if (btnImprimir) {
                      btnImprimir.addEventListener('click', function(e) {
                          e.preventDefault();
                          e.stopPropagation();
                          imprimirPedidoAtual();
                      });
                  }
                  
                  console.log('✅ Botões de admin adicionados com event listeners');
              }
          }

        // ===============================================
        // FUNÇÕES AUXILIARES PARA VISUALIZAÇÃO DE PEDIDOS
        // ===============================================
        
        function limparEstadoVisualizacao() {
            try {
                // Limpar dados temporários
                localStorage.removeItem('empresaOriginalAdmin');
                localStorage.removeItem('pedidoParaVisualizar');
                localStorage.removeItem('modoVisualizacao');
                
                // Remover botões de admin se existirem
                const botoesAdmin = document.getElementById('botoes-admin-visualizacao');
                if (botoesAdmin) {
                    botoesAdmin.remove();
                }
                
                console.log('Estado de visualização limpo');
            } catch (error) {
                console.error('Erro ao limpar estado de visualização:', error);
            }
        }
        
        function verificarElementosNecessarios() {
            const elementos = {
                numeroPedido: document.getElementById('numeroPedido'),
                globalModal: document.getElementById('global-modal'),
                mainContent: document.getElementById('main-content-area')
            };
            
            const elementosValidos = Object.keys(elementos).filter(key => elementos[key] !== null);
            console.log('Elementos disponíveis:', elementosValidos);
            
            return elementos;
        }

        function voltarDashboardAdmin(empresaOriginal) {
            try {
                console.log('Voltando ao Menu...');
                
                // Limpar estado de visualização primeiro
                limparEstadoVisualizacao();
                
                // Verificar elementos necessários
                const elementos = verificarElementosNecessarios();
                
                // Restaurar empresa original se existir
                if (empresaOriginal && empresaOriginal !== 'null' && empresaOriginal !== 'undefined') {
                    try {
                        // Verificar se é um JSON válido
                        if (typeof empresaOriginal === 'string' && empresaOriginal.startsWith('{')) {
                            const empresaJson = JSON.parse(empresaOriginal);
                            if (empresaJson && empresaJson.id) {
                                localStorage.setItem('empresaSelecionada', empresaOriginal);
                                console.log('Empresa original restaurada');
                            }
                        }
                    } catch (e) {
                        console.warn('Erro ao restaurar empresa original:', e);
                    }
                }
                
                // Verificar se a função loadPageContent existe
                if (typeof loadPageContent !== 'function') {
                    console.error('Função loadPageContent não encontrada');
                    location.reload(); // Fallback extremo
                    return;
                }
                
                // Verificar se setupMenuScreen existe
                if (typeof setupMenuScreen !== 'function') {
                    console.error('Função setupMenuScreen não encontrada');
                    location.reload(); // Fallback extremo
                    return;
                }
                
                // Voltar ao Menu com timeout para evitar conflitos
                setTimeout(() => {
                    try {
                        loadPageContent('Menu', setupMenuScreen);
                    } catch (loadError) {
                        console.error('Erro ao carregar menu:', loadError);
                        // Fallback - recarregar página
                        location.reload();
                    }
                }, 200);
                
            } catch (error) {
                console.error('Erro em voltarDashboardAdmin:', error);
                // Fallback final - limpar tudo e recarregar
                limparEstadoVisualizacao();
                setTimeout(() => {
                    location.reload();
                }, 300);
            }
        }

        function imprimirPedidoAtual() {
           console.log('Iniciando impressão do pedido em tela...');
          const numeroPedido = document.getElementById('numeroPedido')?.value;
          const empresaId = JSON.parse(localStorage.getItem('empresaSelecionada'))?.id;
          
          // Chama a nossa gerente de impressão
          iniciarImpressao(numeroPedido, empresaId);
      }

    // ===============================================
    // FUNÇÃO PARA CALCULO DE IMPOSTOS
    // ===============================================

    /**
     * Coleta os dados, chama o backend para o cálculo de imposto e atualiza a tela.
     */
    function atualizarTotaisDoPedido() {
    console.log('🔄 Atualizando todos os totais do pedido...');

    // --- ETAPA 1: CALCULAR SUBTOTAL E COLETAR DADOS ---
    const subtotal = (window.itensAdicionados || []).reduce((total, item) => total + item.subtotal, 0);
    
    const fornecedorSelect = document.getElementById('fornecedorPedido');
    const selectedOption = fornecedorSelect.options[fornecedorSelect.selectedIndex];
    const estado = selectedOption ? selectedOption.dataset.estado : null;
    const regime = selectedOption ? selectedOption.dataset.regime : null;
    
    // Pega as referências aos elementos de exibição
    const subtotalElement = document.getElementById('totalGeral');
    const totalGeralElement = document.getElementById('summary-total');
    const valorImpostoElement = document.getElementById('valor-imposto');

    // Atualiza imediatamente o subtotal na tela
    if (subtotalElement) {
        subtotalElement.textContent = subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // Se não tiver estado ou itens, zera os impostos e finaliza
    if (!estado || subtotal <= 0) {
        if (valorImpostoElement) valorImpostoElement.textContent = (0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        if (totalGeralElement) totalGeralElement.textContent = subtotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        return;
    }
    
    // --- ETAPA 2: MONTAR PACOTE DE DADOS E CHAMAR O BACKEND ---
    const itensParaCalculo = window.itensAdicionados || [];
    const dadosGeraisParaCalculo = {
        ufFornecedor: estado,
        regimeTributario: regime
        // Adicione aqui a NFE se necessário
    };

    showToast('Calculando impostos...', 'info');

    google.script.run
        .withSuccessHandler(response => {
            if (response && response.status === 'ok') {
                const resultados = response.resultados;
                const valorImposto = resultados.icmsStTotal || 0;
                const totalGeral = subtotal + valorImposto;

                // Atualiza a tela com os resultados
                if (valorImpostoElement) valorImpostoElement.textContent = valorImposto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                if (totalGeralElement) totalGeralElement.textContent = totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } else {
                showToast(response ? response.message : 'Erro ao calcular imposto.', 'error');
            }
        })
        .withFailureHandler(err => {
            showToast('Erro de comunicação.', 'error');
            console.error(err);
        })
        .calcularImpostoPedidoCompleto(itensParaCalculo, dadosGeraisParaCalculo);
}

    // ===============================================
    // FUNÇÃO PARA GERENCIAR USUÁRIOS
    // ===============================================
        
    function setupGerenciarUsuariosScreen() {
    console.log("--- setupGerenciarUsuariosScreen: Iniciando inicialização da tela de gerenciamento de usuários ---");
    
     //Dados que serão carregados do backend
    let allUsers = [{ nome: "João", status: "Ativo", empresas: "Empresa X" },
      { nome: "Maria", status: "Inativo", empresas: "Empresa Y" }];
    let empresasDisponiveis = [];
    let auditDataCache = {};
    const usersTableBody = document.getElementById('usersTableBody');
    if (!usersTableBody) return;

        // ===============================================
    // FUNÇÕES DE CARREGAMENTO DE DADOS
    // ===============================================

    function loadUsersFromBackend() {
        showToast('Carregando usuários...', 'info');
        
        google.script.run
            .withSuccessHandler(users => {
                // --- LOG DE DIAGNÓSTICO ---
                console.log("✅ [Frontend] SUCESSO! Dados recebidos do backend:", users);
                
                allUsers = users || [];
                
                if (allUsers.length > 0) {
                    console.log(`[Frontend] A variável 'allUsers' foi populada com ${allUsers.length} usuários.`);
                } else {
                    console.warn("[Frontend] A variável 'allUsers' está vazia após o retorno do backend.");
                }

                renderUsersTable();
                showToast('Usuários carregados com sucesso!', 'success');
            })
            .withFailureHandler(error => {
                console.error('❌ [Frontend] ERRO ao carregar usuários:', error);
                showToast('Erro ao carregar usuários: ' + error.message, 'error');
            })
            .listarUsuariosCompleto();
    }

    function loadEmpresasFromBackend() {
        google.script.run
            .withSuccessHandler(empresas => {
                empresasDisponiveis = empresas || [];
            })
            .withFailureHandler(error => {
                console.error('Erro ao carregar empresas:', error);
            })
            .listarEmpresas();
    }

    function loadAuditData(userId, callback) {
        if (auditDataCache[userId]) {
            callback(auditDataCache[userId]);
            return;
        }

        google.script.run
            .withSuccessHandler(auditData => {
                auditDataCache[userId] = auditData;
                callback(auditData);
            })
            .withFailureHandler(error => {
                console.error('Erro ao carregar dados de auditoria:', error);
                callback({ lastLogin: null, lastOrder: null, lastPrint: null });
            })
            .obterDadosAuditoria(userId);
    }

    // ===============================================
    // ELEMENTOS DO DOM
    // ===============================================
    const tableBody = document.getElementById('usersTableBody');
    const messageElement = document.getElementById('userManagementMessage');
    const modals = {
        empresas: document.getElementById('modal-empresas-container'),
        audit: document.getElementById('modal-audit-container')
    };
  
    // ===============================================
    // FUNÇÕES DE RENDERIZAÇÃO E UI
    // ===============================================

     function renderUsersTable() {
        const tableBody = document.getElementById('usersTableBody');
        if (!tableBody) {
            console.error("Elemento 'usersTableBody' não encontrado no DOM.");
            return;
        }
        tableBody.innerHTML = '';

        if (!allUsers || allUsers.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-10">Nenhum usuário encontrado.</td></tr>';
            return;
        }

        allUsers.forEach(user => {
            const empresasIdsArray = user.empresasIds || [];
            const empresasNomesArray = user.empresas ? user.empresas.split(',').map(e => e.trim()) : []; 
            const empresasHtml = empresasIdsArray.map((id, idx) => {
            const nomeEmpresa = empresasNomesArray[idx] || `Empresa ${id}`;
            const isDefault = id === user.empresaPadrao;
            console.log('Frontend recebeu e normalizou as empresa');
                // Usando classes padrão do Tailwind para garantir a visibilidade
                const tagClass = isDefault ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-gray-100 text-gray-600 border-transparent';
                return `<span class="inline-flex items-center ${tagClass} text-xs font-medium mr-2 px-2.5 py-1 rounded-full border">
                    ${isDefault ? '<i class="fas fa-star fa-xs mr-1.5 text-yellow-500"></i>' : ''}
                    ${nomeEmpresa}
                </span>`;
            }).join('') || `<span class="text-xs text-gray-400 italic">Nenhuma</span>`;

            // Usando classes padrão do Tailwind para o status
            const statusClass = user.status === 'Ativo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            const toggleIcon = user.status === 'Ativo' ? 'fa-toggle-on text-green-500' : 'fa-toggle-off text-gray-400';

            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${user.nome}</div><div class="text-sm text-gray-500">${user.usuario}</div></td>
                <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${user.status}</span></td>
                <td class="px-6 py-4 text-sm text-gray-500"><div class="flex flex-wrap gap-2">${empresasHtml}</div></td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-xl font-medium space-x-5">
                    <button data-userid="${user.id}" class="action-toggle-status text-gray-400 hover:text-gray-600" title="${user.status === 'Ativo' ? 'Desativar' : 'Ativar'}"><i class="fas ${toggleIcon}"></i></button>
                    <button data-userid="${user.id}" class="action-manage-empresas text-gray-400 hover:text-blue-600" title="Gerenciar Empresas"><i class="fas fa-building"></i></button>
                    <button data-userid="${user.id}" class="action-audit text-gray-400 hover:text-blue-600" title="Auditoria"><i class="fas fa-shield-halved"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        addTableEventListeners();
    }

            function showMessage(text, type = 'success') {
                messageElement.textContent = text;
                messageElement.className = `text-center text-sm font-medium min-h-[20px] mb-4 transition-opacity duration-300 ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
                setTimeout(() => { messageElement.textContent = ''; }, 3000);
            }

            // ===============================================
            // LÓGICA DOS MODAIS
            // ===============================================

            function openModal(modalName, userId) {
              const user = allUsers.find(u => u.id == userId);
              if (!user) return;
              
              const modalContainer = modals[modalName];
              if (!modalContainer) return;

              if (modalName === 'empresas') {
                  modalContainer.querySelector('#modal-empresas-title').textContent = `Empresas de: ${user.nome}`;
                  const listBody = modalContainer.querySelector('#empresas-list-body');
                  
                  listBody.innerHTML = '<tr><td colspan="3" class="text-center">Carregando...</td></tr>';
                  google.script.run
                      .withSuccessHandler(empresas => {
                          const userEmpresasIds = user.empresasIds || [];
                          listBody.innerHTML = empresas.map(empresa => `
                              <tr class="hover:bg-gray-50 border-b border-gray-100">
                                  <td class="px-4 py-3 text-center"><input type="checkbox" value="${empresa.codigo}" name="empresa_access" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${userEmpresasIds.includes(String(empresa.codigo)) ? 'checked' : ''}></td>
                                  <td class="px-4 py-3 text-sm text-gray-800">${empresa.nome}</td>
                                  <td class="px-4 py-3 text-center"><input type="radio" value="${empresa.codigo}" name="empresa_default" class="h-5 w-5 text-blue-600 focus:ring-blue-500" ${user.empresaPadraoId === String(empresa.codigo) ? 'checked' : ''}></td>
                              </tr>`).join('');
                      })
                      .withFailureHandler(error => {
                          listBody.innerHTML = '<tr><td colspan="3" class="text-center text-red-500">Erro ao carregar empresas</td></tr>';
                      })
                      .listarEmpresas();
                  
                  modalContainer.querySelector('#modal-empresas-save-btn').dataset.userid = userId;
              }

                if (modalName === 'audit') {
                    modalContainer.querySelector('#modal-audit-title').textContent = `Auditoria de: ${user.nome}`;
                    const auditBody = modalContainer.querySelector('#modal-audit-body');
                    
                    // Mostra loading
                    auditBody.innerHTML = '<div class="text-center text-gray-500">Carregando dados de auditoria...</div>';
                    
                    loadAuditData(userId, (data) => {
                        const format = (d) => d ? new Date(d).toLocaleString('pt-BR') : 'N/A';
                        
                        const createAuditItem = (icon, title, value) => `<div class="flex items-start"><div class="flex-shrink-0 w-8 text-center"><i class="fas ${icon} text-gray-400"></i></div><div class="ml-3"><p class="text-sm font-medium text-gray-800">${title}</p><p class="text-sm text-gray-500">${value}</p></div></div>`;
                        
                        auditBody.innerHTML = 
                            createAuditItem('fa-clock', 'Último Acesso', `${format(data.lastLogin?.date)} (IP: ${data.lastLogin?.ip || 'N/A'})`) +
                            createAuditItem('fa-file-invoice', 'Último Pedido Criado', data.lastOrder ? `${data.lastOrder.id} em ${format(data.lastOrder.date)}` : 'Nenhum registro') +
                            createAuditItem('fa-print', 'Última Impressão', data.lastPrint ? `Pedido ${data.lastPrint.id} em ${format(data.lastPrint.date)}` : 'Nenhum registro');
                    });
                }
                
                modalContainer.classList.remove('modal-hidden');
            }

            function closeModal(modalContainer) {
                modalContainer.classList.add('modal-hidden');
            }

            // ===============================================
            // AÇÕES DA TABELA
            // ===============================================
            
            function toggleUserStatus(userId) {
                const user = allUsers.find(u => u.id == userId);
                if (!user) return;
                
                showToast('Alterando status do usuário...', 'info');
                
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.status === 'ok') {
                            showToast(response.message, 'success');
                            // Recarrega os dados para manter sincronia
                            loadUsersFromBackend();
                        } else {
                            showToast('Erro: ' + response.message, 'error');
                        }
                    })
                    .withFailureHandler(error => {
                        console.error('Erro ao alterar status:', error);
                        showToast('Erro ao alterar status: ' + error.message, 'error');
                    })
                    .alternarStatusUsuario(userId);
            }
            
            function saveEmpresasChanges(btn) {
                const userId = btn.dataset.userid;
                const user = allUsers.find(u => u.id == userId);
                if (!user) return;
                
                const modalContainer = modals.empresas;
                const empresasSelecionadas = Array.from(modalContainer.querySelectorAll('input[name="empresa_access"]:checked')).map(cb => cb.value);
                const defaultRadio = modalContainer.querySelector('input[name="empresa_default"]:checked');
                const empresaPadrao = defaultRadio ? defaultRadio.value : '';
                
                showToast('Salvando permissões de empresas...', 'info');
                
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.status === 'ok' || response.status === 'success') {
                            showToast(`Empresas de ${user.nome} atualizadas com sucesso!`, 'success', 'Permissões Atualizadas');
                            closeModal(modalContainer);
                            // Recarrega os dados para mostrar as mudanças
                            loadUsersFromBackend();
                        } else {
                            showToast('Erro: ' + response.message, 'error', 'Falha na Atualização');
                        }
                    })
                    .withFailureHandler(error => {
                        console.error('Erro ao salvar permissões:', error);
                        showToast('Erro ao salvar permissões: ' + error.message, 'error');
                    })
                    .salvarPermissoesEmpresaUsuario(userId, empresasSelecionadas, empresaPadrao);
            }

            // ===============================================
            // EVENT LISTENERS
            // ===============================================

            function addTableEventListeners() {
                document.querySelectorAll('.action-toggle-status, .action-manage-empresas, .action-audit').forEach(button => {
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    newButton.addEventListener('click', (e) => {
                        const target = e.currentTarget;
                        const userId = target.dataset.userid;
                        if (target.classList.contains('action-toggle-status')) toggleUserStatus(userId);
                        if (target.classList.contains('action-manage-empresas')) openModal('empresas', userId);
                        if (target.classList.contains('action-audit')) openModal('audit', userId);
                    });
                });
            }
            
            // Listeners dos Modais
            document.querySelectorAll('.modal-container').forEach(modalContainer => {
                const overlay = modalContainer.querySelector('.modal-overlay');
                const closeBtn = modalContainer.querySelector('.modal-close-btn');
                const cancelBtn = modalContainer.querySelector('.modal-cancel-btn');
                
                if (overlay) overlay.addEventListener('click', () => closeModal(modalContainer));
                if (closeBtn) closeBtn.addEventListener('click', () => closeModal(modalContainer));
                if (cancelBtn) cancelBtn.addEventListener('click', () => closeModal(modalContainer));
            });
            
            if (modals.empresas) {
                const saveBtn = modals.empresas.querySelector('#modal-empresas-save-btn');
                if (saveBtn) {
                    const newSaveBtn = saveBtn.cloneNode(true);
                    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                    newSaveBtn.addEventListener('click', (e) => saveEmpresasChanges(e.currentTarget));
                }
            }

            // Botão voltar ao menu
            const backButton = document.getElementById('backToMenuFromUsersButton');
            if (backButton) {
                const newBackButton = backButton.cloneNode(true);
                backButton.parentNode.replaceChild(newBackButton, backButton);
                newBackButton.addEventListener('click', () => {
                    loadPageContent('Menu', setupMenuScreen);
                });
            }

            // ===============================================
            // INICIALIZAÇÃO
            // ===============================================
            
            // Carrega dados reais do backend na inicialização
            loadUsersFromBackend();
            loadEmpresasFromBackend();
         
            
       }

        // ===============================================
        // LÓGICA DA PÁGINA DE NOVO PEDIDO
        // ===============================================
        // FUNÇÃO PARA CONFIGURAR MODO DE EDIÇÃO
        // ===============================================
        function setupModoEdicao(dadosEdicao) {
            console.log('🔧 Configurando modo de edição:', dadosEdicao);
            
            // Alterar título da página para indicar modo de edição
            const titleElement = document.getElementById('page-title');
            const subtitleElement = document.getElementById('page-subtitle');
            
            if (titleElement) {
                titleElement.innerHTML = `
                    <i class="fas fa-edit mr-3 text-orange-500"></i>
                    Editar Pedido #${dadosEdicao.numeroDoPedido}
                    <span class="ml-3 px-3 py-1 bg-orange-100 text-orange-700 text-sm rounded-full">Modo Edição</span>
                `;
                titleElement.className = 'text-3xl font-bold text-orange-600 flex items-center';
            }
            
            if (subtitleElement) {
                subtitleElement.textContent = 'Você tem 1 hora para editar este pedido após a criação.';
                subtitleElement.className = 'text-orange-500';
            }
            
            // Alterar texto dos botões
            const salvarButton = document.getElementById('salvarPedidoButton');
            const salvarRascunhoButton = document.getElementById('salvarRascunhoButton');
            
            if (salvarButton) {
                salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Alterações';
                salvarButton.className = salvarButton.className.replace('bg-green-600', 'bg-orange-600').replace('hover:bg-green-700', 'hover:bg-orange-700');
            }
            
            if (salvarRascunhoButton) {
                salvarRascunhoButton.style.display = 'none'; // Esconder botão de rascunho em modo edição
            }
            
            // Adicionar aviso sobre tempo de edição
            adicionarAvisoTempoEdicao(dadosEdicao);
        }
        
        function preencherCamposEdicao(dados) {
            console.log('📝 Preenchendo campos para edição:', dados);

            let itensArray = dados.itens;
            if (typeof itensArray === 'string' && itensArray) {
                try {
                    itensArray = JSON.parse(itensArray);
                    console.log("✅ [preencherCamposEdicao] A string de itens foi convertida para um array com sucesso.");
                } catch (e) {
                    console.error("[preencherCamposEdicao] Erro ao converter a string de itens. A lista de itens não será preenchida.", e);
                    itensArray = []; // Define como array vazio em caso de erro
                }
            } else if (!Array.isArray(itensArray)) {
                console.warn("[preencherCamposEdicao] O campo 'itens' não é um array e não pôde ser convertido. A lista de itens não será preenchida.");
                itensArray = []; // Garante que seja um array para evitar erros futuros
            }
            
            // Preencher número do pedido
            if (dados.numeroDoPedido) {
                const numeroPedidoElement = document.getElementById('numeroPedido');
                if (numeroPedidoElement) {
                    console.log('✅ Preenchendo número do pedido:', dados.numeroDoPedido);
                    numeroPedidoElement.value = dados.numeroDoPedido;
                } else {
                    console.warn('⚠️ Campo numeroPedido não encontrado');
                }
            }
            
            // Preencher data
            if (dados.data) {
                const dataPedidoElement = document.getElementById('dataPedido');
                if (dataPedidoElement) {
                    console.log('✅ Preenchendo data:', dados.data);
                    dataPedidoElement.value = dados.data;
                } else {
                    console.warn('⚠️ Campo dataPedido não encontrado');
                }
            }
            
            // Preencher observações
            if (dados.observacoes) {
                const observacoesElement = document.getElementById('observacoesPedido');
                if (observacoesElement) {
                    console.log('✅ Preenchendo observações:', dados.observacoes);
                    observacoesElement.value = dados.observacoes;
                } else {
                    console.warn('⚠️ Campo observacoesPedido não encontrado');
                }
            }
            
            // Preencher fornecedor
            if (dados.cnpjFornecedor || dados.fornecedor) {
                const fornecedorElement = document.getElementById('fornecedorPedido');
                if (fornecedorElement) {
                    // Aguardar o carregamento dos fornecedores antes de selecionar
                    setTimeout(() => {
                        const cnpjProcurado = dados.cnpjFornecedor;
                        const nomeProcurado = dados.fornecedor;
                        
                        console.log('🔍 Procurando fornecedor:', { cnpjProcurado, nomeProcurado });
                        
                        // Primeiro tentar por CNPJ
                        if (cnpjProcurado) {
                            const opcoes = fornecedorElement.options;
                            for (let i = 0; i < opcoes.length; i++) {
                                const opcao = opcoes[i];
                                if (opcao.dataset.cnpj === cnpjProcurado.toString()) {
                                    fornecedorElement.selectedIndex = i;
                                    console.log('✅ Fornecedor encontrado por CNPJ:', opcao.textContent);
                                    fornecedorElement.dispatchEvent(new Event('change'));
                                    return;
                                }
                            }
                        }
                        
                        // Se não encontrou por CNPJ, tentar por nome/razão
                        if (nomeProcurado) {
                            fornecedorElement.value = nomeProcurado;
                            if (fornecedorElement.selectedIndex > 0) {
                                console.log('✅ Fornecedor encontrado por nome:', nomeProcurado);
                                fornecedorElement.dispatchEvent(new Event('change'));
                                return;
                            }
                        }
                        
                        console.warn('⚠️ Fornecedor não encontrado nos selects disponíveis');
                    }, 2000);
                } else {
                    console.warn('⚠️ Campo fornecedorPedido não encontrado');
                }
            }
            
            // Preencher veículo
            if (dados.nomeVeiculo) {
                const veiculoElement = document.getElementById('nomeVeiculo');
                if (veiculoElement) {
                    setTimeout(() => {
                        console.log('✅ Preenchendo veículo:', dados.nomeVeiculo);
                        veiculoElement.value = dados.nomeVeiculo;
                    }, 1000);
                } else {
                    console.warn('⚠️ Campo nomeVeiculo não encontrado');
                }
            }
            
            // Preencher placa
            if (dados.placaVeiculo) {
                const placaElement = document.getElementById('placaVeiculo');
                if (placaElement) {
                    console.log('✅ Preenchendo placa:', dados.placaVeiculo);
                    placaElement.value = dados.placaVeiculo;
                } else {
                    console.warn('⚠️ Campo placaVeiculo não encontrado');
                }
            }
            
            // Preencher itens
            if (itensArray && itensArray.length > 0) {
              console.log('📋 Preenchendo itens:', itensArray.length, 'itens encontrados');
              
              // Usa o array convertido
              window.itensAdicionados = itensArray.map(item => ({
                  descricao: item.descricao,
                  produtoFornecedor: item.produtoFornecedor,
                  quantidade: parseFloat(item.quantidade) || 0,
                  unidade: item.unidade || 'UN',
                  precoUnitario: parseFloat(item.precoUnitario) || 0,
                  subtotal: parseFloat(item.totalItem) || (parseFloat(item.quantidade) * parseFloat(item.precoUnitario))
              }));
              
              setTimeout(() => {
                  console.log('📊 Carregando itens na tabela...');
                  // Usa o array convertido
                  preencherItensContainer(itensArray);
                  
                  // Atualizar total geral
                  const totalCalculado = dados.totalGeral || itensArray.reduce((total, item) => {
                      return total + (parseFloat(item.totalItem) || 0);
                  }, 0);
                  
                  console.log('💰 Total calculado:', totalCalculado);
                  
                  const totalGeralElement = document.getElementById('totalGeral');
                  const summaryTotalElement = document.getElementById('summary-total');
                  
                  if (totalGeralElement) {
                      totalGeralElement.textContent = `R$ ${totalCalculado.toFixed(2).replace('.', ',')}`;
                  }
                  if (summaryTotalElement) {
                      summaryTotalElement.textContent = `R$ ${totalCalculado.toFixed(2).replace('.', ',')}`;
                  }
              }, 1500);
          }
      }
        
        function adicionarAvisoTempoEdicao(dados) {
            // Verificar se ainda pode editar
            const podeEditar = verificarSePermiteEdicao(dados);
            
            if (!podeEditar) {
                // Se não pode mais editar, mostrar aviso e desabilitar campos
                const container = document.querySelector('.max-w-7xl');
                if (container) {
                    const aviso = document.createElement('div');
                    aviso.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6';
                    aviso.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Tempo de edição expirado!</strong>
                            <span class="ml-2">Este pedido só pode ser editado dentro de 1 hora após a criação.</span>
                        </div>
                    `;
                    container.insertBefore(aviso, container.firstChild);
                }
                
                // Desabilitar todos os campos
                const campos = document.querySelectorAll('input, select, textarea, button');
                campos.forEach(campo => {
                    if (campo.id !== 'backToMenuFromPedidoButton') {
                        campo.disabled = true;
                    }
                });
                
                return false;
            } else {
                // Mostrar tempo restante
                const container = document.querySelector('.max-w-7xl');
                if (container && dados.dataHoraCriacao) {
                    const agora = new Date();
                    const criacao = new Date(dados.dataHoraCriacao);
                    const diferencaMinutos = Math.ceil(60 - ((agora - criacao) / (1000 * 60)));
                    
                    const aviso = document.createElement('div');
                    aviso.className = 'bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-6';
                    aviso.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas fa-clock mr-2"></i>
                            <strong>Modo Edição:</strong>
                            <span class="ml-2">Você tem aproximadamente ${diferencaMinutos} minutos restantes para editar este pedido.</span>
                        </div>
                    `;
                    container.insertBefore(aviso, container.firstChild);
                }
            }
            
            return podeEditar;
        }
        
        // ===============================================
        let itemCounter = 0;
        
        // Cache para fornecedores e veículos
        let cacheData = {
            fornecedores: null,
            veiculos: null,
           timestamp: null,
           aliquotaporEstado: null,
            expireTime: 5 * 60 * 1000 // 5 minutos
        };
        
        function isCacheValid() {
            return cacheData.timestamp && 
                   cacheData.fornecedores && 
                   cacheData.veiculos && 
                   cacheData.aliquotaporEstado &&
                   (new Date().getTime() - cacheData.timestamp) < cacheData.expireTime;
        }
        
        // Variável para guardar nosso mapa de alíquotas para consulta rápida
        let aliquotasPorEstado = {}; // Garanta que esta variável seja declarada no escopo do seu script
        
        function carregarDadosIniciais() {
    console.log("Promise: Iniciando carregamento de dados essenciais...");

    // Sua lógica de verificação de cache
    if (typeof isCacheValid === 'function' && isCacheValid()) {
        console.log('🚀 Usando dados do cache para carregamento rápido');
        if (typeof populateFornecedores === 'function') populateFornecedores(cacheData.fornecedores);
        if (typeof populateVeiculos === 'function') populateVeiculos(cacheData.veiculos);
        //if (typeof popularDropDownFornecedores === 'function') popularDropDownFornecedores(cacheData.fornecedores);
        if (aliquotasPorEstado && Object.keys(aliquotasPorEstado).length > 0) {
        return Promise.resolve(); // Resolve imediatamente se o cache for válido
        }
    }

    return new Promise((resolve, reject) => {
        console.log("Promise: Iniciando carregamento de dados essenciais...");
        Promise.all([
            new Promise((res, rej) => google.script.run.withSuccessHandler(data => { populateFornecedores(data); res(); }).withFailureHandler(rej).getFornecedoresListv2()),
            new Promise((res, rej) => google.script.run.withSuccessHandler(data => { populateVeiculos(data); res(); }).withFailureHandler(rej).getVeiculosList()),
            //new Promise((res, rej) => google.script.run.withSuccessHandler(data => { popularDropDownFornecedores(data); res(); }).withFailureHandler(rej).getFornecedoresListv2()),
            new Promise((res, rej) => google.script.run.withSuccessHandler(data => {
                const mapa = {};
                if (Array.isArray(data)) {
                    data.forEach(estado => { mapa[estado.value] = estado.aliquota; });
                }
                window.aliquotasPorEstado = mapa;
                res();
            }).withFailureHandler(rej).getEstadosv2())
        ]).then(() => {
            console.log("🚀 Carregamento paralelo concluído!");
            resolve();
        }).catch(error => {
            console.error('❌ Erro no carregamento paralelo:', error);
            reject(error);
        });
    });
}

async function setupPedidoScreen(modoEdicao = false, dadosEdicao = null) {
    console.log('🔧 setupPedidoScreen (async) iniciado', { modoEdicao, dadosEdicao });

    try {
        // ========================================================
        // PASSO 1: ESPERAR OS DADOS ESSENCIAIS
        // 'await' pausa a execução DESTA função até que carregarDadosIniciais() termine.
        // A corrida acabou. O código abaixo só roda depois que os selects estão prontos.
        // ========================================================
        await carregarDadosIniciais();
        console.log("✅ Dados essenciais (fornecedores, veículos) carregados. Prosseguindo...");

        // ========================================================
        // PASSO 2: CONFIGURAR TODA A LÓGICA DA TELA
        // Toda a sua lógica original, agora executada na ordem correta.
        // ========================================================
        //popularDropdownFornecedores();
        // --- Lógica do Modal de Veículos ---
        const modal = document.getElementById('modal-veiculo');
        const modalOverlay = document.getElementById('modal-veiculo-overlay');
        const nomeVeiculoInput = document.getElementById('nome-veiculo-input');
        const btnSalvarVeiculo = document.getElementById('modal-salvar-veiculo-btn');
        const btnCancelar = document.getElementById('modal-cancelar-btn');
        const btnAdicionarPrincipal = document.getElementById('addVeiculoBtn');

        const abrirModalVeiculo = () => {
            if (modal) {
                modal.classList.remove('hidden');
                if(nomeVeiculoInput) nomeVeiculoInput.focus();
            }
        };

        const fecharModalVeiculo = () => {
            if (modal) {
                modal.classList.add('hidden');
                if(nomeVeiculoInput) nomeVeiculoInput.value = '';
            }
        };

        const salvarNovoVeiculo = () => {
            const nomeVeiculo = nomeVeiculoInput.value;
            if (!nomeVeiculo || nomeVeiculo.trim() === '') {
                showToast('Por favor, digite o nome do veículo.', 'error');
                return;
            }

            showToast('Adicionando veículo...', 'info');
            if(btnSalvarVeiculo) btnSalvarVeiculo.disabled = true;
            google.script.run
                .withSuccessHandler(response => {
                    if(btnSalvarVeiculo) btnSalvarVeiculo.disabled = false;
                    if (response && response.status === 'ok') {
                        showToast(response.message || 'Veículo adicionado!', 'success');
                        const veiculoSelect = document.getElementById('nomeVeiculo');
                        if (veiculoSelect && response.novoVeiculo) {
                            const novaOpcao = document.createElement('option');
                            novaOpcao.value = response.novoVeiculo;
                            novaOpcao.textContent = response.novoVeiculo;
                            veiculoSelect.appendChild(novaOpcao);
                            veiculoSelect.value = response.novoVeiculo;
                        }
                        fecharModalVeiculo();
                    } else {
                        showToast(response ? response.message : 'Erro ao adicionar veículo.', 'error');
                    }
                })
                .withFailureHandler(err => {
                    if(btnSalvarVeiculo) btnSalvarVeiculo.disabled = false;
                    showToast('Erro de comunicação.', 'error');
                    console.error('Erro ao chamar adicionarNovoVeiculo:', err);
                })
                .adicionarNovoVeiculo(nomeVeiculo.trim());
        };

        if (btnAdicionarPrincipal) btnAdicionarPrincipal.addEventListener('click', abrirModalVeiculo);
        if (btnCancelar) btnCancelar.addEventListener('click', fecharModalVeiculo);
        if (modalOverlay) modalOverlay.addEventListener('click', fecharModalVeiculo);
        if (btnSalvarVeiculo) btnSalvarVeiculo.addEventListener('click', salvarNovoVeiculo);
        if (nomeVeiculoInput) {
            nomeVeiculoInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') salvarNovoVeiculo();
            });
        }
        
        // --- Lógica do select de Fornecedor ---
        const fornecedorSelect = document.getElementById('fornecedorPedido');
        if (fornecedorSelect) {
            fornecedorSelect.addEventListener('change', () => {
                const selectedOption = fornecedorSelect.options[fornecedorSelect.selectedIndex];
                const estado = selectedOption ? selectedOption.dataset.estado : null;
                const estadoElement = document.getElementById('fornecedor-estado');
                if (estadoElement) estadoElement.textContent = estado || 'Selecione';
                
                const aliquotaDisplay = document.getElementById('aliquota-display');
                if (aliquotaDisplay && estado && aliquotasPorEstado[estado] !== undefined) {
                    const aliquota = aliquotasPorEstado[estado];
                    aliquotaDisplay.textContent = `${(aliquota * 100).toFixed(1).replace('.',',')}%`;
                } else if (aliquotaDisplay) {
                    aliquotaDisplay.textContent = '-- %';
                }
                if(typeof atualizarTotaisDoPedido === 'function') atualizarTotaisDoPedido();
            });
        }
        
        // --- Lógica de Limpeza e Configuração de Botões ---
        const salvarPedidoBtn = document.getElementById('salvarPedidoButton');
        const salvarRascunhoBtn = document.getElementById('salvarRascunhoButton');
        const cancelarPedidoBtn = document.getElementById('cancelarPedidoButton');
        const addItemBtn = document.getElementById('addItemButton');

        const newSalvarButton = salvarPedidoBtn.cloneNode(true);
        salvarPedidoBtn.parentNode.replaceChild(newSalvarButton, salvarPedidoBtn);
        
        const newRascunhoButton = salvarRascunhoBtn ? salvarRascunhoBtn.cloneNode(true) : null;
        if(newRascunhoButton && salvarRascunhoBtn) salvarRascunhoBtn.parentNode.replaceChild(newRascunhoButton, salvarRascunhoBtn);
        
        const newCancelarButton = cancelarPedidoBtn ? cancelarPedidoBtn.cloneNode(true) : null;
        if(newCancelarButton && cancelarPedidoBtn) cancelarPedidoBtn.parentNode.replaceChild(newCancelarButton, cancelarPedidoBtn);
        
        const newItemBtn = addItemBtn ? addItemBtn.cloneNode(true) : null;
        if(newItemBtn && addItemBtn) addItemBtn.parentNode.replaceChild(newItemBtn, addItemBtn);


        // ========================================================
        // PASSO 3: DECIDIR O MODO (Criação vs. Edição vs. Visualização)
        // Esta lógica agora roda com 100% de certeza de que os selects estão preenchidos.
        // ========================================================
        const isViewMode = localStorage.getItem('modoVisualizacao') === 'true';

        if (isViewMode) {
            console.log('🔍 MODO: Visualização. Preenchendo dados do pedido existente...');
            preencherTelaPedidoExistente();
        } else if (modoEdicao) {
            console.log("... configurando para MODO EDIÇÃO.");
            if(typeof setupModoEdicao === 'function') setupModoEdicao(dadosEdicao);
            newSalvarButton.addEventListener('click', salvarEdicaoPedido);
            console.log("✅ Event listener do botão Salvar configurado para 'salvarEdicaoPedido'.");
        } else {
            console.log('📝 MODO: Criação. Configurando para um novo pedido...');
            
            // Lógica de inicialização para um novo pedido
            const tableBody = document.getElementById('itensTableBody');
            if (tableBody) tableBody.innerHTML = '<tr id="no-items-row"><td colspan="7" class="text-center text-gray-500 py-10">Nenhum item adicionado.</td></tr>';
            window.itensAdicionados = [];
            window.itemCounter = 0;
            
            const dataPedidoElement = document.getElementById('dataPedido');
            if (dataPedidoElement) {
                const today = new Date();
                dataPedidoElement.value = today.toISOString().split('T')[0];
            }

            // Configura os botões para o modo de criação
            newSalvarButton.addEventListener('click', salvarPedido);
            if(newRascunhoButton) newRascunhoButton.addEventListener('click', salvarRascunho);
        }

        // Configuração de botões comuns a todos os modos (exceto visualização, que é tratado em setupModoVisualizacao)
        if (!isViewMode) {
             if(newCancelarButton) newCancelarButton.addEventListener('click', () => loadPageContent('Menu', setupMenuScreen));
             if(newItemBtn) newItemBtn.addEventListener('click', adicionarItem);
        }
        
    } catch (error) {
        console.error("❌ Erro crítico durante o setup da tela de pedido:", error);
        showGlobalModal("Erro Crítico", "Não foi possível carregar os dados essenciais para esta tela.");
    }
}
              /**
               * Busca e preenche o dropdown de fornecedores com os data-attributes corretos.
               */
              function popularDropdownFornecedores(fornecedores) {
                const selectFornecedor = document.getElementById('fornecedorPedido');
                if (!selectFornecedor) return;

                google.script.run
                  .withSuccessHandler(fornecedores => {
                    selectFornecedor.length = 1; // Limpa opções antigas

                    fornecedores.sort((a, b) => (a.razaoSocial || '').localeCompare(b.razaoSocial || ''));

                    fornecedores.forEach(f => {
                      const option = document.createElement('option');
                      option.value = f.id || f.codigo;
                      option.textContent = f.razaoSocial;
                      
                      // Adiciona TODOS os dados necessários para as outras funções
                      if (f.estado) option.dataset.estado = f.estado;
                      if (f.grupo) option.dataset.grupo = f.grupo;
                      if (f.regime) option.dataset.regime = f.regime;

                      selectFornecedor.appendChild(option);
                    });
                  })
                  .getFornecedoresListv2(); // Sua função de backend que busca fornecedores
              }

            // Função para popular fornecedores
            function populateFornecedores(fornecedores) {
              console.log("Dados que chegaram do backend para popular fornecedores:", fornecedores);
            const selectFornecedor = document.getElementById('fornecedorPedido');
            if (selectFornecedor) {
              selectFornecedor.innerHTML = '<option value="">-- Selecione um Fornecedor --</option>';
              fornecedores.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id || f.codigo;
                option.textContent = f.razaoSocial;                
                option.dataset.estado = f.estado || '';
                option.dataset.grupo = f.grupo || '';
                option.dataset.regime = f.regime || ''; // <-- GARANTE QUE O DATA-ATTRIBUTE SEJA CRIADO

                 if (f.regime) {
                  option.dataset.regime = f.regime;
                }

                selectFornecedor.appendChild(option);
              });
            }
          }
            
            // Função para popular veículos
            function populateVeiculos(veiculos) {
                const selectVeiculo = document.getElementById('nomeVeiculo');
                if (selectVeiculo) {
                    selectVeiculo.innerHTML = '<option value="">Selecione um veículo</option>';
                    
                    veiculos.forEach((v, index) => {
                        // Tentar diferentes propriedades para encontrar o nome
                        let nomeVeiculo = null;
                        
                        if (typeof v === 'string' && v.trim() !== '' && v !== 'undefined') {
                            nomeVeiculo = v.trim();
                        } else if (typeof v === 'object' && v !== null) {
                            nomeVeiculo = v.nomeVeiculo || v.nome || v.veiculo || v.descricao;
                        }
                        
                        if (nomeVeiculo && nomeVeiculo.trim() !== '' && nomeVeiculo !== 'undefined') {
                            const option = document.createElement('option');
                            option.value = nomeVeiculo.trim();
                            option.textContent = nomeVeiculo.trim();
                            selectVeiculo.appendChild(option);
                        } else {
                            console.warn(`⚠️ Veículo inválido no índice ${index}:`, v);
                        }
                    });
                }
            }
        // Função específica para garantir modo somente leitura
        function garantirModoSomenteLeitura() {
            console.log('🔒 Função garantirModoSomenteLeitura executada');
            
            // Tentar múltiplos seletores para encontrar o container
            let container = document.querySelector('.max-w-7xl.mx-auto');
            if (!container) container = document.querySelector('main');
            if (!container) container = document.querySelector('body');
            if (!container) container = document;
            
            console.log('🔍 Container usado:', container);
            
            if (container) {
                // Buscar de forma mais específica
                const inputs = container.querySelectorAll('input');
                const selects = container.querySelectorAll('select'); 
                const textareas = container.querySelectorAll('textarea');
                const buttons = container.querySelectorAll('button');
                
                console.log(`� Elementos encontrados: ${inputs.length} inputs, ${selects.length} selects, ${textareas.length} textareas, ${buttons.length} buttons`);
                
                // Desabilitar inputs
                inputs.forEach(input => {
                    if (!input.readOnly) {
                        input.disabled = true;
                        input.readOnly = true;
                        input.classList.add('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                        console.log(`🔒 Input desabilitado: ${input.id || input.name || input.type}`);
                    }
                });
                
                // Desabilitar selects
                selects.forEach(select => {
                    select.disabled = true;
                    select.classList.add('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                    console.log(`🔒 Select desabilitado: ${select.id || select.name}`);
                });
                
                // Desabilitar textareas
                textareas.forEach(textarea => {
                    textarea.disabled = true;
                    textarea.readOnly = true;
                    textarea.classList.add('bg-gray-100', 'text-gray-600', 'cursor-not-allowed');
                    console.log(`🔒 Textarea desabilitado: ${textarea.id || textarea.name}`);
                });
                
                // Desabilitar botões (exceto navegação)
                buttons.forEach(button => {
                    const id = button.id || '';
                    const isNavButton = id.includes('voltar') || id.includes('imprimir') || id.includes('Menu') || id.includes('Dashboard') || id.includes('Sair') || id.includes('logout');
                    
                    if (!isNavButton) {
                        button.disabled = true;
                        button.classList.add('opacity-50', 'cursor-not-allowed');
                        console.log(`🔒 Botão desabilitado: ${button.id || button.textContent?.trim().substring(0, 20)}`);
                    } else {
                        console.log(`✅ Botão preservado: ${button.id}`);
                    }
                });
                
                console.log('✅ Modo somente leitura garantido');
            } else {
                console.error('❌ Nenhum container encontrado!');
            }
        }

        /**
 * Função centralizada para configurar a tela para o modo de apenas leitura.
 * Ela é chamada após o preenchimento dos dados.
 */
function setupModoVisualizacao() {
   console.log("🔍 Configurando modo visualização de pedido...");

    // 1. Esconder a seção de adicionar novos itens
    const secaoAdicionarItens = document.getElementById('add-item-section'); 
    if (secaoAdicionarItens) secaoAdicionarItens.style.display = 'none';

    // 2. Desabilitar todos os campos do formulário
    const formContainer = document.getElementById('main-content-area');
    if (formContainer) {
        const fields = formContainer.querySelectorAll('input, select, textarea');
        fields.forEach(field => {
            field.disabled = true;
            field.classList.add('bg-gray-100', 'cursor-not-allowed');
        });
        console.log(`✅ ${fields.length} campos do formulário desabilitados.`);
    }

    // 3. Desabilitar os botões de remover item na tabela
    const botoesRemover = document.querySelectorAll('button[onclick^="removerItem"]');
    botoesRemover.forEach(botao => {
        botao.disabled = true;
        botao.classList.add('text-gray-400', 'cursor-not-allowed');
        botao.onclick = () => false;
    });
    console.log(`✅ ${botoesRemover.length} botões de remover item foram desativados.`);

    // 4. Substituir os botões de ação principais
    let botoesArea = document.querySelector('.pt-6.space-y-3') || document.querySelector('#salvarPedidoButton')?.parentElement;
    if (botoesArea) {
        const numeroPedido = localStorage.getItem('numeroPedidoVisualizacao') || '';
        const origem = localStorage.getItem('origemVisualizacao') || 'menu-principal';

        botoesArea.innerHTML = `
            <button type="button" id="voltarButton" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-700"><i class="fas fa-arrow-left mr-2"></i>Voltar</button>
            <button type="button" id="imprimirPedidoButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700"><i class="fas fa-print mr-2"></i>Imprimir Pedido</button>
        `;
        
        const voltarBtn = document.getElementById('voltarButton');
        const imprimirBtn = document.getElementById('imprimirPedidoButton');

        if (voltarBtn) {
            voltarBtn.addEventListener('click', () => {
                localStorage.removeItem('modoVisualizacao');
                localStorage.removeItem('pedidoParaVisualizar');
                localStorage.removeItem('origemVisualizacao');
                
                // Lógica de "Voltar" Inteligente
                if (origem === 'meus-pedidos') {
                    loadPageContent('MeusPedidos', setupMeusPedidosScreen);
                } else if (origem === 'busca-pedidos') {
                    loadPageContent('BuscarPedido', setupBuscaScreen);
                } else {
                    loadPageContent('Menu', setupMenuScreen);
                }
            });
        }
        if (imprimirBtn) {
            imprimirBtn.addEventListener('click', () => {
                const pedidoData = JSON.parse(localStorage.getItem('pedidoParaVisualizar'));
                if (pedidoData && typeof abrirImpressao === 'function') {
                    abrirImpressao(pedidoData);
                }
            });
        }
        console.log("✅ Botões de ação substituídos para modo visualização.");
    }

    // Alterar o título da tela
            const titulo = document.querySelector('h1');
            if (titulo) {
                titulo.textContent = 'Visualizar Pedido de Compra';
                titulo.classList.add('text-blue-800');
            }
            
}

        function handleItemInputChange(event) {
            if (event.target.name === 'itemQuantidade' || event.target.name === 'itemPrecoUnitario') {
                const itemRow = event.target.closest('.item-row');
                if (itemRow) {
                    const itemId = itemRow.dataset.itemId;
                    calcularTotalItem(itemId);
                }
            }
        }

        function handleItemButtonClick(event) {
            // Função mantida para compatibilidade com layout antigo
            // Nova implementação usa removerItem() diretamente
            if (event.target.classList.contains('remove-item-btn')) {
                const itemRow = event.target.closest('.item-row');
                if (document.querySelectorAll('.item-row').length > 1) {
                    itemRow.remove();
                    calcularTotalGeral();
                } else {
                    showGlobalModal('Aviso', 'Não é possível remover o último item do pedido.');
                }
            }
        }

        function handleItemKeyDown(event) {
            console.log('⌨️ Tecla pressionada:', event.key, 'Target:', event.target);
            
            // Verificar se a tecla pressionada é Enter
            if (event.key === 'Enter') {
                console.log('↵ Enter detectado!');
                
                // Verificar se o elemento focado está dentro de um item-row
                const itemRow = event.target.closest('.item-row');
                if (itemRow) {
                    console.log('📦 Item row encontrado:', itemRow.dataset.itemId);
                    
                    // Prevenir comportamento padrão do Enter
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Verificar se todos os campos obrigatórios do item atual estão preenchidos
                    const descricao = itemRow.querySelector('input[name="itemDescricao"]');
                    const quantidade = itemRow.querySelector('input[name="itemQuantidade"]');
                    const unidade = itemRow.querySelector('select[name="itemUnidade"]');
                    const precoUnitario = itemRow.querySelector('input[name="itemPrecoUnitario"]');
                    
                    // Log dos valores encontrados
                    console.log('🔍 Validação dos campos:');
                    console.log('  - Descrição:', descricao?.value?.trim() || 'vazio');
                    console.log('  - Quantidade:', quantidade?.value || 'vazio');
                    console.log('  - Unidade:', unidade?.value || 'vazio');
                    console.log('  - Preço:', precoUnitario?.value || 'vazio');
                    
                    // Validar se os campos essenciais estão preenchidos
                    if (descricao && descricao.value.trim() && 
                        quantidade && quantidade.value && parseFloat(quantidade.value) > 0 &&
                        unidade && unidade.value && 
                        precoUnitario && precoUnitario.value && parseFloat(precoUnitario.value) > 0) {
                        
                        console.log('✅ Todos os campos preenchidos - adicionando novo item');
                        
                        // Adicionar novo item
                        adicionarItem();
                        
                        // Focar no campo de descrição do novo item após um pequeno delay
                        setTimeout(() => {
                            const novoItem = document.querySelector('.item-row:last-child');
                            if (novoItem) {
                                const novaDescricao = novoItem.querySelector('input[name="itemDescricao"]');
                                if (novaDescricao) {
                                    novaDescricao.focus();
                                    console.log('🎯 Foco movido para o novo item');
                                }
                            }
                        }, 100);
                    } else {
                        console.log('⚠️ Campos obrigatórios não preenchidos');
                        // Mostrar toast informando quais campos precisam ser preenchidos
                        showToast('Preencha todos os campos obrigatórios (Descrição, Quantidade > 0, Unidade e Preço > 0) antes de adicionar um novo item.', 'warning', 'Campos Obrigatórios');
                        
                        // Focar no primeiro campo vazio
                        if (!descricao?.value?.trim()) {
                            descricao?.focus();
                        } else if (!quantidade?.value || parseFloat(quantidade.value) <= 0) {
                            quantidade?.focus();
                        } else if (!unidade?.value) {
                            unidade?.focus();
                        } else if (!precoUnitario?.value || parseFloat(precoUnitario.value) <= 0) {
                            precoUnitario?.focus();
                        }
                    }
                } else {
                    console.log('❌ Item row não encontrado para o elemento focado');
                }
            }
        }

        function adicionarItem() {
            console.log('🔧 adicionarItem() chamada');
            
            // Pegar valores dos campos do formulário
            const descricao = document.getElementById('itemDescricao').value.trim();
            const produtoFornecedor = document.getElementById('itemProdutoFornecedor').value.trim();
            const quantidade = parseFloat(document.getElementById('itemQuantidade').value) || 0;
            const unidade = document.getElementById('itemUnidade').value;
            const precoUnitario = parseFloat(document.getElementById('itemPrecoUnitario').value.replace(/[^\d,-]/g, '').replace(',', '.')) || 0;
            
            // Validações
            if (!descricao) {
                showToast('Por favor, informe a descrição do item.', 'warning');
                document.getElementById('itemDescricao').focus();
                return;
            }
            
            if (quantidade <= 0) {
                showToast('A quantidade deve ser maior que zero.', 'warning');
                document.getElementById('itemQuantidade').focus();
                return;
            }
            
            if (!unidade) {
                showToast('Por favor, selecione a unidade.', 'warning');
                document.getElementById('itemUnidade').focus();
                return;
            }
            
            if (precoUnitario <= 0) {
                showToast('O preço unitário deve ser maior que zero.', 'warning');
                document.getElementById('itemPrecoUnitario').focus();
                return;
            }
            
            // Calcular subtotal
            const subtotal = quantidade * precoUnitario;
            
            // Incrementar contador
            itemCounter++;
            
            // Obter a tabela
            const tableBody = document.getElementById('itensTableBody');
            if (!tableBody) {
                console.error('❌ Tabela de itens não encontrada!');
                return;
            }
            
            // Remover linha "Nenhum item adicionado" se existir
            const noItemsRow = document.getElementById('no-items-row');
            if (noItemsRow) {
                noItemsRow.remove();
            }
            
            // Criar nova linha na tabela
            const row = document.createElement('tr');
            row.setAttribute('data-item-id', itemCounter);
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-6 py-4 text-sm text-gray-900">${descricao}</td>
                <td class="px-6 py-4 text-sm text-gray-900">${produtoFornecedor}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-center">${quantidade.toLocaleString('pt-BR')}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-center">${unidade}</td>
                <td class="px-6 py-4 text-sm text-gray-900 text-right">R$ ${precoUnitario.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="px-6 py-4 text-sm font-medium text-gray-900 text-right">R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="px-6 py-4 text-center">
                    <button type="button" class="text-red-600 hover:text-red-800 font-medium" onclick="removerItem(${itemCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            // Adicionar à tabela
            tableBody.appendChild(row);
            
            // Armazenar dados do item (para salvar posteriormente)
            if (!window.itensAdicionados) {
                window.itensAdicionados = [];
            }
            window.itensAdicionados.push({
                id: itemCounter,
                descricao: descricao,
                produto: produtoFornecedor,
                quantidade: quantidade,
                unidade: unidade,
                precoUnitario: precoUnitario,
                subtotal: subtotal
            });
            
            // Limpar formulário
            document.getElementById('itemDescricao').value = '';
            document.getElementById('itemProdutoFornecedor').value = '';
            document.getElementById('itemQuantidade').value = '1';
            document.getElementById('itemUnidade').value = 'UN'; // Voltar para UN como padrão
            document.getElementById('itemPrecoUnitario').value = '';
            document.getElementById('live-subtotal').textContent = 'R$ 0,00';
            
            // Recalcular totais
            atualizarTotaisDoPedido();
            
            // Focar no campo descrição para próximo item
            document.getElementById('itemDescricao').focus();
            
            console.log(`✅ Item ${itemCounter} adicionado à tabela com sucesso`);
        }

        function removerItem(itemId) {
            console.log('🗑️ Removendo item:', itemId);
            
            // Remover da tabela
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (row) {
                row.remove();
            }
            
            // Remover do array de itens
            if (window.itensAdicionados) {
                window.itensAdicionados = window.itensAdicionados.filter(item => item.id !== itemId);
            }
            
            // Verificar se não há mais itens e mostrar mensagem
            const tableBody = document.getElementById('itensTableBody');
            if (tableBody && tableBody.children.length === 0) {
                const noItemsRow = document.createElement('tr');
                noItemsRow.id = 'no-items-row';
                noItemsRow.innerHTML = '<td colspan="6" class="text-center text-gray-500 py-10">Nenhum item adicionado.</td>';
                tableBody.appendChild(noItemsRow);
            }
            
            // Recalcular totais
            atualizarTotaisDoPedido();
            
            console.log('✅ Item removido com sucesso');
        }
       
        function calcularTotalItem(itemId) {
            const quantidadeElement = document.getElementById(`itemQuantidade_${itemId}`);
            const precoElement = document.getElementById(`itemPrecoUnitario_${itemId}`);
            const totalElement = document.getElementById(`itemTotal_${itemId}`);
            
            if (quantidadeElement && precoElement && totalElement) {
                const quantidade = parseFloat(quantidadeElement.value) || 0;
                const precoUnitario = parseFloat(precoElement.value) || 0;
                const total = quantidade * precoUnitario;
                totalElement.value = `R$ ${total.toFixed(2).replace('.', ',')}`;
                calcularTotalGeral();
            }
        }

        function calcularTotalGeral() {
            let totalGeral = 0;
            
            // Somar com base nos itens armazenados no array
            if (window.itensAdicionados && window.itensAdicionados.length > 0) {
                totalGeral = window.itensAdicionados.reduce((total, item) => total + item.subtotal, 0);
            }
            
            // Atualizar elementos da interface
            const totalGeralElement = document.getElementById('totalGeral');
            const summaryTotalElement = document.getElementById('summary-total');
            
            if (totalGeralElement) {
                totalGeralElement.textContent = `R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
            
            if (summaryTotalElement) {
                summaryTotalElement.textContent = `R$ ${totalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }
            
            console.log('💰 Total geral calculado:', totalGeral);
        }
        
        function salvarPedido() {
            console.log('💾 Iniciando processo de salvamento do pedido...');
    
            // ==========================================================
            // ETAPA 1: COLETAR DADOS
            // ==========================================================
            const fornecedorSelect = document.getElementById('fornecedorPedido');
            const placaInput = document.getElementById('placaVeiculo');
            const perfilUsuario = localStorage.getItem('perfil');
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            
            if (!fornecedorSelect || !placaInput) { /* ... tratamento de erro ... */ return; }
            
            const selectedOption = fornecedorSelect.options[fornecedorSelect.selectedIndex];
            const grupoFornecedor = selectedOption ? selectedOption.dataset.grupo : '';

            // ==========================================================
            // ETAPA 2: A NOVA VALIDAÇÃO UNIFICADA COMEÇA AQUI
            // ==========================================================
            const camposObrigatorios = [{ id: 'fornecedorPedido', nome: 'Fornecedor' }];
            
            if (grupoFornecedor === 'OBRIGATORIO') {
                camposObrigatorios.push(
                    { id: 'placaVeiculo', nome: 'Placa do Veículo' },
                    { id: 'nomeVeiculo', nome: 'Nome do Veículo' }
                );
            } else if (grupoFornecedor === 'LIVRE') {
                camposObrigatorios.push(
                    { id: 'observacoesPedido', nome: 'Observações' }
                );
            }
            
            const camposFaltando = [];
            camposObrigatorios.forEach(campo => {
                const elemento = document.getElementById(campo.id);
                if (elemento && (!elemento.value || elemento.value.trim() === '')) {
                    camposFaltando.push(campo.nome);
                }
            });
            
            if (camposFaltando.length > 0) {
                showGlobalModal('Erro de Validação', `Por favor, preencha os campos obrigatórios: ${camposFaltando.join(', ')}`);
                return; 
            }

            // Validação de formato da placa (se preenchida)
            if (placaInput.value.trim() && placaInput.classList.contains('invalid')) {
                if (perfilUsuario !== 'admin') {
                    showToast('O formato da placa informada é inválido. Por favor, corrija.', 'error', 'Placa Inválida');
                    placaInput.focus();
                    return;
                } else {
                    console.warn(`⚠️ Admin salvando pedido com placa inválida: "${placaInput.value}"`);
                }
            }

            // ==========================================================
            // FIM DA NOVA VALIDAÇÃO.
            // ==========================================================

            // Coletar itens usando o array de itens adicionados
            const itens = [];
            if (window.itensAdicionados && window.itensAdicionados.length > 0) {
                window.itensAdicionados.forEach(item => {
                    itens.push({
                        descricao: item.descricao,
                        produtoFornecedor: item.produtoFornecedor,
                        quantidade: item.quantidade,
                        unidade: item.unidade,
                        precoUnitario: item.precoUnitario,
                        totalItem: item.subtotal                    
                    });
                });
            }

            if (itens.length === 0) {
                showGlobalModal('Erro', 'Adicione pelo menos um item ao pedido.');
                return;
            }

            // Desabilitar botão para evitar duplo clique
            const salvarButton = document.getElementById('salvarPedidoButton');
            if (salvarButton) {
                salvarButton.disabled = true;
                salvarButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando pedido e Gerando número...';
            }
            
            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
            const idDaEmpresa = empresaAtual.id || empresaAtual.codigo;
            
            // Debug: Verificar dados da empresa no salvamento
            console.log('🔍 Debug SavePedido - Empresa atual:', empresaAtual);
            console.log('🔍 Debug SavePedido - ID da empresa:', idDaEmpresa);
            
            if (!idDaEmpresa) {
                showToast('Erro: Não foi possível identificar a empresa. Faça login novamente.', 'error');
                if (salvarButton) {
                    salvarButton.disabled = false;
                    salvarButton.innerHTML = '<i class="fas fa-check mr-2"></i>Finalizar e Salvar Pedido';
                }
                return;
            }
            
            // Primeiro, gerar o número do pedido
            google.script.run
                .withSuccessHandler(response => {
                    console.log('📋 Resposta da geração de número:', response);
                    
                    // Verificar se o número foi gerado corretamente
                    let numeroPedido;
                    if (typeof response === 'string' || typeof response === 'number') {
                        numeroPedido = response.toString();
                    } else if (response && (response.numero || response.numeroPedido)) {
                        numeroPedido = (response.numero || response.numeroPedido).toString();
                    } else {
                        console.error('❌ Formato de resposta inesperado para número do pedido:', response);
                        showToast('Erro ao gerar número do pedido. Formato de resposta inválido.', 'error', 'Erro de Numeração');
                        if (salvarButton) {
                            salvarButton.disabled = false;
                            salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Pedido';
                        }
                        return;
                    }
                    
                    console.log('📋 Número do pedido processado:', numeroPedido);
                    
                    // Verificar se o número é válido
                    if (!numeroPedido || numeroPedido === 'undefined' || numeroPedido === 'null') {
                        console.error('❌ Número do pedido inválido:', numeroPedido);
                        showToast('Erro: Número do pedido inválido gerado pelo sistema.', 'error', 'Erro de Numeração');
                        if (salvarButton) {
                            salvarButton.disabled = false;
                            salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Pedido';
                        }
                        return;
                    }
                    
                    // Atualizar o campo visual
                    const numeroPedidoElement = document.getElementById('numeroPedido');
                    if (numeroPedidoElement) {
                        numeroPedidoElement.value = numeroPedido;
                    }
                    
                    // Atualizar status do botão
                    if (salvarButton) {
                        salvarButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
                    }
                    
                    // VERIFICAÇÃO FINAL antes de montar os dados
                    console.log('🔍 VERIFICAÇÃO FINAL - numeroPedido antes de montar dados:', numeroPedido);
                    console.log('🔍 VERIFICAÇÃO FINAL - tipo da variável:', typeof numeroPedido);
                    
                    // Calcular o total geral dos itens
                    const totalGeral = itens.reduce((total, item) => total + item.totalItem, 0);
                    console.log('💰 Total geral calculado para salvamento:', totalGeral);
                    
                    // Montar dados do pedido com o número gerado
                    const dataParaSalvar = document.getElementById('dataPedido')?.value || '';
                    console.log('📅 Data que será enviada para salvamento:', dataParaSalvar);
                    console.log('📅 Hora atual local:', obterDataHoraLocal());
                    
                    // Converter data do campo para data/hora completa local
                    let dataCompleta = dataParaSalvar;
                    if (dataParaSalvar && !dataParaSalvar.includes(':')) {
                        // Se é só data (YYYY-MM-DD), adicionar hora atual
                        const agora = new Date();
                        const hora = String(agora.getHours()).padStart(2, '0');
                        const minuto = String(agora.getMinutes()).padStart(2, '0');
                        const segundo = String(agora.getSeconds()).padStart(2, '0');
                        dataCompleta = `${dataParaSalvar} ${hora}:${minuto}:${segundo}`;
                        console.log('📅 Data convertida para hora completa:', dataCompleta);
                    }
                    
                    const valorImpostoTexto = document.getElementById('valor-imposto')?.textContent || 'R$ 0,00';

                    // Converte o texto (ex: "R$ 1.234,56") para um número puro (ex: 1234.56)
                    const valorImpostoNumerico = parseFloat(
                        valorImpostoTexto
                            .replace('R$', '')      // Remove o "R$"
                            .replace(/\./g, '')     // Remove o separador de milhar
                            .replace(',', '.')      // Troca a vírgula do decimal por ponto
                    ) || 0;

                    const dadosPedido = {
                        numeroPedido: String(numeroPedido), // Garantir que é string
                        data: dataCompleta,
                        fornecedor: document.getElementById('fornecedorPedido')?.value || '',
                        nomeVeiculo: document.getElementById('nomeVeiculo')?.value || '',
                        placaVeiculo: document.getElementById('placaVeiculo')?.value || '',
                        observacoes: document.getElementById('observacoesPedido')?.value || '',
                        produtoFornecedor: document.getElementById('produtoFornecedor')?.value || '',
                        empresaId: idDaEmpresa,
                        totalGeral: totalGeral, // Incluir o total geral calculado
                        valorIcms: valorImpostoNumerico, 
                        itens: itens
                                               
                    };
                    
                    // Forçar atribuição se por algum motivo não funcionou
                    if (!dadosPedido.numeroPedido || dadosPedido.numeroPedido === 'undefined') {
                        dadosPedido.numeroPedido = String(numeroPedido);
                        console.warn('⚠️ Forçando atribuição do numeroPedido:', dadosPedido.numeroPedido);
                    }

                    console.log('📋 Dados do pedido montados:', dadosPedido);
                    console.log('📋 Número do pedido para salvamento:', numeroPedido);
                    console.log('🔍 VERIFICAÇÃO CRÍTICA - dadosPedido.numeroPedido:', dadosPedido.numeroPedido);
                    console.log('🔍 ENVIANDO PARA BACKEND - Objeto completo:', JSON.stringify(dadosPedido, null, 2));
                    
                    // Verificação final antes do envio
                    if (!dadosPedido.numeroPedido || dadosPedido.numeroPedido === 'undefined') {
                        console.error('❌ ERRO CRÍTICO: numeroPedido está undefined no dadosPedido!');
                        showToast('Erro crítico: Número do pedido perdido. Tentando novamente...', 'error');
                        if (salvarButton) {
                            salvarButton.disabled = false;
                            salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Pedido';
                        }
                        return;
                    }

                    // Agora salvar o pedido
                    google.script.run
                        .withSuccessHandler(response => {
                            console.log('📋 Resposta do salvamento:', response);
                            
                            // Verificar diferentes formatos de resposta
                            if (response && (response.status === 'success' || response.status === 'ok')) {
                                // Backend retornou sucesso, mas pode ter o bug do "undefined"
                                const mensagem = response.message || '';
                                
                                if (mensagem.includes('undefined')) {
                                    console.warn('⚠️ Backend retornou "undefined" na mensagem, mas salvou com sucesso');
                                    showToast(`Pedido ${numeroPedido} salvo com sucesso! (corrigindo mensagem do backend)`, 'success', 'Pedido Criado');
                                } else {
                                    // Tentar obter o número do pedido de diferentes formas
                                    const numeroFinal = response.numeroPedido || response.numero || numeroPedido;
                                    showToast(`Pedido ${numeroFinal} salvo com sucesso!`, 'success', 'Pedido Criado');
                                }
                                
                                setTimeout(() => {
                                    loadPageContent('Menu', setupMenuScreen);
                                }, 2000);
                            } else if (typeof response === 'string' && response.includes('sucesso')) {
                                // Se a resposta for uma string de sucesso
                                if (response.includes('undefined')) {
                                    showToast(`Pedido ${numeroPedido} salvo com sucesso! (corrigindo backend)`, 'success', 'Pedido Criado');
                                } else {
                                    showToast(`Pedido ${numeroPedido} salvo com sucesso!`, 'success', 'Pedido Criado');
                                }
                                google.script.run.limparPlanilhaDeCalculo();
                                setTimeout(() => {
                                    loadPageContent('Menu', setupMenuScreen);
                                }, 2000);
                            } else {
                                // Erro no salvamento
                                const mensagemErro = response?.message || response || 'Erro desconhecido no salvamento';
                                showToast('Erro ao salvar: ' + mensagemErro, 'error', 'Falha no Salvamento');
                                console.error('❌ Erro detalhado no salvamento:', response);
                            }
                            
                            if (salvarButton) {
                                salvarButton.disabled = false;
                                salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Pedido';
                            }
                        })
                        .withFailureHandler(err => {
                            showToast('Erro de comunicação: ' + err.message, 'error', 'Falha na Conexão');
                            if (salvarButton) {
                                salvarButton.disabled = false;
                                salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Pedido';
                            }
                        })
                        .salvarPedido(dadosPedido, usuarioLogado);
                })
                .withFailureHandler(err => {
                    console.error('Erro ao gerar número do pedido:', err);
                    showToast('Erro ao gerar número do pedido: ' + err.message, 'error', 'Erro de Numeração');
                    if (salvarButton) {
                        salvarButton.disabled = false;
                        salvarButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Pedido';
                    }
                })
                .getProximoNumeroPedido(idDaEmpresa);
        }

        // ===============================================
        // FUNÇÃO PARA SALVAR RASCUNHO
        // ===============================================
        function salvarRascunho() {
            console.log('📝 Iniciando salvamento de rascunho...');
            
            // Validações mínimas para rascunho (apenas fornecedor e pelo menos 1 item)
            const fornecedorSelect = document.getElementById('fornecedorPedido');
            
            if (!fornecedorSelect.value) {
                showToast('Selecione um fornecedor para salvar o rascunho.', 'warning', 'Validação');
                fornecedorSelect.focus();
                return;
            }

            // Verificar se há pelo menos um item adicionado
            if (!window.itensAdicionados || window.itensAdicionados.length === 0) {
                showToast('Adicione pelo menos um item com descrição para salvar o rascunho.', 'warning', 'Validação');
                return;
            }

            // Desabilitar botão para evitar duplo clique
            const rascunhoButton = document.getElementById('salvarRascunhoButton');
            if (rascunhoButton) {
                rascunhoButton.disabled = true;
                rascunhoButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
            }

            // Coletar dados do rascunho usando o array de itens
            const itens = window.itensAdicionados.map(item => ({
                descricao: item.descricao,
                produtoFornecedor: item.produtoFornecedor,
                quantidade: item.quantidade,
                unidade: item.unidade,
                precoUnitario: item.precoUnitario,
                totalItem: item.subtotal
                
            }));

            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
            
            // Debug: Verificar dados da empresa
            console.log('🔍 Debug - Empresa atual:', empresaAtual);
            console.log('🔍 Debug - ID da empresa:', empresaAtual.id);
            console.log('🔍 Debug - Código da empresa:', empresaAtual.codigo);
            
            // Usar id ou codigo como fallback
            const empresaId = empresaAtual.id || empresaAtual.codigo;
            if (!empresaId) {
                showToast('Erro: Não foi possível identificar a empresa. Faça login novamente.', 'error');
                return;
            }

            console.log('🔍 Debug - ID da empresa usado:', empresaId);
            
            // Calcular total geral dos itens
            const totalGeral = window.itensAdicionados ? 
                window.itensAdicionados.reduce((total, item) => total + item.subtotal, 0) : 0;
            
            console.log('💰 Debug - Total geral calculado:', totalGeral);

            const valorImpostoTexto = document.getElementById('valor-imposto')?.textContent || 'R$ 0,00';
            const valorImpostoNumerico = parsefloat(valorImpostoTexto.repacle('R$', '').replace (/\./g, '').replace(',', '.')) || 0;

            // Verificar se estamos editando um rascunho existente
            const editandoRascunho = localStorage.getItem('editandoRascunho') === 'true';
            const rascunhoId = localStorage.getItem('rascunhoId');
            
            console.log('🔄 Modo edição:', editandoRascunho);
            console.log('🔄 ID do rascunho:', rascunhoId);
            
            // Dados do rascunho
            const dadosRascunho = {
                data: document.getElementById('dataPedido')?.value || '',
                fornecedor: fornecedorSelect.value,
                nomeVeiculo: document.getElementById('nomeVeiculo')?.value || '',
                placaVeiculo: document.getElementById('placaVeiculo')?.value || '',
                observacoes: document.getElementById('observacoesPedido')?.value || '',
                empresa: empresaId,
                itens: itens,
                totalGeral : totalGeral,
                valorIcms: valorImpostoNumerico,
                status: 'RASCUNHO',
                dataUltimaEdicao: obterDataHoraLocal()
                
            };
            
            // Se estiver editando, incluir o ID do rascunho
            if (editandoRascunho && rascunhoId) {
                dadosRascunho.rascunhoId = rascunhoId;  // Usar 'rascunhoId' em vez de 'id'
                console.log('📝 Atualizando rascunho existente:', rascunhoId);
            } else {
                console.log('📝 Criando novo rascunho');
            }

            // Debug: Mostrar dados que serão enviados
            console.log('📤 Debug - Dados do rascunho a serem enviados:', dadosRascunho);
            console.log('📤 Debug - Quantidade de itens:', itens.length);
            console.log('📤 Debug - Empresa ID final:', empresaId);

            // Salvar rascunho no backend
            google.script.run
                .withSuccessHandler(response => {
                    console.log('✅ Resposta do backend:', response);
                    if (response.status === 'success') {
                        const isEdicao = editandoRascunho && rascunhoId;
                        const mensagem = isEdicao ? 
                            `Rascunho atualizado com sucesso! ID: ${rascunhoId}` :
                            `Rascunho salvo com sucesso! ID: ${response.rascunhoId}`;
                        
                        showToast(mensagem, 'success', 'Rascunho Salvo');
                        
                        // Mostrar indicador de rascunho na tela
                        const draftStatus = document.getElementById('draft-status');
                        if (draftStatus) {
                            draftStatus.classList.remove('hidden');
                            const idFinal = isEdicao ? rascunhoId : response.rascunhoId;
                            draftStatus.innerHTML = `<i class="fas fa-edit mr-2"></i>Rascunho - ID: ${idFinal}`;
                        }
                        
                        // Salvar ID do rascunho para futuras edições
                        const idParaSalvar = isEdicao ? rascunhoId : response.rascunhoId;
                        localStorage.setItem('rascunhoAtual', idParaSalvar);
                        
                        // Marcar que agora está em modo de edição
                        if (!isEdicao) {
                            localStorage.setItem('editandoRascunho', 'true');
                            localStorage.setItem('rascunhoId', response.rascunhoId);
                        }
                        
                    } else {
                        showToast('Erro ao salvar rascunho: ' + response.message, 'error', 'Falha no Salvamento');
                    }
                    
                    // Reabilitar botão
                    if (rascunhoButton) {
                        rascunhoButton.disabled = false;
                        rascunhoButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Rascunho';
                    }
                })
                .withFailureHandler(err => {
                    console.error('❌ Erro detalhado ao salvar rascunho:', err);
                    console.error('❌ Tipo do erro:', typeof err);
                    console.error('❌ Erro stringify:', JSON.stringify(err));
                    
                    // Tentar extrair mais informações do erro
                    const errorMessage = err.message || err.toString() || 'Erro desconhecido';
                    showToast('Erro ao salvar rascunho: ' + errorMessage, 'error', 'Falha no Salvamento');
                    
                    if (rascunhoButton) {
                        rascunhoButton.disabled = false;
                        rascunhoButton.innerHTML = '<i class="fas fa-save mr-2"></i>Salvar Rascunho';
                    }
                })
                .salvarRascunho(dadosRascunho);
        }

        // ===============================================
        // LÓGICA DA PÁGINA MEUS PEDIDOS
         // ===============================================
         function setupMeusPedidosScreen() {
        const tabelaBody = document.getElementById('tabela-meus-pedidos');
        const usuarioLogado = localStorage.getItem('usuarioLogado');

        if (!tabelaBody || !usuarioLogado) {
            console.error("Não foi possível carregar a tela 'Meus Pedidos'. Elementos faltando ou usuário não logado.");
            return;
        }

        google.script.run
            .withSuccessHandler(response => {
                    if (!response) {
                      console.error("Erro fatal: A resposta do backend foi nula. Verifique os logs do Apps Script para a função 'getMeusPedidosAprovados'.");
                      tabelaBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Ocorreu um erro crítico ao comunicar com o servidor.</td></tr>`;
                      return;
                  }
                if (response.status === 'success' && response.data.length > 0) {
                    tabelaBody.innerHTML = ''; // Limpa o "carregando"
                    response.data.forEach(pedido => {
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-gray-50';
                        
                        // ATENÇÃO: Os nomes das propriedades (ex: pedido['Número_do_Pedido'])
                        // devem bater EXATAMENTE com os cabeçalhos da sua planilha.
                        const numeroPedido = pedido['Número_do_Pedido'] || pedido['numeroDoPedido'] || 'N/D';
                        const dataPedido = new Date(pedido['Data']).toLocaleDateString('pt-BR');
                        const fornecedor = pedido['Fornecedor'] || 'N/D';
                        const empresaId = pedido['Empresa'] || '';
                        const empresaObj = AppCache.userCompanies.find(c => c.id == empresaId);
                        const empresaNome = empresaObj ? empresaObj.nome : 'N/D';
                        const valorBruto = pedido['Total Geral'] || pedido['Valor'] || 0;
                        const valorTotal = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorBruto);

                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium text-gray-900">${numeroPedido}</td>
                            <td class="px-6 py-4">${dataPedido}</td>
                            <td class="px-6 py-4">${fornecedor}</td>
                            <td class="px-6 py-4">${empresaNome}</td>
                            <td class="px-6 py-4 text-right font-semibold">${valorTotal}</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="visualizarPedidoExistente('${numeroPedido}', '${empresaId}', '${empresaNome}', 'meus-pedidos')" class="font-medium text-blue-600 hover:underline">Visualizar</button>
                            </td>
                        `;
                        tabelaBody.appendChild(row);
                    });
                } else {
                    tabelaBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center p-8">
                                <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                                <p class="text-gray-500">Você ainda não tem pedidos aprovados.</p>
                            </td>
                        </tr>
                    `;
                }
            })
            .withFailureHandler(error => {
                console.error("Erro ao buscar 'Meus Pedidos Aprovados':", error);
                tabelaBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Ocorreu um erro ao carregar seus pedidos.</td></tr>`;
            })
            .getMeusPedidosAprovados(usuarioLogado);
    } 

        // ===============================================
        // LÓGICA DA PÁGINA DE CADASTRO DE FORNECEDOR
        // ===============================================
        function setupCadastroFornecedorScreen(codigoFornecedor) {
            // Guarda de proteção
            if (!document.getElementById('form-fornecedor')) {
                console.warn('Formulário de fornecedor não encontrado');
                return;
            }
            const grupoContainer = document.getElementById('grupo-container');
            console.log("Inicializando a página de Cadastro/Edição de Fornecedor...");

            // --- CONFIGURAÇÃO DOS BOTÕES PRINCIPAIS ---
            const saveButton = document.getElementById('saveButton');
            const cancelButton = document.getElementById('cancelButton');
            const consultarCnpjBtn = document.getElementById('consultarCnpjBtn');

            if (saveButton) {
                saveButton.onclick = function(e) {
                    e.preventDefault();
                    salvarFornecedor(codigoFornecedor);
                };
            }

            if (cancelButton) {
            cancelButton.onclick = function() {
            // Verifica se está em modo de edição (se um código foi passado para a função)
            if (codigoFornecedor) {
                // Se sim, volta para a lista de fornecedores
                console.log("Cancelando edição, voltando para a lista.");
                loadPageContent('GerenciarFornecedores', setupGerenciarFornecedoresScreen);
            } else {
                // Se não (modo de criação), volta para o menu principal
                console.log("Cancelando novo cadastro, voltando para o menu.");
                loadPageContent('Menu', setupMenuScreen);
            }
          };
        }

            if (consultarCnpjBtn) {
                consultarCnpjBtn.addEventListener('click', handleConsultarCnpj);
            }

            // Carregar combos e estados
            preencherCombosFornecedor();
            carregarEstados();

            const form = document.getElementById('form-fornecedor');
            // --- Força maiúsculas nos campos texto ---
            document.querySelectorAll('#form-fornecedor input[type="text"], #form-fornecedor textarea').forEach(input => {
                input.addEventListener('blur', forceUppercase);
            });

            // --- Máscara e validação do CNPJ ---
            const cnpjInput = document.getElementById('cnpj');
            if (cnpjInput) {
                cnpjInput.addEventListener('input', (e) => {
                    e.target.value = formatarCpfCnpj(e.target.value);
                });
                cnpjInput.addEventListener('blur', (e) => {
                    const cnpjDigitado = e.target.value;
                    if (cnpjDigitado) {
                        const isValid = validarCnpj(cnpjDigitado);
                        e.target.classList.toggle('valid', isValid);
                        e.target.classList.toggle('invalid', !isValid);
                    } else {
                        e.target.classList.remove('valid', 'invalid');
                    }
                });
            }

            // --- Limpa campos ou carrega dados para edição ---
            if (codigoFornecedor) {
              console.log("Modo Edição: Mostrando campo 'Grupo'");
                //if (grupoContainer) grupoContainer.classList.remove('hidden'); // MOSTRA O CAMPO
                showToast('Carregando dados do fornecedor...', 'info');
                google.script.run
                    .withSuccessHandler(fornecedor => {
                        if (fornecedor) {
                            console.log("DADOS DO FORNECEDOR RECEBIDOS:", fornecedor); 
                            document.getElementById('codigo').value   = fornecedor.id   || '';
                            console.log("Codigo preenchido com:", fornecedor.id);
                            document.getElementById('razao').value    = fornecedor.razaoSocial  || '';
                            console.log("Razap Social preenchido com:", fornecedor.razaoSocial);
                            document.getElementById('fantasia').value = fornecedor.nomeFantasia || '';
                            console.log("fantasia preenchido com:", fornecedor.nomeFantasia);
                            document.getElementById('cnpj').value     = fornecedor.cnpj     || '';
                            console.log("CNPJ preenchido com:", fornecedor.cnpj);
                            document.getElementById('endereco').value = fornecedor.endereco || '';
                            console.log("Endereço preenchido com:", fornecedor.endereco);
                            document.getElementById('estado').value   = fornecedor.estado   || '';
                            console.log("estado preenchido com:", fornecedor.estado);
                            document.getElementById('cidade').value = fornecedor.cidade     || '';
                            console.log("cidade preenchido com:", fornecedor.cidade);
                            document.getElementById('condicao').value = fornecedor.condicaoDePagamento || '';
                            console.log("condicao preenchido com:", fornecedor.condicaoDePagamento);
                            document.getElementById('forma').value    = fornecedor.formaDePagamento || '';
                            console.log("forma preenchido com:", fornecedor.formaDePagamento);
                            document.getElementById('grupo').value    = fornecedor.grupo || '';
                            console.log("grupo preenchido com:", fornecedor.grupo);

                            const grupoContainer = document.getElementById('grupo-container');
                            if (grupoContainer) {
                                grupoContainer.classList.remove('hidden');
                            }

                        } else {
                            showToast('Fornecedor não encontrado!', 'error');
                        }
                    })
                    .withFailureHandler(err => {
                        showToast('Erro ao carregar fornecedor', 'error');
                    })
                    .obterFornecedorPorCodigo(codigoFornecedor);
            } else {
                 // ***** MODO NOVO CADASTRO *****
                // Se nenhum código foi passado, estamos criando um novo.

                // 1. Limpa todos os campos do formulário
                if (form) form.reset();
                
                // 2. Garante que o campo 'grupo' esteja escondido
                const grupoContainer = document.getElementById('grupo-container');
                if (grupoContainer) grupoContainer.classList.add('hidden');

                // 3. AGORA SIM: Chama a função para buscar o próximo código disponível
                showToast('Gerando novo código...', 'info');
                google.script.run
                    .withSuccessHandler(novoCodigo => {
                        if (novoCodigo) {
                            document.getElementById('display-codigo').value = novoCodigo;
                        }
                    })
                    .withFailureHandler(err => {
                        console.error("Erro ao buscar próximo código:", err);
                        showToast("Erro ao gerar novo código.", "error");
                    })
                    .getProximoCodigoFornecedor(); // <-- CHAMADA NO LUGAR CERTO
            }
        }

          // Função para carregar estados dinamicamente do backend
        function carregarEstados() {
            const estadoSelect = document.getElementById('estado');
            if (!estadoSelect) return;

            // Mostrar loading
            estadoSelect.innerHTML = '<option value="">Carregando estados...</option>';

            google.script.run
                .withSuccessHandler(estados => {
                    console.log('[carregarEstados] Estados recebidos:', estados);
                    populateSelect('estado', estados, 'Selecione o Estado');
                })
                .withFailureHandler(error => {
                    console.error('[carregarEstados] Erro ao buscar estados:', error);
                    showToast('Erro ao carregar estados.', 'error', 'Erro');
                  populateSelect('estado', estadosLocal, 'Selecione o Estado');
                })
                .getEstadosv2();
        }


        function setupBuscaScreen() {
            console.log('🔧 Inicializando nova tela de busca de pedidos...');
            
            // Elementos da nova interface
            const searchButton = document.getElementById('searchButton');
            const mainSearch = document.getElementById('mainSearch');
            const backButton = document.getElementById('backToMenuFromSearchButton');
            const toggleAdvancedBtn = document.getElementById('toggleAdvancedFilters');
            const advancedFiltersDiv = document.getElementById('advancedFilters');
            const clearFiltersButton = document.getElementById('clearFiltersButton');
            const dateStart = document.getElementById('dateStart');
            const dateEnd = document.getElementById('dateEnd');
            const plateSearch = document.getElementById('plateSearch');
            const userSearch = document.getElementById('userSearch');
            const resultsBody = document.getElementById('searchResultsBody');
            const filtroAdminContainer = document.getElementById('filtro-admin-usuario');

            const perfil = (localStorage.getItem('perfil') || '').toLowerCase();

            // --- LÓGICA DE VISIBILIDADE PARA ADMIN ---
            if (perfil === 'admin' && filtroAdminContainer) {
                filtroAdminContainer.classList.remove('hidden');
            }

             // --- Função Principal de Busca ---
            const realizarBuscaAvancada = () => {
              // Pega a empresa atual do localStorage para filtrar a busca
                const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
                // --- CORREÇÃO APLICADA AQUI para ser mais robusto ---
                const empresaId = empresaAtual.id || empresaAtual.codigo || '';
                
                if (!empresaId) {
                    showGlobalModal("Erro", "Empresa não selecionada. Por favor, volte ao menu e selecione uma empresa.");
                    return;
                }
                // Monta o objeto de parâmetros para o backend
                const params = {
                  empresaId: empresaId,
                    mainSearch: mainSearch.value.trim(),
                    dateStart: dateStart.value,
                    dateEnd: dateEnd.value,
                    plateSearch: plateSearch.value.trim(),
                    usuarioCriador: (perfil === 'admin' && userSearch) ? userSearch.value.trim() : ''
                };

                 console.log("Enviando para o backend os seguintes parâmetros de busca:", params);

            // Feedback visual de carregamento
                resultsBody.innerHTML = `<tr><td colspan="6" class="text-center p-8"><div class="spinner mx-auto"></div></td></tr>`;
                searchButton.disabled = true;
                searchButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando...';

                google.script.run
                    .withSuccessHandler(response => {
                      console.log("Resposta recebida do backend:", response);

                        searchButton.disabled = false;
                        searchButton.innerHTML = '<i class="fas fa-search mr-2"></i>Buscar';
                        if (response.status === 'success' && response.data.length > 0) {
                            preencherTabelaBusca(response.data, resultsBody);
                        } else {
                            resultsBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhum pedido encontrado.</td></tr>`;
                        }
                    })
                    .withFailureHandler(err => {
                        searchButton.disabled = false;
                        searchButton.innerHTML = '<i class="fas fa-search mr-2"></i>Buscar';
                        resultsBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Erro ao realizar a busca.</td></tr>`;
                        console.error("Erro ao buscar pedidos:", err);
                    })
                    .buscarPedidosv2(params);
            };
            
            // Event listener para busca principal
            if (searchButton) {
                searchButton.addEventListener('click', realizarBuscaAvancada);
            }

            if (mainSearch) {
                mainSearch.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        realizarBuscaAvancada();
                    }
                });
            }

            // Toggle filtros avançados
            if (toggleAdvancedBtn && advancedFiltersDiv) {
                toggleAdvancedBtn.addEventListener('click', () => {
                    advancedFiltersDiv.classList.toggle('hidden');
                    const icon = toggleAdvancedBtn.querySelector('i');
                    if (icon) icon.classList.toggle('rotate-180');
                });
            }

            // Limpar filtros
            if (clearFiltersButton) {
                clearFiltersButton.addEventListener('click', () => {
                    if (mainSearch) mainSearch.value = '';
                    if (dateStart) dateStart.value = '';
                    if (dateEnd) dateEnd.value = '';
                    if (plateSearch) plateSearch.value = '';
                    if (userSearch) userSearch.value = '';
                    
                    // Mostrar mensagem inicial em vez de buscar
                    if (resultsBody) {
                        resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-12"><div class="flex flex-col items-center"><i class="fas fa-search fa-3x mb-4 text-gray-300"></i><p class="text-lg font-medium">Use os filtros acima para buscar pedidos</p><p class="text-sm text-gray-400 mt-2">Digite um número de pedido, nome do fornecedor ou use os filtros avançados</p></div></td></tr>';
                    }
                    
                    showToast('Filtros limpos', 'success');
                });
            }

            // Voltar ao menu
            if (backButton) {
                backButton.addEventListener('click', () => {
                    loadPageContent('Menu', setupMenuScreen);
                });
            }

            // Configurar modal de impressão
            setupPrintModal();
            
            // Mostrar mensagem inicial em vez de carregar todos os pedidos
            //if (resultsBody) {
            //    resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-12"><div class="flex flex-col items-center"><i class="fas fa-search fa-3x mb-4 text-gray-300"></i><p class="text-lg font-medium">Use os filtros acima para buscar pedidos</p><p class="text-sm text-gray-400 mt-2">Digite um número de pedido, nome do fornecedor ou use os filtros avançados</p></div></td></tr>';
            }
        //}

        // --- Variáveis Globais (para os gráficos) ---
    let monthlyChart;
    let suppliersChart;

    // --- Função Principal de Setup do Dashboard ---
    function setupDashboardScreen() {
       console.log("--- Iniciando setupDashboardScreen ---");
        // Obter a empresa logada do localStorage
        const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
        const nomeEmpresaElement = document.getElementById('nomeEmpresa');
        const rawEmpresa = localStorage.getItem('empresaSelecionada');
        console.log("Conteúdo bruto do localStorage 'empresaSelecionada':", rawEmpresa);

        // Tente parsear o JSON
    //let empresaAtual = {};
    //try {
      //  empresaAtual = JSON.parse(rawEmpresa || '{}');
      //  console.log("Objeto empresaAtual (parseado):", empresaAtual);
     //   console.log("Valor de empresaAtual.nome:", empresaAtual.nome);
     //   console.log("Valor de empresaAtual.id:", empresaAtual.id); // Verifique também o ID!
   // } catch (e) {
   //     console.error("Erro ao parsear JSON de empresaSelecionada do localStorage:", e);
   // }

    if (nomeEmpresaElement && empresaAtual.nome) {
    nomeEmpresaElement.textContent = empresaAtual.empresa; 
    console.log("Nome da empresa definido no HTML:", empresaAtual.nome);
      } else if (nomeEmpresaElement) {
          nomeEmpresaElement.textContent = 'Empresa não definida';
          console.log("Nome da empresa não encontrado em empresaAtual.nome. Definido como 'Empresa não definida'.");
      }
    console.log("--- Fim da verificação de empresa no setupDashboardScreen ---");

        

        // Referências aos elementos HTML
        const totalGastoElem = document.getElementById('totalGasto');
        const totalPedidosElem = document.getElementById('totalPedidos');
        const ticketMedioElem = document.getElementById('ticketMedio');
        const recentOrdersTableBody = document.getElementById('recentOrdersTableBody');
        const iaSuggestionsDiv = document.getElementById('iaSuggestions');
        
        const supplierSelect = document.getElementById('supplier');
        const stateSelect = document.getElementById('state');
        const dateStartInput = document.getElementById('dateStart');
        const dateEndInput = document.getElementById('dateEnd');
        const applyFiltersButton = document.getElementById('applyFiltersButton');
        const clearFiltersButton = document.getElementById('clearFiltersButton');

        // --- Funções de Carregamento de Dados ---

        // Carrega todos os dados do dashboard do Apps Script
        function loadDashboardData(filters = {}) {
            showToast('Buscando dados do dashboard...', 'info', 'Carregando...');

            // Adiciona a empresa logada aos filtros
            const currentFilters = { ...filters, empresa: empresaAtual };

            google.script.run
                .withSuccessHandler(function(data) {
                    if (data.status === 'error') {
                        showToast('error', 'Erro no Backend!', data.message || 'Falha ao carregar dados do dashboard.');
                        return;
                    }

                    // Preencher Indicadores
                    totalGastoElem.textContent = data.totalGasto || 'N/A';
                    totalPedidosElem.textContent = data.totalPedidos || 'N/A';
                    ticketMedioElem.textContent = data.ticketMedio || 'N/A';

                    // Atualizar Gráfico de Pedidos e Gastos por Mês
                    if (monthlyChart) monthlyChart.destroy();
                    const monthlyCtx = document.getElementById('monthlyAnalysisChart').getContext('2d');
                    monthlyChart = new Chart(monthlyCtx, {
                        type: 'line',
                        data: {
                            labels: data.monthlyLabels || [],
                            datasets: [
                                { label: 'Nº de Pedidos', data: data.monthlyPedidosData || [], borderColor: '#3b82f6', yAxisID: 'y' },
                                { label: 'Gasto Mensal (R$)', data: data.monthlyGastosData || [], borderColor: '#f97316', yAxisID: 'y1' }
                            ]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            scales: {
                                y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Nº de Pedidos' } },
                                y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Gasto (R$)' }, grid: { drawOnChartArea: false } }
                            }
                        }
                    });

                    // Atualizar Gráfico de Top Fornecedores
                    if (suppliersChart) suppliersChart.destroy();
                    const suppliersCtx = document.getElementById('topSuppliersChart').getContext('2d');
                    suppliersChart = new Chart(suppliersCtx, {
                        type: 'bar',
                        data: {
                            labels: data.topSuppliersLabels || [],
                            datasets: [{
                                label: 'Valor Gasto (R$)',
                                data: data.topSuppliersValues || [],
                                backgroundColor: ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#dbeafe'],
                            }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });

                    // Preencher Tabela de Pedidos Recentes
                    recentOrdersTableBody.innerHTML = '';
                    if (data.recentOrders && data.recentOrders.length > 0) {
                        data.recentOrders.forEach(order => {
                            const row = document.createElement('tr');
                            if (order.status === 'Cancelado') {
                                row.classList.add('canceled-row');
                            }
                            row.innerHTML = `
                                <td class="px-4 py-3 font-medium">${order.id || ''}</td>
                                <td class="px-4 py-3">${order.supplier || ''}</td>
                                <td class="px-4 py-3 text-right">${order.value || ''}</td>
                                <td class="px-4 py-3 text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${order.statusClass || ''}">${order.status || ''}</span></td>
                            `;
                            recentOrdersTableBody.appendChild(row);
                        });
                    } else {
                        recentOrdersTableBody.innerHTML = '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">Nenhum pedido recente encontrado.</td></tr>';
                    }

                    // Preencher Análise e Sugestões da IA
                    iaSuggestionsDiv.innerHTML = '';
                    if (data.iaSuggestions && data.iaSuggestions.length > 0) {
                        data.iaSuggestions.forEach(suggestion => {
                            const div = document.createElement('div');
                            div.className = `flex items-start space-x-3`;
                            div.innerHTML = `
                                <i class="fas ${suggestion.icon || 'fa-info-circle'} mt-1 ${suggestion.color || 'text-gray-500'}"></i>
                                <p>${suggestion.text || ''}</p>
                            `;
                            iaSuggestionsDiv.appendChild(div);
                        });
                    } else {
                        iaSuggestionsDiv.innerHTML = '<div class="text-gray-500">Nenhuma sugestão de IA disponível.</div>';
                    }

                    showToast('Dados do dashboard carregados', 'success', 'Sucesso!');
                })
                .withFailureHandler(function(error) {
                    console.error('Erro ao carregar dados do dashboard:', error);
                    showToast('error', 'Erro!', 'Falha ao carregar dados do dashboard. ' + (error.message || error));
                })
                .getDashboardData(currentFilters);
        }

        // Popula o select de fornecedores usando getFornecedoresListv2()
        function populateSuppliersFilter() {
            google.script.run
                .withSuccessHandler(function(fornecedores) {
                    supplierSelect.innerHTML = '<option value="">Todos</option>';
                    fornecedores.forEach(fornecedor => {
                        const option = document.createElement('option');
                        // Usamos fornecedor.razao para o texto e valor, pois getFornecedoresListv2() retorna objetos
                        option.value = fornecedor.razao; 
                        option.textContent = fornecedor.razao;
                        supplierSelect.appendChild(option);
                    });
                })
                .withFailureHandler(function(error) {
                    console.error('Erro ao carregar fornecedores para o filtro:', error);
                    showToast('error', 'Erro!', 'Falha ao carregar fornecedores. ' + (error.message || error));
                })
                .getFornecedoresList(); // Chama a função CORRETA do Apps Script
        }

        // Popula o select de estados usando getEstados()
        function populateStatesFilter() {
            google.script.run
                .withSuccessHandler(function(states) {
                    stateSelect.innerHTML = '<option value="">Todos</option>';
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.value;
                        option.textContent = state.text;
                        stateSelect.appendChild(option);
                    });
                })
                .withFailureHandler(function(error) {
                    console.error('Erro ao carregar estados para o filtro:', error);
                    showToast('error', 'Erro!', 'Falha ao carregar estados. ' + (error.message || error));
                })
                .getEstados(); // Chama a função do Apps Script
        }


            // --- Event Listeners para os Filtros e Botões ---
            applyFiltersButton.addEventListener('click', () => {
            const startDate = dateStartInput.value;
            const endDate = dateEndInput.value;
            const selectedSupplier = supplierSelect.value;
            const selectedState = stateSelect.value;

            const filters = {
                startDate: startDate,
                endDate: endDate,
                supplier: selectedSupplier,
                state: selectedState
            };
            
            showToast('Aplicando Filtros','info', 'Buscando dados com base nos filtros selecionados...');
            loadDashboardData(filters);
        });

        clearFiltersButton.addEventListener('click', () => {
            dateStartInput.value = '';
            dateEndInput.value = '';
            supplierSelect.value = '';
            stateSelect.value = '';
            showToast('Filtros Limpos', 'info', 'Dashboard atualizado sem filtros.');
            loadDashboardData();
        });

        // --- Chamadas Iniciais para popular a tela do Dashboard ---
        populateSuppliersFilter();
        populateStatesFilter();
        loadDashboardData(); // Carrega os dados iniciais do dashboard (sem filtros aplicados inicialmente)

        // Lógica do botão voltar (se sua SPA tiver um)
        // Certifique-se de que o elemento 'backToMenuFromDashboard' exista no seu HTML
        // e que 'loadPageContent' e 'setupMenuScreen' estejam definidos em outro lugar.
        const backButton = document.getElementById('backToMenuFromDashboard');
        if (backButton) {
            backButton.addEventListener('click', () => {
                if (typeof loadPageContent === 'function' && typeof setupMenuScreen === 'function') {
                    loadPageContent('Menu', setupMenuScreen);
                } else {
                    console.warn("Funções 'loadPageContent' ou 'setupMenuScreen' não encontradas. Verifique a ordem dos scripts.");
                }
            });
        }
    }

    // Chama setupDashboardScreen quando a página estiver pronta.
    // Se o seu SPA já tem uma lógica para carregar telas,
    // esta chamada pode ser feita pela sua função de navegação,
    // garantindo que o dashboard seja configurado quando sua tela for ativada.
    //document.addEventListener('DOMContentLoaded', setupDashboardScreen);

        // --- Variáveis de referência para elementos do formulário ---
    let supplierSelect;
    let startDateInput;
    let endDateInput;
    let reportTypeDetailedRadio;
    let reportTypeFinancialRadio;
    let reportMessageElem;
    let reportPreviewAreaElem;
    let downloadLinkElem;
    let generatePdfButton;
    let generateXlsButton;
    let backToMenuFromReportsButton;

/**
 * Coleta os parâmetros do formulário e chama a função de geração de relatório no Apps Script.
 * @param {string} tipo - 'pdf' ou 'xlsx'.
 */
function gerarRelatorio(tipo) {
  console.log(`--- gerarRelatorio: Função chamada para o tipo ${tipo}. ---`);
    try {
        const startDateElem = document.getElementById('startDate');
        const endDateElem = document.getElementById('endDate');
        const supplierSelectElem = document.getElementById('supplierSelect');
        const reportTypeRadio = document.querySelector('input[name="reportType"]:checked');
        const generatePdfButton = document.getElementById('generatePdfButton');
        const generateXlsButton = document.getElementById('generateXlsButton');

        if (!startDateElem || !endDateElem || !supplierSelectElem || !reportTypeRadio) {
            showToast("Erro: Um ou mais campos do formulário de relatório não foram encontrados.", 'error');
            console.error("Erro: Elementos do formulário de relatório ausentes. Verifique os IDs no HTML.", {
                startDate: !!startDateElem,
                endDate: !!endDateElem,
                supplierSelect: !!supplierSelectElem,
                reportType: !!reportTypeRadio
            });
            return;
        }

        const startDate = startDateElem.value;
        const endDate = endDateElem.value;
        const reportType = reportTypeRadio.value;

        if (!startDate || !endDate) {
            showToast('Selecione o período completo para o relatório.', 'warning');
            return;
        }

        const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
        if (!empresaAtual || !empresaAtual.id) {
            showToast('Dados da empresa logada não encontrados.', 'error');
            return;
        }

        const reportParams = {
            startDate: startDate,
            endDate: endDate,
            supplier: supplierSelectElem.value !== 'todos' ? supplierSelect.value : null,
            reportType: reportType,
            companyId: empresaAtual.id ?? '',
            companyName: empresaAtual.nome ?? 'Nome não encontrado',
            companyAddress: empresaAtual.endereco ?? '',
            empresaCnpj: empresaAtual.cnpj ?? ''
        };
        
        console.log("📤 Enviando os seguintes parâmetros para o backend:", reportParams);

        showToast(`Gerando relatório em ${tipo.toUpperCase()}...`, 'info');
        generatePdfButton.disabled = true;
        generateXlsButton.disabled = true;

        const runner = google.script.run
            .withSuccessHandler(function(response) {
                generatePdfButton.disabled = false;
                generateXlsButton.disabled = false;

                if (response && response.status === 'success' && response.url) {
                    const downloadLinkElem = document.getElementById('downloadLink');
                    const reportPreviewAreaElem = document.getElementById('reportPreviewArea');
                    downloadLinkElem.href = response.url;
                    downloadLinkElem.textContent = `Baixar Relatório ${tipo.toUpperCase()}`;
                    if(reportPreviewAreaElem) reportPreviewAreaElem.classList.remove('hidden');
                    showToast('Relatório pronto para download!', 'success');
                } else {
                    const errorMessage = response ? response.message : 'Resposta inválida do servidor.';
                    showToast(`Erro ao gerar relatório: ${errorMessage}`, 'error');
                }
            })
            .withFailureHandler(function(error) {
                console.error(`Erro de comunicação ao gerar relatório ${tipo}:`, error);
                showToast(`Falha na comunicação com o servidor: ${error.message || error}`, 'error');
                generatePdfButton.disabled = false;
                generateXlsButton.disabled = false;
            });

        if (tipo === 'pdf') {
            runner.generatePdfReport(reportParams);
          } else if (tipo === 'xlsx') {
            runner.generateXlsReport(reportParams);
        }

    } catch (e) {
        console.error("Erro no cliente a  o tentar gerar relatório:", e);
        showToast(`Erro inesperado: ${e.message}`, 'error');
        //const pdfBtn = document.getElementById('generatePdfButton');
        //const xlsBtn = document.getElementById('generateXlsButton');
        //if(pdfBtn) pdfBtn.disabled = false;
        //if(xlsBtn) xlsBtn.disabled = false;
    }
}

/**
 * Função principal para configurar a tela de Relatórios.
 * Ela é chamada como um callback pela função loadPageContent.
 */
function setupRelatoriosScreen() {
    console.log("--- setupRelatoriosScreen: Iniciando inicialização da tela de relatórios ---");
    
    // Obter referências aos elementos HTML
    const generatePdfButton = document.getElementById('generatePdfButton');
    const generateXlsButton = document.getElementById('generateXlsButton');
    const backToMenuFromReportsButton = document.getElementById('backToMenuFromReportsButton');
    
    // --- LIMPEZA E CONFIGURAÇÃO DOS BOTÕES ---
    // A técnica de clone/replace limpa listeners antigos e garante que a ação seja adicionada.
    if (generatePdfButton) {
        const newBtn = generatePdfButton.cloneNode(true);
        generatePdfButton.parentNode.replaceChild(newBtn, generatePdfButton);
        
       newBtn.addEventListener('click', () => {
            console.log("--- CLIQUE no botão PDF detectado! ---");
            //const message = "SUCESSO! O clique no botão PDF está funcionando e executando o código.";
            //console.log(message);
            //showToast(message, 'success');
            // Se esta notificação aparecer, o próximo passo é descomentar a linha abaixo
            // e comentar as 3 linhas acima.
             gerarRelatorio('pdf'); 
        });
        console.log("✅ Event listener para Gerar PDF foi adicionado.");
    }

    if (generateXlsButton) {
        const newBtn = generateXlsButton.cloneNode(true);
        generateXlsButton.parentNode.replaceChild(newBtn, generateXlsButton);
        
        newBtn.addEventListener('click', () => {
           console.log("--- CLIQUE no botão XLSX detectado! ---");
            //const message = "SUCESSO! O clique no botão XLSX está funcionando e executando o código.";
            //console.log(message);
            //showToast(message, 'success');
            gerarRelatorio('xlsx');
        });
        console.log("✅ Event listener para Gerar XLSX foi adicionado.");
    }

    if (backToMenuFromReportsButton) {
        const newBackButton = backToMenuFromReportsButton.cloneNode(true);
        backToMenuFromReportsButton.parentNode.replaceChild(newBackButton, backToMenuFromReportsButton);
        newBackButton.addEventListener('click', () => {
            loadPageContent('Menu', setupMenuScreen);
        });
        console.log("✅ Event listener adicionado ao botão Voltar.");
    }

    const startDateElem = document.getElementById('startDate');
    const endDateElem = document.getElementById('endDate');

    if (startDateElem && endDateElem) {
        const hoje = new Date();
        const dataAnterior = new Date();
        dataAnterior.setDate(hoje.getDate() - 30);

        // Função auxiliar para formatar a data no padrão YYYY-MM-DD
        const formatarData = (data) => {
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        };

        endDateElem.value = formatarData(hoje);
        startDateElem.value = formatarData(dataAnterior);
        console.log(`📅 Datas padrão definidas: Início em ${startDateElem.value}, Fim em ${endDateElem.value}`);
    }

    // Chamar função para popular o select de fornecedores
    populateSupplierSelectForReports();

    // Esconder a área de preview no carregamento inicial
    const reportPreviewAreaElem = document.getElementById('reportPreviewArea');
    const reportMessageElem = document.getElementById('reportMessage');
    if(reportPreviewAreaElem) reportPreviewAreaElem.classList.add('hidden');
    if(reportMessageElem) reportMessageElem.textContent = '';
}


/**
 * Popula o select de fornecedores no formulário de relatórios.
 */
function populateSupplierSelectForReports() {
    showToast('Carregando lista de fornecedores...', 'info');
    
    const supplierSelect = document.getElementById('supplierSelect');
    if (!supplierSelect) return;

    google.script.run
        .withSuccessHandler(function(fornecedores) {
            supplierSelect.innerHTML = '<option value="todos">Todos os Fornecedores</option>';
            if (fornecedores && fornecedores.length > 0) {
                fornecedores.forEach(fornecedor => {
                    const option = document.createElement('option');
                    option.value = fornecedor.razao; 
                    option.textContent = fornecedor.razao;
                    supplierSelect.appendChild(option);
                });
                showToast('Lista de fornecedores carregada.', 'success');
            } else {
                showToast('Nenhum fornecedor encontrado.', 'warning');
            }
        })
        .withFailureHandler(function(error) {
            console.error('Erro ao carregar fornecedores para o relatório:', error);
            showToast(`Falha ao carregar fornecedores: ${error.message || error}`, 'error');
        })
        .getFornecedoresList();
}


        function setupGerenciarRascunhosScreen() {
            console.log('🔧 Inicializando tela de gerenciamento de rascunhos...');
            
            const backButton = document.getElementById('backToMenuFromRascunhosButton');
            const messageElement = document.getElementById('rascunhosMessage');
            const tableBody = document.getElementById('rascunhosTableBody');
            const emptyState = document.getElementById('emptyStateRascunhos');
            const totalRascunhos = document.getElementById('totalRascunhos');
            
            let allRascunhos = [];
            
            // Event listener para voltar ao menu
            if (backButton) {
                backButton.addEventListener('click', () => {
                    loadPageContent('Menu', setupMenuScreen);
                });
            }
            
            // Função para mostrar mensagem
            function showMessage(text, type = 'success') {
                if (messageElement) {
                    messageElement.textContent = text;
                    messageElement.className = `text-center text-sm font-medium min-h-[20px] mt-2 transition-opacity duration-300 ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
                    setTimeout(() => { messageElement.textContent = ''; }, 3000);
                }
            }
            
            // Função para renderizar tabela de rascunhos
            function renderRascunhosTable(rascunhos) {
                if (!tableBody) return;
                
                console.log('🔍 Debug - Rascunhos recebidos:', rascunhos);
                console.log('🔍 Debug - Primeiro rascunho completo:', rascunhos[0]);
                
                tableBody.innerHTML = '';
                
                if (rascunhos.length === 0) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    if (totalRascunhos) totalRascunhos.textContent = 'Nenhum rascunho encontrado';
                    return;
                }
                
                if (emptyState) emptyState.classList.add('hidden');
                if (totalRascunhos) totalRascunhos.textContent = `${rascunhos.length} rascunho(s) encontrado(s)`;
                
                rascunhos.forEach(rascunho => {
                    console.log(`🔍 Debug - Processando rascunho ${rascunho.id}:`);
                    console.log(`  - dataUltimaEdicao:`, rascunho.dataUltimaEdicao);
                    console.log(`  - tipo dataUltimaEdicao:`, typeof rascunho.dataUltimaEdicao);
                    
                    const dataFormatada = new Date(rascunho.data).toLocaleDateString('pt-BR');
                    
                    let ultimaEdicao = 'N/A';
                    if (rascunho.dataUltimaEdicao && rascunho.dataUltimaEdicao.trim() !== '') {
                        try {
                            const dataEdicao = new Date(rascunho.dataUltimaEdicao);
                            if (!isNaN(dataEdicao.getTime())) {
                                ultimaEdicao = dataEdicao.toLocaleString('pt-BR');
                            }
                        } catch (e) {
                            console.warn(`⚠️ Erro ao formatar data de última edição para rascunho ${rascunho.id}:`, e);
                        }
                    }
                        
                    console.log(`  - ultimaEdicao formatada:`, ultimaEdicao);
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rascunho.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dataFormatada}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rascunho.fornecedor}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rascunho.estadoFornecedor || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${rascunho.itens?.length || 0} item(s)</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ultimaEdicao}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                            <button onclick="editarRascunho('${rascunho.id}')" 
                                    class="text-blue-600 hover:text-blue-900" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="finalizarRascunho('${rascunho.id}')" 
                                    class="text-green-600 hover:text-green-900" title="Finalizar como Pedido">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            <button onclick="excluirRascunho('${rascunho.id}')" 
                                    class="text-red-600 hover:text-red-900" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // Função para carregar rascunhos do backend
            function carregarRascunhos() {
                showMessage('Carregando rascunhos...', 'success');
                
                // Primeiro, vamos testar a comunicação
                console.log('🔧 Testando comunicação com o backend...');
                google.script.run
                    .withSuccessHandler(testResponse => {
                        console.log('✅ Teste de comunicação bem-sucedido:', testResponse);
                        
                        // Agora tentar buscar rascunhos
                        const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
                        console.log('🔍 Empresa para busca:', empresaAtual);
                        
                        google.script.run
                            .withSuccessHandler(response => {
                                console.log('📋 Resposta do backend para buscarRascunhos:', response);
                                
                                // Verificar se response não é null/undefined
                                if (!response) {
                                    console.error('❌ Resposta null/undefined do backend');
                                    showMessage('Erro: Nenhuma resposta do servidor. Verifique a função backend.', 'error');
                                    renderRascunhosTable([]);
                                    return;
                                }
                                
                                // Verificar se response tem a estrutura esperada
                                if (typeof response !== 'object') {
                                    console.error('❌ Resposta inválida do backend:', typeof response, response);
                                    showMessage('Erro: Resposta inválida do servidor.', 'error');
                                    renderRascunhosTable([]);
                                    return;
                                }
                                
                                if (response.status === 'success') {
                                    allRascunhos = response.rascunhos || [];
                                    renderRascunhosTable(allRascunhos);
                                    carregarFornecedoresFiltro();
                                    showMessage(`${allRascunhos.length} rascunho(s) carregado(s)`, 'success');
                                } else if (response.status === 'error') {
                                    const errorMsg = response.message || 'Erro desconhecido no servidor';
                                    showMessage('Erro ao carregar rascunhos: ' + errorMsg, 'error');
                                    renderRascunhosTable([]);
                                } else {
                                    console.error('❌ Status desconhecido na resposta:', response.status);
                                    showMessage('Erro: Status desconhecido na resposta do servidor.', 'error');
                                    renderRascunhosTable([]);
                                }
                            })
                            .withFailureHandler(error => {
                                console.error('❌ Erro ao carregar rascunhos:', error);
                                showMessage('Erro de comunicação ao buscar rascunhos: ' + (error.message || error), 'error');
                                renderRascunhosTable([]);
                            })
                            .buscarRascunhosCorrigida(empresaAtual.id || empresaAtual.codigo);
                    })
                    .withFailureHandler(error => {
                        console.error('❌ Falha no teste de comunicação:', error);
                        showMessage('Erro: Falha na comunicação com o servidor. Verifique a configuração.', 'error');
                        renderRascunhosTable([]);
                    })
                    .testarComunicacao();
            }
            
            // Função para carregar fornecedores no filtro
            function carregarFornecedoresFiltro() {
                const filtroFornecedor = document.getElementById('filtroFornecedor');
                if (!filtroFornecedor) return;
                
                // Limpar e adicionar opção padrão
                filtroFornecedor.innerHTML = '<option value="">Todos os fornecedores</option>';
                
                // Primeiro, adicionar fornecedores únicos dos rascunhos
                const fornecedoresRascunhos = [...new Set(allRascunhos.map(r => r.fornecedor).filter(f => f))];
                
                // Carregar todos os fornecedores da base de dados
                const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
                google.script.run
                    .withSuccessHandler(response => {
                        let todosFornecedores = [];
                        
                        // getFornecedoresListv2 retorna array direto
                        if (Array.isArray(response)) {
                            todosFornecedores = response;
                        }
                        
                        // Combinar fornecedores dos rascunhos com todos os fornecedores
                        const fornecedoresCombinados = new Set([
                            ...fornecedoresRascunhos,
                            ...todosFornecedores.map(f => f.razao || f.text || f.razaoSocial || f.nome)
                        ]);
                        
                        // Adicionar ao select
                        Array.from(fornecedoresCombinados)
                            .filter(f => f && f.trim())
                            .sort()
                            .forEach(fornecedor => {
                                const option = document.createElement('option');
                                option.value = fornecedor;
                                option.textContent = fornecedor;
                                filtroFornecedor.appendChild(option);
                            });
                    })
                    .withFailureHandler(error => {
                        console.error('Erro ao carregar fornecedores:', error);
                        // Em caso de erro, usar apenas fornecedores dos rascunhos
                        fornecedoresRascunhos.forEach(fornecedor => {
                            const option = document.createElement('option');
                            option.value = fornecedor;
                            option.textContent = fornecedor;
                            filtroFornecedor.appendChild(option);
                        });
                    })
                    .getFornecedoresList();
            }
            
            // Event listeners para filtros
            ['filtroFornecedor', 'filtroDataInicio', 'filtroDataFim'].forEach(filtroId => {
                const filtro = document.getElementById(filtroId);
                if (filtro) {
                    filtro.addEventListener('change', aplicarFiltros);
                }
            });
            
            
            // Função para aplicar filtros
            function aplicarFiltros() {
                const filtroFornecedor = document.getElementById('filtroFornecedor')?.value || '';
                const filtroDataInicio = document.getElementById('filtroDataInicio')?.value || '';
                const filtroDataFim = document.getElementById('filtroDataFim')?.value || '';
                
                let rascunhosFiltrados = allRascunhos;
                
                if (filtroFornecedor) {
                    rascunhosFiltrados = rascunhosFiltrados.filter(r => r.fornecedor === filtroFornecedor);
                }
                
                if (filtroDataInicio) {
                    rascunhosFiltrados = rascunhosFiltrados.filter(r => r.data >= filtroDataInicio);
                }
                
                if (filtroDataFim) {
                    rascunhosFiltrados = rascunhosFiltrados.filter(r => r.data <= filtroDataFim);
                }
                
                renderRascunhosTable(rascunhosFiltrados);
            }
            
            // Carregar rascunhos na inicialização
            carregarRascunhos();
        }

        function setupGerenciarFornecedoresScreen() {
            const backButton = document.getElementById('backToMenuFromSuppliersButton');
            const addButton = document.getElementById('addNewFornecedorBtn');

            if (backButton) {
                backButton.addEventListener('click', () => {
                    loadPageContent('Menu', setupMenuScreen);
                });
            }

            if (addButton) {
                addButton.addEventListener('click', () => {
                    loadPageContent('CadastroFornecedor', setupCadastroFornecedorScreen);
                });
            }

             const tbody = document.getElementById('fornecedoresTableBody');
              if (tbody) {
                  // Este listener agora vai cuidar TANTO do badge de status QUANTO do botão de editar
                  tbody.addEventListener('click', function(e) {
                      
                      // Verifica se o clique foi no BADGE DE STATUS
                      const statusBadge = e.target.closest('.badge-status-toggle');
                      if (statusBadge) {
                          const codigo = statusBadge.dataset.codigo;
                          showToast('Alterando status...', 'info');

                          google.script.run
                              .withSuccessHandler(response => {
                                  if (response && response.status === 'ok') {
                                      showToast(response.message, 'success');
                                      
                                      // Atualiza a aparência do badge e da linha
                                      const isAgoraAtivo = response.novoStatus === 'ATIVO';
                                      statusBadge.textContent = response.novoStatus;
                                      statusBadge.className = 'badge-status-toggle px-3 py-1 text-xs font-semibold leading-5 rounded-full cursor-pointer transition hover:opacity-80 ' + 
                                                              (isAgoraAtivo ? 'bg-green-100 text-green-800' : 'bg-gray-200 text-gray-800');
                                      statusBadge.closest('tr').className = 'border-b ' + (isAgoraAtivo ? '' : 'bg-gray-50 opacity-60');
                                  } else {
                                      showToast(response ? response.message : 'Erro desconhecido.', 'error');
                                  }
                              })
                              .withFailureHandler(err => {
                                  showToast('Erro de comunicação.', 'error');
                                  console.error(err);
                              })
                              .alternarStatusFornecedorv2(codigo);
                      }
                  

                  // Adiciona o listener para o botão de editar também
                  const editButton = e.target.closest('.btn-editar-fornecedor');
                    if (editButton) {
                        const codigo = editButton.dataset.codigo;
                        loadPageContent('CadastroFornecedor', () => setupCadastroFornecedorScreen(codigo));
                    }
                });
            }
            carregarListaFornecedores();
        }

        function setupTrocarSenhaScreen() {
            const btnSalvar = document.getElementById('btnSalvarSenha');
            const btnVoltar = document.getElementById('btnVoltarMenuSenha');

            if (btnSalvar) {
                btnSalvar.addEventListener('click', trocarSenha);
            }

            if (btnVoltar) {
                btnVoltar.addEventListener('click', () => {
                    loadPageContent('Menu', setupMenuScreen);
                });
            }
        }

        function setupPedidoSalvoScreen(numeroPedido) {
            const voltarButton = document.getElementById('voltarMenuPrincipalButton');
            const printButton = document.getElementById('printPedidoButton');

            if (voltarButton) {
                voltarButton.addEventListener('click', () => {
                    loadPageContent('Menu', setupMenuScreen);
                });
            }

            if (printButton) {
                printButton.addEventListener('click', () => {
                    iniciarImpressao(numeroPedido, empresaId);
                });
            }
        }

        function abrirImpressaoPedido(numeroPedido) {
            if (!numeroPedido) {
                showGlobalModal('Erro', 'Número do pedido não fornecido para impressão.');
                return;
            }
            
            showGlobalModal('Aguarde', `Preparando impressão do pedido ${numeroPedido}...`, 'info');

            google.script.run
                .withSuccessHandler(pedidoData => {
                    if (!pedidoData) {
                        showGlobalModal('Erro', 'Dados do pedido não encontrados para impressão.');
                        return;
                    }
                    
                    document.getElementById('global-modal').classList.add('hidden');

                    const pageHtml = getPageTemplate('PedidoImpressao');
                    const printWindow = window.open('', '_blank');
                    
                    if (!printWindow) {
                        showGlobalModal("Pop-up bloqueado!", "Por favor, permita pop-ups para este site para poder imprimir o pedido.");
                        return;
                    }

                    printWindow.document.write(pageHtml);
                    printWindow.document.close();

                    printWindow.onload = function() {
                        preencherDadosImpressao(printWindow.document, pedidoData);
                        
                        setTimeout(() => {
                            printWindow.focus();
                            printWindow.print();
                        }, 500);
                    };
                })
                .withFailureHandler(err => {
                    showGlobalModal('Erro', `Erro ao carregar dados do pedido: ${err.message}`);
                })
                .getDadosPedidoParaImpressao(numeroPedido);
        }

        function preencherDadosImpressao(doc, pedidoData) {
            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
            
            // Dados da empresa
            doc.getElementById('empresaNomePrint').textContent = empresaAtual.nome || '';
            doc.getElementById('empresaEnderecoPrint').textContent = pedidoData.enderecoEmpresa || '';
            doc.getElementById('empresaCidadeUfPrint').textContent = pedidoData.cidadeUfEmpresa || '';
            doc.getElementById('empresaCnpjPrint').textContent = pedidoData.cnpjEmpresa || '';
            doc.getElementById('empresaEmailPrint').textContent = `Email: ${pedidoData.emailEmpresa || ''}`;
            doc.getElementById('empresaTelefonePrint').textContent = `Telefone: ${pedidoData.telefoneEmpresa || ''}`;

            // Dados do pedido
            doc.getElementById('numeroPedidoPrint').textContent = pedidoData.numeroDoPedido || '';
            
            const dataPedidoObj = new Date(pedidoData.data + 'T12:00:00');
            const formattedDate = dataPedidoObj.toLocaleDateString('pt-BR');
            const now = new Date();
            const formattedTime = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            doc.getElementById('dataEmissaoPrint').textContent = `${formattedDate} ${formattedTime}`;

            // Dados do fornecedor
            doc.getElementById('fornecedorPrint').textContent = pedidoData.fornecedor || '';
            doc.getElementById('enderecoFornecedorPrint').textContent = pedidoData.enderecoFornecedor || '';
            doc.getElementById('formaPagamentoPrint').textContent = pedidoData.formaPagamentoFornecedor || '';
            doc.getElementById('cnpjFornecedorPrint').textContent = pedidoData.cnpjFornecedor || '';
            doc.getElementById('condicaoPagamentoPrint').textContent = pedidoData.condicaoPagamentoFornecedor || '';
            
            // Dados do veículo
            doc.getElementById('placaVeiculoPrint').textContent = pedidoData.placaVeiculo || 'N/A';
            doc.getElementById('nomeVeiculoPrint').textContent = pedidoData.nomeVeiculo || 'N/A';
            
            // Total e observações
            doc.getElementById('totalGeralPrint').textContent = `R$ ${parseFloat(pedidoData.totalGeral || 0).toFixed(2).replace('.', ',')}`;
            doc.getElementById('observacoesPedidoPrint').textContent = pedidoData.observacoes || 'Sem observações.';

            // Itens
            const printItemsTableBody = doc.getElementById('printItemsTableBody');
            printItemsTableBody.innerHTML = '';
            if (pedidoData.itens && Array.isArray(pedidoData.itens)) {
                pedidoData.itens.forEach((item, index) => {
                    const row = printItemsTableBody.insertRow();
                    row.insertCell(0).textContent = index + 1;
                    row.insertCell(1).textContent = item.descricao;
                    row.insertCell(2).textContent = item.unidade || '';
                    row.insertCell(3).textContent = item.quantidade;
                    row.insertCell(4).textContent = `R$ ${parseFloat(item.precoUnitario || 0).toFixed(2).replace('.', ',')}`;
                    row.insertCell(5).textContent = `R$ ${parseFloat(item.totalItem || 0).toFixed(2).replace('.', ',')}`;
                });
            }
            
            // Dados do usuário
            const nomeUsuario = localStorage.getItem('nome') || 'Usuário Desconhecido';
            const perfilUsuario = localStorage.getItem('perfil') || 'Sem Função';
            doc.getElementById('usuarioLogadoPrint').textContent = nomeUsuario.toUpperCase();
            doc.getElementById('funcaoUsuarioLogadoPrint').textContent = perfilUsuario.toUpperCase();
        }



        function realizarBuscaAvancada() {
            console.log('🔍 Realizando busca avançada...');
            
            const mainSearch = document.getElementById('mainSearch');
            const dateStart = document.getElementById('dateStart');
            const dateEnd = document.getElementById('dateEnd');
            const plateSearch = document.getElementById('plateSearch');
            const userSearch = document.getElementById('userSearch');
            const resultsBody = document.getElementById('searchResultsBody');
            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');

            // Coletar filtros
            const filtros = {
                query: mainSearch ? mainSearch.value.trim() : '',
                dataInicial: dateStart ? dateStart.value : '',
                dataFinal: dateEnd ? dateEnd.value : '',
                placa: plateSearch ? plateSearch.value.trim() : '',
                usuario: userSearch ? userSearch.value.trim() : ''
            };

            console.log('🔍 Filtros aplicados:', filtros);

            // Verificar se pelo menos um filtro foi preenchido
            const temFiltros = filtros.query || filtros.dataInicial || filtros.dataFinal || filtros.placa || filtros.usuarioCriador;
            
            if (!temFiltros) {
                if (resultsBody) {
                    resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-12"><div class="flex flex-col items-center"><i class="fas fa-search fa-3x mb-4 text-gray-300"></i><p class="text-lg font-medium">Use os filtros acima para buscar pedidos</p><p class="text-sm text-gray-400 mt-2">Digite um número de pedido, nome do fornecedor ou use os filtros avançados</p></div></td></tr>';
                }
                showToast('Digite pelo menos um critério de busca', 'info');
                return;
            }

            // Limpar tabela e mostrar loading
            if (resultsBody) {
                resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8"><div class="spinner mx-auto mb-2"></div>Buscando pedidos...</td></tr>';
            }

            console.log('🔍 Iniciando busca no backend...');
            console.log('📝 Parâmetros da busca:');
            console.log('   - Query:', filtros.query || '');
            console.log('   - Empresa ID:', empresaAtual.id);
            
            google.script.run
                .withSuccessHandler(response => {
                    console.log('✅ Resposta da busca recebida:', response);

                    if (!response) {
                        console.error('🔍 Erro crítico: A resposta do backend foi nula. Verifique os logs do servidor para a função "buscarPedidos".');
                        if (resultsBody) {
                            resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 py-8">Ocorreu um erro inesperado no servidor. A busca não pôde ser concluída.</td></tr>';
                        }
                        showToast('Erro inesperado no servidor. Verifique os logs.', 'error');
                        return; // Interrompe a execução para evitar o erro
                    }
                    if (response.status === 'success' && response.data && response.data.length > 0) {
                        // Filtrar os resultados no frontend com base nos filtros avançados
                        const resultadosFiltrados = filtrarPedidosAvancado(response.data, filtros);
                        
                        if (resultadosFiltrados.length > 0) {
                            preencherTabelaBusca(resultadosFiltrados, resultsBody);
                            showToast(`${resultadosFiltrados.length} pedido(s) encontrado(s)`, 'success');
                        } else {
                            if (resultsBody) {
                                resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">Nenhum pedido encontrado com os filtros aplicados</td></tr>';
                            }
                            showToast('Nenhum pedido encontrado com os filtros aplicados', 'info');
                        }
                    } else {
                        console.log('⚠️ Busca retornou resultado vazio ou com erro');
                        console.log('   - Status:', response.status);
                        console.log('   - Data:', response.data);
                        console.log('   - Message:', response.message);
                        
                        if (resultsBody) {
                            resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">Nenhum pedido encontrado</td></tr>';
                        }
                        showToast('Nenhum pedido encontrado', 'info');
                    }
                })
                .withFailureHandler(err => {
                    console.error('🔍 Erro na busca:', err);
                    if (resultsBody) {
                        resultsBody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 py-8">Erro ao buscar pedidos. Tente novamente.</td></tr>';
                    }
                    showToast('Erro na busca: ' + err.message, 'error');
                })
                .buscarPedidosv2(filtros.query || '', empresaAtual.id);
        }

        function filtrarPedidosAvancado(pedidos, filtros) {
            console.log('🔍 Filtrando pedidos com filtros avançados:', filtros);
            console.log('📊 Total de pedidos recebidos:', pedidos.length);
            
            if (!pedidos || pedidos.length === 0) {
                return [];
            }

            const pedidosFiltrados = pedidos.filter(pedido => {
                // Filtro por placa
                if (filtros.placa && filtros.placa.trim()) {
                    const placaPedido = (pedido.placa || '').toLowerCase();
                    const placaFiltro = filtros.placa.toLowerCase().trim();
                    if (!placaPedido.includes(placaFiltro)) {
                        return false;
                    }
                }

                // Filtro por usuário
                if (filtros.usuario && filtros.usuario.trim()) {
                    const usuarioPedido = (pedido.usuario || pedido.usuarioResponsavel || '').toLowerCase();
                    const usuarioFiltro = filtros.usuario.toLowerCase().trim();
                    if (!usuarioPedido.includes(usuarioFiltro)) {
                        return false;
                    }
                }

                // Filtro por data inicial
                if (filtros.dataInicial && filtros.dataInicial.trim()) {
                    try {
                        const dataInicial = new Date(filtros.dataInicial + 'T00:00:00');
                        const dataPedido = normalizarDataPedido(pedido.data);
                        if (dataPedido && dataPedido < dataInicial) {
                            return false;
                        }
                    } catch (e) {
                        console.warn('Erro ao comparar data inicial:', e);
                    }
                }

                // Filtro por data final
                if (filtros.dataFinal && filtros.dataFinal.trim()) {
                    try {
                        const dataFinal = new Date(filtros.dataFinal + 'T23:59:59');
                        const dataPedido = normalizarDataPedido(pedido.data);
                        if (dataPedido && dataPedido > dataFinal) {
                            return false;
                        }
                    } catch (e) {
                        console.warn('Erro ao comparar data final:', e);
                    }
                }

                return true;
            });

            console.log('📊 Pedidos após filtros avançados:', pedidosFiltrados.length);
            return pedidosFiltrados;
        }

        function normalizarDataPedido(dataInput) {
            console.log('📅 Normalizando data do pedido:', dataInput);
            
            if (!dataInput) {
                console.warn('📅 Data do pedido está vazia ou nula');
                return null;
            }

            // Se já é um objeto Date válido
            if (dataInput instanceof Date && !isNaN(dataInput)) {
                return dataInput;
            }

            // Se é uma string, tentar vários formatos
            if (typeof dataInput === 'string') {
                let dataString = dataInput.trim();
                
                // Formato "YYYY-MM-DD HH:mm:ss" - precisa de conversão especial
                if (dataString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)) {
                    // IMPORTANTE: Não adicionar Z para manter horário local brasileiro
                    // Converter para formato ISO sem indicar UTC
                    const dataISO = dataString.replace(' ', 'T');
                    const data = new Date(dataISO);
                    if (!isNaN(data)) {
                        console.log('📅 Data convertida do formato "YYYY-MM-DD HH:mm:ss":', data.toLocaleString('pt-BR'));
                        return data;
                    }
                }
                
                // Formato ISO padrão (YYYY-MM-DD ou YYYY-MM-DDTHH:mm:ss)
                if (dataString.match(/^\d{4}-\d{2}-\d{2}T/)) {
                    const data = new Date(dataString);
                    if (!isNaN(data)) {
                        console.log('📅 Data convertida do formato ISO:', data.toLocaleString('pt-BR'));
                        return data;
                    }
                }
                
                // Formato de data simples (YYYY-MM-DD)
                if (dataString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const data = new Date(dataString + 'T12:00:00.000Z');
                    if (!isNaN(data)) {
                        console.log('📅 Data convertida do formato YYYY-MM-DD:', data.toLocaleString('pt-BR'));
                        return data;
                    }
                }
                
                // Formato brasileiro (DD/MM/YYYY)
                if (dataString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                    const [dia, mes, ano] = dataString.split('/');
                    const data = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia), 12, 0, 0);
                    if (!isNaN(data)) {
                        console.log('📅 Data convertida do formato brasileiro:', data.toLocaleString('pt-BR'));
                        return data;
                    }
                }
                
                // Tentar parseamento direto apenas como último recurso
                const dataTentativa = new Date(dataString);
                if (!isNaN(dataTentativa)) {
                    console.log('📅 Data convertida por parseamento direto:', dataTentativa.toLocaleString('pt-BR'));
                    return dataTentativa;
                }
            }

            console.warn('📅 Não foi possível normalizar a data:', dataInput);
            return null;
        }

        function preencherTabelaBusca(pedidos, tbody) {
            console.log('📊 Preenchendo tabela com', pedidos.length, 'pedidos');
            if (!tbody) return;           
            tbody.innerHTML = '';
            
            pedidos.forEach(pedido => {
                const tableRow = document.createElement('tr');
                tableRow.className = 'hover:bg-gray-50';
                const numeroPedido = pedido.numeroDoPedido || pedido.numeroPedido || pedido.numero || 'N/A';
                console.log('📊 Processando pedido:', pedido);
                const empresaId = pedido.empresaId || pedido.empresa || '';
                const empresaObj = AppCache.userCompanies.find(c => String(c.id).trim() == String(empresaId).trim());
                const empresaNome = empresaObj ? empresaObj.nome : 'N/A';
                //const valorFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(pedido.totalGeral || 0);
                //const dataFormatada = new Date(pedido.data).toLocaleDateString('pt-BR');
                //const statusClass = pedido.status === 'Cancelado' ? 'bg-red-200 text-red-800' : 'bg-green-100 text-green-800';

                // ---------------------------------------------------------

                // Verificar se pedido tem dados válidos
                if (numeroPedido === 'N/A' || !pedido.fornecedor) {
                    console.warn('Pedido com dados incompletos ignorado:', pedido);
                    return; // Pula este pedido
                }

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 border-b';
                           
                            
                // Verificar se o pedido está cancelado
                const isCanceled = pedido.status === 'Cancelado';
                if (isCanceled) {
                    row.classList.add('canceled-row');
                }

                // Verificar se pode editar (menos de 1 hora)
                const podeEditar = verificarSePermiteEdicao(pedido);
                
                const statusClass = isCanceled ? 'bg-red-200 text-red-800' : 
                                   pedido.status === 'Ativo' ? 'bg-green-100 text-green-800' : 
                                   'bg-gray-100 text-gray-800';
                
                const valorFormatado = `R$ ${parseFloat(pedido.totalGeral || 0).toFixed(2).replace('.', ',')}`;
                
                // Melhor tratamento para formatação de data
                let dataFormatada = 'N/A';
                try {
                    const dataNormalizada = normalizarDataPedido(pedido.data);
                    if (dataNormalizada && !isNaN(dataNormalizada.getTime())) {
                        dataFormatada = dataNormalizada.toLocaleDateString('pt-BR');
                    }
                } catch (e) {
                    console.warn('Erro ao formatar data do pedido:', pedido.data, e);
                }

                // Normalizar campo do número do pedido - aceitar vários formatos possíveis do backend
                //const numeroPedido = pedido.numeroDoPedido || pedido.numeroPedido || pedido.numero || 'N/A';

                // Verificar se pedido tem dados válidos (evitar mostrar pedidos vazios)
                if (!numeroPedido || numeroPedido === 'N/A' || !pedido.fornecedor) {
                    console.warn('Pedido com dados incompletos ignorado:', pedido);
                    return; // Pular este pedido
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${numeroPedido}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dataFormatada}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${pedido.fornecedor || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-bold">${valorFormatado}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}"
                            ${pedido.status || 'Em Aberto'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium space-x-2">
                        <button onclick="visualizarPedidoExistente('${numeroPedido}', '${empresaId}', '${empresaNome}', 'busca-pedidos')" 
                                title="Visualizar Pedido" 
                                class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="iniciarImpressao('${numeroPedido}', '${empresaId}')" title="Imprimir" class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-print"></i>
                        </button>
                        <button onclick="editarPedido('${numeroPedido}')" title="Editar" 
                                class="text-yellow-600 hover:text-yellow-900 ${!podeEditar || isCanceled ? 'opacity-50 cursor-not-allowed' : ''}" 
                                ${!podeEditar || isCanceled ? 'disabled' : ''}>
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button onclick="cancelarPedido('${numeroPedido}')" title="Cancelar" 
                                class="text-red-600 hover:text-red-900 ${isCanceled ? 'opacity-50 cursor-not-allowed' : ''}" 
                                ${isCanceled ? 'disabled' : ''}>
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function setupPrintModal() {
            const printModal = document.getElementById('print-modal');
            const closePrintModalBtn = document.getElementById('close-print-modal');

            if (closePrintModalBtn) {
                closePrintModalBtn.addEventListener('click', () => {
                    if (printModal) {
                        printModal.classList.add('hidden');
                        printModal.classList.remove('flex');
                    }
                });
            }

            // Fechar modal clicando fora
            if (printModal) {
                printModal.addEventListener('click', (e) => {
                    if (e.target === printModal) {
                        printModal.classList.add('hidden');
                        printModal.classList.remove('flex');
                    }
                });
            }
        }

        function abrirModalImpressao(numeroPedido) {
            console.log('🖨️ Abrindo modal de impressão para pedido:', numeroPedido);
            
            const printModal = document.getElementById('print-modal');
            const printContent = document.getElementById('print-content');
            const printPedidoId = document.getElementById('print-pedido-id');

            if (printPedidoId) {
                printPedidoId.textContent = numeroPedido;
            }

            // Verificar se o pedido está cancelado para adicionar marca d'água
            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success' && response.data && response.data.length > 0) {
                        const pedido = response.data[0];
                        if (printContent) {
                            if (pedido.status === 'Cancelado') {
                                printContent.classList.add('print-watermark');
                            } else {
                                printContent.classList.remove('print-watermark');
                            }
                        }
                    }
                })
                .withFailureHandler(err => {
                    console.error('Erro ao verificar status do pedido:', err);
                })
                .buscarPedidosv2(numeroPedido, JSON.parse(localStorage.getItem('empresaSelecionada') || '{}').id);

            if (printModal) {
                printModal.classList.remove('hidden');
                printModal.classList.add('flex');
            }
        }

        function cancelarPedido(numeroPedido) {
            if (confirm(`Tem a certeza que deseja cancelar o pedido #${numeroPedido}?`)) {
                console.log('❌ Cancelando pedido:', numeroPedido);
                
                showToast('Cancelando pedido...', 'info');
                
                // Por enquanto, apenas simular o cancelamento atualizando localmente
                // Em uma implementação real, você faria a chamada para o backend
                setTimeout(() => {
                    showToast(`Pedido #${numeroPedido} cancelado com sucesso`, 'success');
                    realizarBuscaAvancada(); // Recarregar resultados
                }, 1000);
            }
        }

          // Função para verificar se um pedido pode ser editado (1 hora após criação)
        function verificarSePermiteEdicao(pedido) {
    
    console.log("DEBUG: Verificando permissão para o pedido:", JSON.stringify(pedido, null, 2));

    // 1. Validação do Objeto: Garante que o pedido não é nulo.
    if (!pedido) {
        console.warn('verificarSePermiteEdicao: o objeto do pedido é nulo.');
        return false;
    }

    // 2. Verificação do Status: Garante que o status seja 'Em Aberto'.
    const statusValue = pedido.status || pedido.statusDoPedido;
    if (!statusValue || String(statusValue).trim().toUpperCase() !== 'EM ABERTO') {
        // Se não tiver status ou o status não for 'Em Aberto', bloqueia a edição.
        return false;
    }

    // 3. Verificação da Data de Criação (Ponto Crítico)
    // A função precisa do campo 'dataCriacao' com a data E a hora para funcionar.
    const dataCriacaoStr = pedido.dataCriacao;

    if (!dataCriacaoStr) {
        console.error(`EDIÇÃO BLOQUEADA: O campo 'dataCriacao' (com a hora) não foi encontrado nos dados do pedido ${pedido.numeroDoPedido || 'N/A'}.`);
        return false;
    }

    // 4. Cálculo do Limite de Tempo
    try {
        // =================================================================================
        // CORREÇÃO DE FUSO HORÁRIO APLICADA AQUI
        // =================================================================================
        let dataCriacao;
        const dataString = String(dataCriacaoStr);

        // Se a string da data NÃO CONTÉM hora (ex: "2025-07-15"),
        // adicionamos a hora local para que seja interpretada como meia-noite
        // no fuso horário do usuário, e não em UTC.
        if (!dataString.includes(' ') && !dataString.includes('T')) {
            dataCriacao = new Date(dataString + 'T00:00:00');
        } else {
            // Se a string JÁ TEM a hora, apenas a usamos.
            // O replace(' ', 'T') garante compatibilidade.
            dataCriacao = new Date(dataString.replace(' ', 'T'));
        }
        // =================================================================================

        if (isNaN(dataCriacao.getTime())) {
            throw new Error("Formato de data recebido é inválido: " + dataCriacaoStr);
        }

        const agora = new Date();
        const umaHoraEmMs = 60 * 60 * 1000;
        const tempoDecorrido = agora.getTime() - dataCriacao.getTime();

        if (tempoDecorrido > umaHoraEmMs) {
            console.log(`Edição bloqueada: Pedido ${pedido.numeroDoPedido || 'N/A'} foi criado em ${dataCriacao.toLocaleString()} (há mais de 1 hora).`);
            return false;
        }
    } catch (e) {
        console.error("Erro fatal ao processar a data de criação. Edição bloqueada por segurança.", e);
        return false;
    }

    // 5. Permissão Concedida
    // Se passou por todas as verificações, a edição é permitida.
    console.log(`EDIÇÃO PERMITIDA para o pedido ${pedido.numeroDoPedido || 'N/A'}.`);
    return true;
}

// ================================================================
// MÓDULO DE GERENCIAMENTO DE EDIÇÃO DE PEDIDO
// ================================================================
const EdicaoPedido = (function() {
    let dadosAtuais = null;

    return {
        /**
         * Armazena os dados do pedido que está sendo editado.
         * ESTA VERSÃO GARANTE QUE O CAMPO 'itens' SEJA SEMPRE UM ARRAY.
         * @param {object} pedido - O objeto completo do pedido.
         */
        setDados: function(pedido) {
            // Faz uma cópia para não modificar o objeto original que veio do backend
            const dadosParaArmazenar = { ...pedido };

            // Garante que 'itens' seja sempre um array de objetos
            if (typeof dadosParaArmazenar.itens === 'string' && dadosParaArmazenar.itens) {
                try {
                    // Tenta converter a string JSON para um array
                    dadosParaArmazenar.itens = JSON.parse(dadosParaArmazenar.itens);
                    console.log("EdicaoPedido: String de itens foi convertida para um array de objetos.");
                } catch (e) {
                    console.error("EdicaoPedido: Erro ao converter string de itens. Itens foram definidos como um array vazio.", e);
                    dadosParaArmazenar.itens = []; // Define como array vazio em caso de erro
                }
            } else if (!Array.isArray(dadosParaArmazenar.itens)) {
                // Se não for um array nem uma string (ex: null, undefined), inicializa como array vazio por segurança
                console.warn("EdicaoPedido: O campo 'itens' não era um array. Foi inicializado como um array vazio.");
                dadosParaArmazenar.itens = [];
            }
            
            console.log("EdicaoPedido: Dados do pedido armazenados para edição.", dadosParaArmazenar);
            dadosAtuais = dadosParaArmazenar;
        },

        /**
         * Retorna os dados do pedido que está em edição.
         * @returns {object|null} - Os dados do pedido ou null se não houver edição em andamento.
         */
        getDados: function() {
            return dadosAtuais;
        },

        /**
         * Limpa os dados após a edição ser concluída ou cancelada.
         */
        limpar: function() {
            console.log("EdicaoPedido: Limpando dados de edição.");
            dadosAtuais = null;
        },

        /**
         * Verifica se há um pedido em modo de edição.
         * @returns {boolean}
         */
        emEdicao: function() {
            return dadosAtuais !== null;
        }
    };
})();


        // Função para editar pedido - MELHORADA
        function editarPedido(numeroPedido) {
            console.log('✏️ Iniciando edição do pedido:', numeroPedido);
            const empresaAtual = JSON.parse(localStorage.getItem('empresaSelecionada') || '{}');
            
            showToast('Carregando dados do pedido para edição...', 'info');
            
            google.script.run
                .withSuccessHandler(response => {
                    console.log('📋 Resposta da busca para edição:', response);
                    if (response.status === 'success' && response.data && response.data.length > 0) {
                        const pedidoData = response.data[0];
                        
                        // Verificar se ainda pode editar
                        if (!verificarSePermiteEdicao(pedidoData)) {
                            showToast('Este pedido não pode mais ser editado. Edição disponível apenas por 1 hora após a criação.', 'warning');
                            return;
                        }
                        
                        // Armazenar dados no sistema de edição
                        EdicaoPedido.setDados(pedidoData);
                        
                        // Reutilizar a tela de pedido existente em modo edição
                        loadPageContent('Pedido', () => setupPedidoScreen(true, pedidoData));
                        showToast('Pedido carregado para edição. Você tem 1 hora para salvar as alterações.', 'success');
                        
                    } else {
                        showToast('Erro ao carregar dados do pedido.', 'error');
                    }
                })
                .withFailureHandler(err => {
                    showToast('Erro de comunicação ao buscar pedido.', 'error');
                    console.error('Erro ao buscar pedido para edição:', err);
                })
                .buscarPedidosv2(numeroPedido, empresaAtual.id);
        }

        function trocarSenha() {
            const senhaAtual = document.getElementById('senhaAtual').value.trim();
            const novaSenha = document.getElementById('novaSenha').value.trim();
            const confirmaSenha = document.getElementById('confirmaSenha').value.trim();
            const usuarioLogado = localStorage.getItem('usuarioLogado');

            if (!senhaAtual || !novaSenha || !confirmaSenha) {
                showToast('Preencha todos os campos', 'error', 'msgTrocaSenha');
                return;
            }

            if (novaSenha !== confirmaSenha) {
                showToast('As senhas não coincidem', 'error', 'msgTrocaSenha');
                return;
            }

            if (novaSenha.length < 6) {
                showToast('A nova senha deve ter pelo menos 6 caracteres', 'error', 'msgTrocaSenha');
                return;
            }

            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'ok') {
                        showToast('Senha alterada com sucesso!', 'success', 'Segurança');
                        setTimeout(() => {
                            loadPageContent('Menu', setupMenuScreen);
                        }, 2000);
                    } else {
                        showToast(response.message, 'error', 'Erro na Alteração');
                    }
                })
                .withFailureHandler(err => {
                    showToast('Erro ao alterar senha: ' + err.message, 'error', 'Falha na Conexão');
                })
                .alterarSenhaUsuario(usuarioLogado, senhaAtual, novaSenha);
        }

        // ===============================================
        // FUNÇÕES DE FORNECEDOR
        // ===============================================
        
        function preencherCombosFornecedor() {
            showToast('Carregando dados do fornecedor...', 'info', 'Carregando');
            console.log("[preencherCombosFornecedor] Iniciando busca de dados...");

            /**google.script.run
                .withSuccessHandler(codigo => {
                    const codigoInput = document.getElementById('codigo');
                    if (codigoInput) codigoInput.value = codigo;
                    console.log("[preencherCombosFornecedor] Código recebido:", codigo);
                    showToast('Dados carregados com sucesso!', 'success', 'Sucesso');
                })
                .withFailureHandler(error => {
                    console.error('[preencherCombosFornecedor] Erro ao buscar próximo código:', error);
                    showToast('Erro ao carregar código do fornecedor.', 'error', 'Erro');
                })
                .getProximoCodigoFornecedor();**/

            google.script.run
                .withSuccessHandler(condicoes => {
                    console.log('[preencherCombosFornecedor] Condições de pagamento recebidas:', condicoes);
                    populateSelect('condicao', condicoes, 'Selecione a Condição');
                })
                .withFailureHandler(error => {
                    console.error('[preencherCombosFornecedor] Erro ao buscar condições de pagamento:', error);
                    showToast('Erro ao carregar condições de pagamento.', 'error', 'Erro');
                })
                .getCondicoesPagamento();

            google.script.run
                .withSuccessHandler(formas => {
                    console.log('[preencherCombosFornecedor] Formas de pagamento recebidas:', formas);
                    populateSelect('forma', formas, 'Selecione a Forma');
                })
                .withFailureHandler(error => {
                    console.error('[preencherCombosFornecedor] Erro ao buscar formas de pagamento:', error);
                    showToast('Erro ao carregar formas de pagamento.', 'error', 'Erro');
                })
                .getFormasPagamento();
        }

        function salvarFornecedor(codigoOriginal) {
        const form = document.getElementById('form-fornecedor');
        const saveButton = document.getElementById('saveButton');

        if (!form || !saveButton) {
            console.error("Elementos do formulário de fornecedor não encontrados para salvar.");
            showToast("Erro interno: Elementos do formulário ausentes.", "error", "Erro Interno");
            return;
        }

        if (!form.checkValidity()) {
            showToast('Por favor, preencha todos os campos obrigatórios!', 'error', 'Campos Obrigatórios');
            form.reportValidity();
            return;
        }

        // --- CORREÇÃO PRINCIPAL ---
        // Mapeamos os campos do formulário para os nomes exatos que a função do backend espera.
        const fornecedorParaBackend = {
            codigo: codigoOriginal || '',
            razaoSocial: document.getElementById('razao').value.trim(),
            nomeFantasia: document.getElementById('fantasia').value.trim(),
            cnpj: document.getElementById('cnpj').value.trim(),
            endereco: document.getElementById('endereco').value.trim(),
            cidade: document.getElementById('cidade').value.trim(),
            estado: document.getElementById('estado').value.trim(),
            condicaoPagamento: document.getElementById('condicao').value.trim(),
            formaPagamento: document.getElementById('forma').value.trim(),
            grupo: document.getElementById('grupo').value.trim(),
            regimeTributario: document.getElementById('regimeTributarioInput').value || 'Outro'
        };

        // Se estamos editando, passamos o código original. Se não, passamos vazio.
        fornecedorParaBackend.codigo = codigoOriginal || ''; 

        saveButton.disabled = true;
        saveButton.innerText = 'Salvando...';
        showToast('Salvando fornecedor...', 'info', 'Processando');

        // --- SIMPLIFICAÇÃO ---
        // Chamamos sempre a mesma função no backend. Ela é inteligente o suficiente para saber se deve criar ou atualizar.
        google.script.run
            .withSuccessHandler(res => {
                saveButton.disabled = false;
                saveButton.innerText = 'Salvar';

                if (res.status === 'ok') {
                    if (codigoOriginal) {
                        // Se sim, volta para a lista de fornecedores
                        console.log('Edição concluída. Voltando para a lista de fornecedores.');
                        loadPageContent('GerenciarFornecedores', setupGerenciarFornecedoresScreen);
                    } else {
                        // Se não (era um novo cadastro), volta para o menu principal
                        console.log('Novo cadastro concluído. Voltando para o menu.');
                        loadPageContent('Menu', setupMenuScreen);
                    }
                } else {
                    // Mostra a mensagem de erro que veio diretamente do backend (ex: "CNPJ já existe")
                    showToast(res.message || 'Erro ao salvar fornecedor.', 'error', 'Erro no Salvamento');
                }
            })
            .withFailureHandler(error => {
                saveButton.disabled = false;
                saveButton.innerText = 'Salvar';
                console.error('Erro na comunicação com o servidor (salvarFornecedor):', error);
                showToast('Ocorreu um erro inesperado ao salvar. Tente novamente.', 'error', 'Erro de Comunicação');
            })
            .adicionarOuAtualizarFornecedorv2(fornecedorParaBackend); // Chamada única e correta
    }
                
        /**
         * Formata um valor para o padrão de CPF (se tiver até 11 dígitos) 
         * ou CNPJ (se tiver mais de 11 dígitos).
         */
        function formatarCpfCnpj(valor) {
            // 1. Remove tudo que não for número
            const apenasNumeros = valor.replace(/\D/g, '');

            // 2. Verifica o tamanho e aplica a máscara correta
            if (apenasNumeros.length <= 11) {
                // É um CPF
                return apenasNumeros
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d)/, '$1.$2')
                    .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            } else {
                // É um CNPJ
                return apenasNumeros.slice(0, 14) // Limita a 14 dígitos
                    .replace(/^(\d{2})(\d)/, '$1.$2')
                    .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
                    .replace(/\.(\d{3})(\d)/, '.$1/$2')
                    .replace(/(\d{4})(\d)/, '$1-$2');
            }
        }

        /**
         * Valida um CNPJ (verifica o formato e os dígitos verificadores).
         * @param {string} cnpj - O CNPJ a ser validado.
         * @returns {boolean} - Retorna true se o CNPJ for válido.
         */
        function validarCnpj(cnpj) {
            if (!cnpj) return false;

            // Remove caracteres especiais e espaços
            const apenasNumeros = cnpj.replace(/[^\d]+/g, '');

            // CNPJ deve ter 14 dígitos
            if (apenasNumeros.length !== 14) return false;

            // Elimina CNPJs inválidos conhecidos (todos os números iguais)
            if (/^(\d)\1+$/.test(apenasNumeros)) return false;

            // Validação dos dígitos verificadores
            let tamanho = apenasNumeros.length - 2;
            let numeros = apenasNumeros.substring(0, tamanho);
            let digitos = apenasNumeros.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;

            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(0)) return false;

            tamanho = tamanho + 1;
            numeros = apenasNumeros.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }

            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(1)) return false;

            return true;
        }

        // Função para lidar com o clique do botão "Consultar"
        function handleConsultarCnpj() {
            const cnpjInput = document.getElementById('cnpj');
            const consultarBtn = document.getElementById('consultarCnpjBtn');
            const cnpj = cnpjInput.value;

            if (!validarCnpj(cnpj)) {
                showToast('O CNPJ digitado é inválido.', 'error', 'CNPJ Inválido');
                return;
            }
            
            showToast('Consultando CNPJ...', 'info', 'Consultando');
            consultarBtn.disabled = true;
            consultarBtn.textContent = '...';

            google.script.run
                .withSuccessHandler(response => {
                    if (response && response.status === 'ok') {
                      const razao = response.data.razaoSocial || '';
                      const fantasia = response.data.nomeFantasia || razao;
                      
                        document.getElementById('razao').value = response.data.razaoSocial || '';
                        document.getElementById('fantasia').value = response.data.nomeFantasia || '';
                        document.getElementById('endereco').value = response.data.endereco || '';
                        document.getElementById('regimeTributarioInput').value = response.data.regimeTributario || 'Outro';
                        
                        // Preencher o estado se disponível na resposta da API
                        const estadoSelect = document.getElementById('estado');
                        if (estadoSelect && response.data.uf) {
                            estadoSelect.value = response.data.uf;
                        }
                        // Preencher a cidade
                        const cidadeInput = document.getElementById('cidade');
                        if (cidadeInput && (response.data.municipio || response.data.cidade)) {
                           cidadeInput.value = response.data.municipio || response.data.cidade || '';
                        }
                        showToast('Dados preenchidos com sucesso!', 'success', 'CNPJ Consultado');
                    } else {
                        showToast(response.message, 'error', 'Erro na Consulta');
                    }
                    consultarBtn.disabled = false;
                    consultarBtn.textContent = 'Consultar';
                })
                .withFailureHandler(err => {
                    showToast('Erro de comunicação ao consultar CNPJ.', 'error', 'Erro de Comunicação');
                    consultarBtn.disabled = false;
                    consultarBtn.textContent = 'Consultar';
                })
                .consultarCnpj_V2(cnpj);
        }

        // Função para forçar maiúsculas
        function forceUppercase(event) {
            const input = event.target;
            input.value = input.value.toUpperCase();
        }

        // Função para popular selects
        function populateSelect(selectId, options, placeholder) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.warn(`Select com ID '${selectId}' não encontrado`);
                return;
            }

            select.innerHTML = '';
            
            // Adicionar opção placeholder
            if (placeholder) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = placeholder;
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);
            }

            // Adicionar opções
            if (Array.isArray(options)) {
                options.forEach(option => {
                    const opt = document.createElement('option');
                    if (typeof option === 'string') {
                        opt.value = option;
                        opt.textContent = option;
                    } else if (option.value !== undefined && option.text !== undefined) {
                        opt.value = option.value;
                        opt.textContent = option.text;
                    } else {
                        console.warn('Formato de opção inválido:', option);
                    }
                    select.appendChild(opt);
                });
            }
        }

        // Funções antigas de fornecedor (manter compatibilidade)
        function carregarCondicoesPagamento() {
            google.script.run
                .withSuccessHandler(condicoes => {
                    populateSelect('condicao', condicoes, 'Selecione a Condição');
                })
                .withFailureHandler(error => {
                    console.error('Erro ao buscar condições de pagamento:', error);
                    showToast('Erro ao carregar condições de pagamento.', 'error', 'Erro');
                })
                .getCondicoesPagamento();
        }

        function carregarFormasPagamento() {
            google.script.run
                .withSuccessHandler(formas => {
                    populateSelect('forma', formas, 'Selecione a Forma');
                })
                .withFailureHandler(error => {
                    console.error('Erro ao buscar formas de pagamento:', error);
                    showToast('Erro ao carregar formas de pagamento.', 'error', 'Erro');
                })
                .getFormasPagamento();
        }
       
        function carregarListaFornecedores() {
          const tbody = document.getElementById('fornecedoresTableBody');
          const msg = document.getElementById('fornecedorListMessage');
          showToast('Carregando fornecedores...', 'info', 'fornecedorListMessage');

          google.script.run
              .withSuccessHandler(fornecedores => {
                  if (msg) msg.textContent = '';
                  tbody.innerHTML = '';

            if (!fornecedores || fornecedores.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-10">Nenhum fornecedor encontrado.</td></tr>';
                return;
            }

            fornecedores.forEach(fornecedor => {
                const row = document.createElement('tr');
                // Estilo para a linha inativa (continua igual)
                const rowClass = fornecedor.status === 'INATIVO' ? 'bg-gray-50 opacity-60' : '';
                row.className = `border-b ${rowClass}`;
                
                // Determina se o interruptor deve estar 'ligado' (checked)
                const isAtivo = fornecedor.status === 'ATIVO';
                const badgeClass = isAtivo 
                ? 'bg-green-100 text-green-800' 
                : 'bg-gray-200 text-gray-800';

                row.innerHTML = `
                    <td class="px-6 py-4">${fornecedor.codigo}</td>
                    <td class="px-6 py-4">${fornecedor.razaoSocial || ''}</td>
                    <td class="px-6 py-4">${fornecedor.nomeFantasia || ''}</td>
                    <td class="px-6 py-4">${fornecedor.cnpj || ''}</td>
                    <td class="px-6 py-4">${fornecedor.grupo || ''}</td>
                    <td class="px-6 py-4 text-center">
                         <td class="px-6 py-4 text-center">
                            <span class="badge-status-toggle px-3 py-1 text-xs font-semibold leading-5 rounded-full cursor-pointer transition hover:opacity-80 ${badgeClass}"
                                  data-codigo="${fornecedor.codigo}">
                                ${fornecedor.status}
                            </span>
                        </td>

                        <td class="px-6 py-4 text-center">
                            <button class="btn-editar-fornecedor px-3 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded hover:bg-blue-200 transition" 
                                    data-codigo="${fornecedor.id}">
                                <i class="fas fa-edit mr-1"></i> Editar
                            </button>
                        </td>
                        `;
                tbody.appendChild(row);
            });

            addEditFornecedorListeners();
        })
        .withFailureHandler(error => {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 py-10">Erro ao carregar fornecedores.</td></tr>';
            if (msg) msg.textContent = 'Erro ao carregar fornecedores.';
            console.error(error);
        })
        .getFornecedoresParaGerenciamento();
        
}

      /**function addEditFornecedorListeners() {
         document.querySelectorAll('.btn-editar-fornecedor').forEach(btn => {
          btn.addEventListener('click', function() {
            const codigo = btn.dataset.codigo;
            console.log("Editar fornecedor:", codigo);
            loadPageContent('CadastroFornecedor', () => setupCadastroFornecedorScreen(codigo));
          });
        });
      }**/

        // ===============================================
        // FUNÇÕES DE RETRY PARA CARREGAMENTO DOS SELECTS
        // ===============================================

        // Função melhorada para aguardar carregamento dos selects
        async function aguardarSelectsCarregados(maxTentativas = 10, intervalo = 500) {
            console.log("🔍 Aguardando carregamento dos selects...");
            
            for (let tentativa = 1; tentativa <= maxTentativas; tentativa++) {
                const selectFornecedor = document.getElementById('fornecedorPedido');
                const selectVeiculo = document.getElementById('nomeVeiculo');
                
                console.log(`⏳ Tentativa ${tentativa}/${maxTentativas}`);
                
                if (selectFornecedor && selectVeiculo) {
                    const fornecedorCarregado = selectFornecedor.options.length > 1;
                    const veiculoCarregado = selectVeiculo.options.length > 1;
                    
                    console.log(`📊 Fornecedor: ${fornecedorCarregado ? '✅' : '❌'} (${selectFornecedor.options.length} options)`);
                    console.log(`📊 Veículo: ${veiculoCarregado ? '✅' : '❌'} (${selectVeiculo.options.length} options)`);
                    
                    if (fornecedorCarregado && veiculoCarregado) {
                        console.log("✅ Ambos selects carregados com sucesso!");
                        return true;
                    }
                } else {
                    console.log("❌ Elementos select não encontrados no DOM");
                }
                
                // Aguardar antes da próxima tentativa
                await new Promise(resolve => setTimeout(resolve, intervalo));
            }
            
            console.log("⚠️ Timeout: Selects não carregaram no tempo esperado");
            return false;
        }

        // Função de preenchimento com retry
        async function preencherFormularioComRetry(dados) {
            console.log("=== INICIANDO PREENCHIMENTO COM RETRY ===");
            
            try {
                // Aguardar carregamento dos selects
                const selectsCarregados = await aguardarSelectsCarregados();
                
                if (!selectsCarregados) {
                    console.log("🔄 Selects não carregaram, tentando recarregar dados...");
                    // Recarregar fornecedores e veículos
                    await recarregarDadosSelects();
                    
                    // Tentar novamente
                    const segundaTentativa = await aguardarSelectsCarregados(5, 1000);
                    if (!segundaTentativa) {
                        throw new Error("Falha ao carregar selects após retry");
                    }
                }
                
                // Agora preencher com segurança
                await preencherCamposFormulario(dados);
                
            } catch (error) {
                console.error("❌ Erro no preenchimento com retry:", error);
                showGlobalModal("Erro", "Erro ao carregar dados do pedido: " + error.message);
            }
        }

        // Função para recarregar dados dos selects
        async function recarregarDadosSelects() {
            console.log("🔄 Recarregando dados dos selects...");
            
            return Promise.all([
                new Promise((resolve) => {
                    google.script.run
                        .withSuccessHandler(fornecedores => {
                            const selectFornecedor = document.getElementById('fornecedorPedido');
                            if (selectFornecedor) {
                                selectFornecedor.innerHTML = '<option value="">Selecione um Fornecedor</option>';
                                fornecedores.forEach(f => {
                                    const option = document.createElement('option');
                                    option.value = f.razao || f.codigo;
                                    option.textContent = f.razao || f.codigo;
                                    selectFornecedor.appendChild(option);
                                });
                            }
                            resolve(fornecedores);
                        })
                        .withFailureHandler(() => resolve([]))
                        .getFornecedoresListv2();
                }),
                new Promise((resolve) => {
                    google.script.run
                        .withSuccessHandler(veiculos => {
                            const selectVeiculo = document.getElementById('nomeVeiculo');
                            if (selectVeiculo) {
                                selectVeiculo.innerHTML = '<option value="">Selecione um veículo</option>';
                                console.log('📋 Recarregar - Dados brutos dos veículos:', veiculos);
                                
                                veiculos.forEach((v, index) => {
                                    // Tentar diferentes propriedades para encontrar o nome
                                    let nomeVeiculo = null;
                                    
                                    if (typeof v === 'string' && v.trim() !== '' && v !== 'undefined') {
                                        nomeVeiculo = v.trim();
                                    } else if (typeof v === 'object' && v !== null) {
                                        nomeVeiculo = v.nomeVeiculo || v.nome || v.veiculo || v.descricao;
                                    }
                                    
                                    if (nomeVeiculo && nomeVeiculo.trim() !== '' && nomeVeiculo !== 'undefined') {
                                        const option = document.createElement('option');
                                        option.value = nomeVeiculo.trim();
                                        option.textContent = nomeVeiculo.trim();
                                        selectVeiculo.appendChild(option);
                                    } else {
                                        console.warn(`⚠️ Recarregar - Veículo inválido no índice ${index}:`, v);
                                    }
                                });
                            }
                            resolve(veiculos);
                        })
                        .withFailureHandler(() => resolve([]))
                        .getVeiculosList();
                })
            ]);
        }

        // Função melhorada para preencher campos do formulário
        async function preencherCamposFormulario(dados) {
            console.log("📝 Preenchendo campos do formulário...");
            
            // Preencher campos básicos
            const numeroPedido = document.getElementById('numeroPedido');
            if (numeroPedido) {
                numeroPedido.value = dados.numeroDoPedido || '';
                console.log(`✅ Número do pedido: ${dados.numeroDoPedido}`);
            }

            const dataPedido = document.getElementById('dataPedido');
            if (dataPedido) {
                dataPedido.value = dados.data || '';
                console.log(`✅ Data: ${dados.data}`);
            }

            const placaVeiculo = document.getElementById('placaVeiculo');
            if (placaVeiculo) {
                placaVeiculo.value = dados.placaVeiculo || '';
                console.log(`✅ Placa: ${dados.placaVeiculo}`);
            }

            const observacoes = document.getElementById('observacoesPedido');
            if (observacoes) {
                observacoes.value = dados.observacoes || '';
                console.log(`✅ Observações: ${dados.observacoes || 'Vazio'}`);
            }

            // Preencher total
            const totalGeral = document.getElementById('totalGeral');
            if (totalGeral && dados.totalGeral) {
                const valorFormatado = `R$ ${parseFloat(dados.totalGeral).toFixed(2).replace('.', ',')}`;
                totalGeral.value = valorFormatado;
                console.log(`✅ Total: ${valorFormatado}`);
            }

            // Preencher selects
            const selectFornecedor = document.getElementById('fornecedorPedido');
            if (selectFornecedor && dados.fornecedor) {
                selectFornecedor.value = dados.fornecedor;
                console.log(`✅ Fornecedor selecionado: ${dados.fornecedor}`);
            }

            const selectVeiculo = document.getElementById('nomeVeiculo');
            if (selectVeiculo && dados.nomeVeiculo) {
                selectVeiculo.value = dados.nomeVeiculo;
                console.log(`✅ Veículo selecionado: ${dados.nomeVeiculo}`);
            }

            // Preencher itens
            if (dados.itens && Array.isArray(dados.itens)) {
                console.log(`Preenchendo ${dados.itens.length} itens...`);
                preencherItensContainer(dados.itens);
            }

            // Ativar modo visualização
            desabilitarEdicaoPedido();
            console.log("✅ Preenchimento concluído com sucesso!");
        }

        // Função auxiliar global para impressão direta (usada nos cards do dashboard)
        function imprimirPedidoDireto(numeroPedido, empresaId) {
            iniciarImpressao(numeroPedido, empresaId);
        }

          /**
           * ===================================================================
           * FUNÇÃO #1: A "GRÁFICA" (RENDERIZADORA)
           * ===================================================================
           * Recebe um objeto com todos os dados já prontos e é a ÚNICA responsável 
           * por preencher o template HTML e abrir a janela de impressão.
           * @param {object} pedidoCompleto - O objeto completo do pedido, já com os dados da empresa.
           */
        function gerarDocumentoParaImpressao(pedidoCompleto, debugMode = false) {
    try {
        // --- Funções Auxiliares (sem alterações) ---
        const formatarMoeda = (valor) => {
            const numero = parseFloat(valor || 0);
            return 'R$ ' + numero.toFixed(2).replace('.', ',');
        };
        
        // --- LÓGICA DE GERAÇÃO DO LAYOUT (VERSÃO MODERNA) ---
        const construirLayoutModerno = (doc, pedido) => {
            console.log("Iniciando construção de layout moderno do zero...");
            const empresa = pedido.empresaInfo || {};
            const fornecedor = pedido.fornecedorInfo || {};
            const itens = pedido.itens || [];

            // Limpa completamente o corpo do documento para ignorar o template original
            doc.body.innerHTML = '';
            doc.body.style.fontFamily = "'Segoe UI', 'Roboto', 'Arial', sans-serif";
            doc.body.style.margin = '20px';
            doc.body.style.color = '#333';

            doc.title = 'Pedido de Compra - ' + (pedido.numeroDoPedido || 'N/A');

            // --- Seção 1: Cabeçalho ---
            const header = doc.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'flex-start';
            header.style.borderBottom = '2px solid #000';
            header.style.paddingBottom = '15px';
            header.style.marginBottom = '20px';
            
            const logoContainer = doc.createElement('div');
            if (empresa.logourl) {
                const logoImg = doc.createElement('img');
                logoImg.src = empresa.logourl;
                logoImg.style.maxWidth = '150px';
                logoImg.style.maxHeight = '70px';
                logoImg.classList.add('company-logo');
                logoContainer.appendChild(logoImg);
            }
            
            const infoEmpresa = doc.createElement('div');
            infoEmpresa.style.textAlign = 'left';
            infoEmpresa.style.lineHeight = '1.5';
            infoEmpresa.innerHTML = `
                <strong style="font-size: 16px;">${empresa.nome || empresa.empresa || ''}</strong><br>
                <span style="font-size: 12px; color: #555;">${empresa.endereco || ''} - ${empresa.cidadeuf || ''}</span><br>
                <span style="font-size: 12px; color: #555;">CNPJ: ${empresa.cnpj || ''}</span>
            `;

            const infoContato = doc.createElement('div');
            infoContato.style.textAlign = 'right';
            infoContato.style.fontSize = '12px';
            infoContato.style.lineHeight = '1.5';
            infoContato.innerHTML = `
                <strong style="color: #555;"Email:</strong> ${empresa.email || ''}<br>
                <strong style="color: #555;"Telefone:</strong> ${empresa.telefone || ''}
            `;
            
            header.appendChild(logoContainer);
            header.appendChild(infoEmpresa);
            header.appendChild(infoContato);
            doc.body.appendChild(header);

            // --- Seção 2: Informações do Pedido e Fornecedor ---
            const infoGeral = doc.createElement('div');
            infoGeral.style.display = 'flex';
            infoGeral.style.justifyContent = 'space-between';
            infoGeral.style.padding = '10px';
            infoGeral.style.backgroundColor = '#f8f9fa';
            infoGeral.style.borderRadius = '5px';
            infoGeral.style.marginBottom = '20px';
            infoGeral.style.fontSize = '12px';
            infoGeral.style.border = '1px solid #dee2e6';

            const dataPedidoObj = new Date(pedido.data || Date.now());
            infoGeral.innerHTML = `
                <div>
                    <strong>PEDIDO Nº:</strong><br>
                    <span style="font-size: 16px; color: #007bff;font-weight: bold;">${pedido.numeroDoPedido || 'N/A'}</span>
                </div>
                <div style="text-align: right;">
                    <strong>DATA DE EMISSÃO:</strong><br>
                    <span style="font-size: 16px; font-weight: bold;">${dataPedidoObj.toLocaleDateString('pt-BR')}</span>
                </div>
            `;
            doc.body.appendChild(infoGeral);

            const infoFornecedor = doc.createElement('div');
            infoFornecedor.style.border = '1px solid #ddd';
            infoFornecedor.style.padding = '15px';
            infoFornecedor.style.marginBottom = '20px';
            infoFornecedor.style.borderRadius = '5px';
            infoFornecedor.style.fontSize = '12px';
            infoFornecedor.innerHTML = `
                <strong style="font-size: 14px; display: block; margin-bottom: 10px;">INFORMAÇÕES DO FORNECEDOR</strong>
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <strong>Fornecedor:</strong> ${pedido.fornecedor || ''}<br>
                        <strong>Endereço:</strong> ${fornecedor.endereco || ''}<br>
                        <strong>CNPJ:</strong> ${fornecedor.cnpj || ''}
                    </div>
                    <div style="text-align: right;">
                        <strong>Condição de Pagamento:</strong> ${fornecedor.condicaoDePagamento || ''}<br>
                        <strong>Forma de Pagamento:</strong> ${fornecedor.formaDePagamento || ''}
                    </div>
                </div>
            `;
            doc.body.appendChild(infoFornecedor);


            // --- Seção 3: Tabela de Itens ---
            const tabelaContainer = doc.createElement('div');
            const tabela = doc.createElement('table');
            tabela.style.width = '100%';
            tabela.style.borderCollapse = 'collapse';
            tabela.style.marginBottom = '20px';
            tabela.innerHTML = `
                <thead style="background-color: #343a40; color: #fff; font-size: 12px;">
                    <tr>
                        <th style="padding: 10px; text-align: center; width: 5%;">#</th>
                        <th style="padding: 10px; text-align: left;">DESCRIÇÃO</th>
                        <th style="padding: 10px; text-align: center; width: 10%;">UN</th>
                        <th style="padding: 10px; text-align: center; width: 10%;">QTD</th>
                        <th style="padding: 10px; text-align: right; width: 15%;">VALOR UNIT.</th>
                        <th style="padding: 10px; text-align: right; width: 15%;">SUBTOTAL</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tBody = tabela.querySelector('tbody');
            if (itens.length > 0) {
                itens.forEach((item, index) => {
                    const codigoFornecedor = item.codigoProdutoFornecedor || item.produtoFornecedor || 'N/A';
                    const tr = doc.createElement('tr');
                    tr.style.borderBottom = '1px solid #ddd';
                    tr.style.fontSize = '12px';
                    tr.style.backgroundColor = index % 2 === 0 ? '#fff' : '#f8f9fa';
                    tr.innerHTML = `
                        <td style="padding: 8px; text-align: center;">${index + 1}</td>
                        <td style="padding: 8px; text-align: left;">
                            ${item.descricao || ''}
                            <div style="font-size: 10px;">
                                Cód. Forn: <strong style="color: #dc3545;">${codigoFornecedor}</strong>
                            </div>
                        </td>
                        <td style="padding: 8px; text-align: center;">${item.unidade || ''}</td>
                        <td style="padding: 8px; text-align: center;">${item.quantidade || 0}</td>
                        <td style="padding: 8px; text-align: right;">${formatarMoeda(item.precoUnitario)}</td>
                        <td style="padding: 8px; text-align: right;">${formatarMoeda(item.totalItem)}</td>
                    `;
                    tBody.appendChild(tr);
                });
            } else {
                 tBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">Nenhum item neste pedido.</td></tr>';
            }
            tabelaContainer.appendChild(tabela);
            doc.body.appendChild(tabelaContainer);
            
            // --- Seção 4: Total e Observações ---
            const footer = doc.createElement('div');
            footer.style.display = 'flex';
            footer.style.justifyContent = 'space-between';
            footer.style.alignItems = 'flex-start';
            footer.style.marginTop = '20px';
            
            const obsContainer = doc.createElement('div');
            obsContainer.style.fontSize = '12px';
            obsContainer.style.maxWidth = '60%';
            obsContainer.innerHTML = `<strong>Observações:</strong><br>${pedido.observacoes || 'Sem observações.'}`;
            
            const totalContainer = doc.createElement('div');
            totalContainer.style.textAlign = 'right';
            totalContainer.style.width = '35%';
            const subtotal = pedido.totalGeral || 0;
            const imposto = pedido.icmsStTotal || 0;
            const totalFinal = subtotal + imposto;
            
            totalContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
                    <span>Subtotal:</span>
                    <span>${formatarMoeda(subtotal)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px;">
                    <span>Imposto (ICMS-ST):</span>
                    <span>${formatarMoeda(imposto)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px; color: #007bff;">
                    <span>VALOR TOTAL:</span>
                    <span>${formatarMoeda(totalFinal)}</span>
                </div>
            `;
            
            footer.appendChild(obsContainer);
            footer.appendChild(totalContainer);
            doc.body.appendChild(footer);

            // --- Seção 5: Aviso de Alteração ---
            const avisoContainer = doc.createElement('div');
            avisoContainer.textContent = "Atenção: Qualquer alteração só pode ser realizada mediante autorização prévia, sob risco de não pagamento.";
            avisoContainer.style.color = '#dc3545';
            avisoContainer.style.fontSize = '11px';
            avisoContainer.style.marginTop = '25px';
            avisoContainer.style.textAlign = 'center';
            avisoContainer.style.border = '1px solid #f5c6cb';
            avisoContainer.style.padding = '8px';
            avisoContainer.style.borderRadius = '4px';
            avisoContainer.style.backgroundColor = '#f8d7da';
            doc.body.appendChild(avisoContainer);


            // --- Seção 6: Assinatura ---
            const assinaturaContainer = doc.createElement('div');
            assinaturaContainer.style.textAlign = 'center';
            assinaturaContainer.style.marginTop = '80px';
            const nomeUsuario = localStorage.getItem('nome');
            const perfilUsuario = localStorage.getItem('funcao');
            assinaturaContainer.innerHTML = `
                <div style="display: inline-block; border-top: 1px solid #000; width: 280px; padding-top: 5px; font-size: 12px;">
                    <strong style="font-size: 13px;">${nomeUsuario ? nomeUsuario.toUpperCase() : ''}</strong><br>
                    <span>${perfilUsuario ? perfilUsuario.toUpperCase() : ''}</span>
                </div>
            `;
            doc.body.appendChild(assinaturaContainer);

            console.log("Layout moderno construído com sucesso.");
        };

        // --- Execução (sem alterações) ---
        const pageHtml = `<html><head><title></title></head><body></body></html>`; // Um template em branco

        if (debugMode) {
            console.log('%c--- MODO DE DEPURAÇÃO ATIVADO ---', 'color: #fff; background-color: #f0ad4e; padding: 4px; border-radius: 4px;');
            let container = document.getElementById('debugPrintContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'debugPrintContainer';
                container.style.border = '2px dashed red';
                container.style.padding = '10px';
                container.style.marginTop = '20px';
                document.body.appendChild(container);
            }
            // Para debug, usamos um 'doc' simulado (o próprio container)
            container.innerHTML = '';
            construirLayoutModerno({ body: container, title: '' }, pedidoCompleto); 
            console.log('%c--- FIM DO MODO DE DEPURAÇÃO ---', 'color: #fff; background-color: #f0ad4e; padding: 4px; border-radius: 4px;');
        } else {
            const iframe = document.createElement('iframe');
            iframe.style.position = 'absolute';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.style.border = '0';
            document.body.appendChild(iframe);

            const printDoc = iframe.contentWindow.document;

            iframe.onload = function() {
                construirLayoutModerno(printDoc, pedidoCompleto);

                const logoImg = printDoc.querySelector('.company-logo');

                const triggerPrint = () => {
                    iframe.contentWindow.focus();
                    iframe.contentWindow.print();
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 1000);
                };
                
                if (!logoImg || !logoImg.src) {
                    setTimeout(triggerPrint, 50);
                    //triggerPrint();
                    return;
                }
                
                if (logoImg.complete) {
                    triggerPrint();
                    } else {
                    logoImg.onload = triggerPrint;
                    logoImg.onerror = function() {
                        console.error("Falha ao carregar a imagem da logo. URL:", logoImg.src);
                        triggerPrint(); 
                    };
                }
            };
                

            printDoc.open();
            printDoc.write(pageHtml);
            printDoc.close();
        }

    } catch (error) {
        console.error("Erro CRÍTICO ao gerar documento para impressão:", error);
        showGlobalModal('Erro Crítico', 'Não foi possível gerar o documento para impressão. Verifique a consola para mais detalhes.');
    }
}

          /**
           * ===================================================================
           * FUNÇÃO #2: A "GERENTE" (ORQUESTRADORA)
           * ===================================================================
           * Ponto de entrada para qualquer impressão. Recebe os IDs, busca os dados 
           * no back-end e, se bem-sucedido, chama a função de renderização.
           * @param {string} numeroPedido - O número do pedido a imprimir.
           * @param {string} empresaId - O ID da empresa do pedido.
           */
          async function iniciarImpressao(numeroPedido, empresaId) {
            if (!numeroPedido || !empresaId) {
              showGlobalModal('Erro', 'Dados insuficientes para imprimir (Nº Pedido e ID da Empresa são obrigatórios).');
              return;
            }
            
            showToast(`Preparando impressão do pedido ${numeroPedido}...`, null, 'Aguarde');
            
            try {
              const pedidoCompleto = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .getPedidoCompletoPorId(numeroPedido, empresaId);
              });

               console.log("📦 Dados completos recebidos do back-end:", pedidoCompleto);
              if (pedidoCompleto) {
            // --- CÓDIGO DE DIAGNÓSTICO CORRIGIDO ---
            // Agora verificamos a propriedade correta: 'fornecedorInfo'
            if (pedidoCompleto.fornecedorInfo && Object.keys(pedidoCompleto.fornecedorInfo).length > 0) {
                console.log("✅ SUCESSO: Informações do Fornecedor foram encontradas e anexadas:", pedidoCompleto.fornecedorInfo);
            } else {
                // Este aviso agora só aparecerá se 'fornecedorInfo' realmente não existir
                console.warn("⚠️ FALHA: Informações do Fornecedor (fornecedorInfo) não foram encontradas. Verifique se o nome do fornecedor corresponde exatamente na aba 'Pedidos' e 'Fornecedores'.");
            }
            // --- FIM DO CÓDIGO DE DIAGNÓSTICO ---
            
            gerarDocumentoParaImpressao(pedidoCompleto);
        } else {
            showGlobalModal('Erro', 'Não foi possível encontrar os dados do pedido para impressão.');
        }
    } catch (error) {
        console.error("Erro ao iniciar impressão:", error);
        showGlobalModal('Erro', `Falha ao buscar dados do pedido: ${error.message || error}`);
    }
}

        // ===============================================
        // FUNÇÕES GLOBAIS PARA GERENCIAR RASCUNHOS
        // ===============================================
        
        function editarRascunho(rascunhoId) {
            console.log('✏️ Editando rascunho:', rascunhoId);
            
            showToast('Carregando rascunho para edição...', 'info');
            
            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success' && response.rascunho) {
                        // Salvar dados do rascunho para edição
                        localStorage.setItem('editandoRascunho', 'true');
                        localStorage.setItem('rascunhoId', rascunhoId);
                        localStorage.setItem('dadosRascunho', JSON.stringify(response.rascunho));
                        
                        // Ir para tela de pedido
                        loadPageContent('Pedido', setupPedidoScreen);
                        
                        // Aguardar carregamento da tela e preencher dados
                        setTimeout(() => {
                            preencherFormularioComRascunho(response.rascunho);
                            mostrarIndicadorRascunho(rascunhoId);
                        }, 500);
                        
                    } else {
                        showToast('Erro ao carregar rascunho: ' + response.message, 'error');
                    }
                })
                .withFailureHandler(error => {
                    console.error('Erro ao buscar rascunho:', error);
                    showToast('Erro de comunicação: ' + error.message, 'error');
                })
                .buscarRascunhoPorId(rascunhoId);
        }
        
        function finalizarRascunho(rascunhoId) {
            console.log('✅ Finalizando rascunho:', rascunhoId);
            
            const modal = document.getElementById('global-modal');
            if (!modal) {
                console.error('Modal global não encontrado');
                return;
            }
            
            // Configurar o modal com conteúdo customizado
            const modalTitle = modal.querySelector('#modal-title');
            const modalMessage = modal.querySelector('#modal-message');
            
            if (modalTitle) modalTitle.textContent = 'Finalizar Rascunho';
            if (modalMessage) modalMessage.textContent = `Deseja finalizar o rascunho ${rascunhoId} como um pedido oficial? Esta ação não pode ser desfeita.`;
            
            // Substituir o botão OK padrão por botões customizados
            const modalContainer = modal.querySelector('.bg-white');
            const existingButton = modal.querySelector('#modal-close-btn');
            
            if (existingButton) {
                existingButton.remove();
            }
            
            // Criar container para os botões
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'flex space-x-4 mt-4';
            actionsContainer.innerHTML = `
                <button id="cancelarFinalizacao" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
                <button id="confirmarFinalizacao" class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Finalizar</button>
            `;
            
            modalContainer.appendChild(actionsContainer);
            
            // Mostrar o modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Eventos dos botões
            document.getElementById('cancelarFinalizacao').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                restaurarModalPadrao(modal);
            });
            
            document.getElementById('confirmarFinalizacao').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                restaurarModalPadrao(modal);
                processarFinalizacaoRascunho(rascunhoId);
            });
        }
        
        function restaurarModalPadrao(modal) {
            // Remove os botões customizados e restaura o botão OK padrão
            const actionsContainer = modal.querySelector('.flex.space-x-4');
            if (actionsContainer) {
                actionsContainer.remove();
            }
            
            const modalContainer = modal.querySelector('.bg-white');
            const okButton = document.createElement('button');
            okButton.id = 'modal-close-btn';
            okButton.className = 'px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700';
            okButton.textContent = 'OK';
            okButton.addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            
            modalContainer.appendChild(okButton);
        }
        
        function processarFinalizacaoRascunho(rascunhoId) {
            showToast('Finalizando rascunho...', 'info');
            
            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success') {
                        showToast(`Rascunho finalizado com sucesso! Pedido: ${response.numeroPedido}`, 'success', 'Pedido Criado');
                        
                        // Recarregar lista de rascunhos
                        if (typeof setupGerenciarRascunhosScreen === 'function') {
                            setupGerenciarRascunhosScreen();
                        }
                    } else {
                        showToast('Erro ao finalizar rascunho: ' + response.message, 'error');
                    }
                })
                .withFailureHandler(error => {
                    console.error('Erro ao finalizar rascunho:', error);
                    showToast('Erro de comunicação: ' + error.message, 'error');
                })
                .finalizarRascunho(rascunhoId);
        }
        
        function excluirRascunho(rascunhoId) {
            console.log('🗑️ Excluindo rascunho:', rascunhoId);
            
            const modal = document.getElementById('global-modal');
            if (!modal) {
                console.error('Modal global não encontrado');
                return;
            }
            
            // Configurar o modal com conteúdo customizado
            const modalTitle = modal.querySelector('#modal-title');
            const modalMessage = modal.querySelector('#modal-message');
            
            if (modalTitle) modalTitle.textContent = 'Excluir Rascunho';
            if (modalMessage) modalMessage.textContent = `Tem certeza que deseja excluir o rascunho ${rascunhoId}? Esta ação não pode ser desfeita.`;
            
            // Substituir o botão OK padrão por botões customizados
            const modalContainer = modal.querySelector('.bg-white');
            const existingButton = modal.querySelector('#modal-close-btn');
            
            if (existingButton) {
                existingButton.remove();
            }
            
            // Criar container para os botões
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'flex space-x-4 mt-4';
            actionsContainer.innerHTML = `
                <button id="cancelarExclusao" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
                <button id="confirmarExclusao" class="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Excluir</button>
            `;
            
            modalContainer.appendChild(actionsContainer);
            
            // Mostrar o modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Eventos dos botões
            document.getElementById('cancelarExclusao').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                restaurarModalPadrao(modal);
            });
            
            document.getElementById('confirmarExclusao').addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                restaurarModalPadrao(modal);
                processarExclusaoRascunho(rascunhoId);
            });
        }
        
        function processarExclusaoRascunho(rascunhoId) {
            showToast('Excluindo rascunho...', 'info');
            
            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success') {
                        showToast('Rascunho excluído com sucesso!', 'success');
                        
                        // Recarregar lista de rascunhos
                        if (typeof setupGerenciarRascunhosScreen === 'function') {
                            setupGerenciarRascunhosScreen();
                        }
                    } else {
                        showToast('Erro ao excluir rascunho: ' + response.message, 'error');
                    }
                })
                .withFailureHandler(error => {
                    console.error('Erro ao excluir rascunho:', error);
                    showToast('Erro de comunicação: ' + error.message, 'error');
                })
                .excluirRascunho(rascunhoId);
        }
        
        function preencherFormularioComRascunho(dadosRascunho) {
            console.log('📝 Preenchendo formulário com dados do rascunho:', dadosRascunho);
            
            // Função para tentar preencher fornecedor com retry
            function tentarPreencherFornecedor(tentativa = 1, maxTentativas = 10) {
                const fornecedorSelect = document.getElementById('fornecedorPedido');
                
                if (fornecedorSelect && fornecedorSelect.options.length > 1) {
                    // Tentar encontrar o fornecedor exato
                    let encontrou = false;
                    for (let i = 0; i < fornecedorSelect.options.length; i++) {
                        if (fornecedorSelect.options[i].value === dadosRascunho.fornecedor || 
                            fornecedorSelect.options[i].textContent === dadosRascunho.fornecedor) {
                            fornecedorSelect.selectedIndex = i;
                            encontrou = true;
                            console.log('✅ Fornecedor selecionado:', dadosRascunho.fornecedor);
                            
                            // Disparar evento de mudança para atualizar o estado
                            const evento = new Event('change', { bubbles: true });
                            fornecedorSelect.dispatchEvent(evento);
                            
                            break;
                        }
                    }
                    
                    if (!encontrou) {
                        console.warn('⚠️ Fornecedor não encontrado nas opções:', dadosRascunho.fornecedor);
                        console.log('📋 Opções disponíveis:', Array.from(fornecedorSelect.options).map(opt => opt.value));
                    }
                } else if (tentativa < maxTentativas) {
                    console.log(`🔄 Tentativa ${tentativa}: Aguardando carregamento de fornecedores...`);
                    setTimeout(() => tentarPreencherFornecedor(tentativa + 1, maxTentativas), 500);
                } else {
                    console.warn('⚠️ Timeout: Não foi possível carregar fornecedores');
                }
            }
            
            // Função para tentar preencher veículo com retry
            function tentarPreencherVeiculo(tentativa = 1, maxTentativas = 10) {
                const veiculoSelect = document.getElementById('nomeVeiculo');
                
                if (veiculoSelect && veiculoSelect.options.length > 1 && dadosRascunho.nomeVeiculo) {
                    // Tentar encontrar o veículo exato
                    let encontrou = false;
                    for (let i = 0; i < veiculoSelect.options.length; i++) {
                        if (veiculoSelect.options[i].value === dadosRascunho.nomeVeiculo || 
                            veiculoSelect.options[i].textContent === dadosRascunho.nomeVeiculo) {
                            veiculoSelect.selectedIndex = i;
                            encontrou = true;
                            console.log('✅ Veículo selecionado:', dadosRascunho.nomeVeiculo);
                            break;
                        }
                    }
                    
                    if (!encontrou) {
                        console.warn('⚠️ Veículo não encontrado nas opções:', dadosRascunho.nomeVeiculo);
                    }
                } else if (tentativa < maxTentativas && dadosRascunho.nomeVeiculo) {
                    console.log(`🔄 Tentativa ${tentativa}: Aguardando carregamento de veículos...`);
                    setTimeout(() => tentarPreencherVeiculo(tentativa + 1, maxTentativas), 500);
                }
            }
            
            // Preencher campos básicos
            if (dadosRascunho.data) {
                const dataPedido = document.getElementById('dataPedido');
                if (dataPedido) {
                    dataPedido.value = dadosRascunho.data;
                    console.log('✅ Data preenchida:', dadosRascunho.data);
                } else {
                    console.warn('⚠️ Campo dataPedido não encontrado');
                }
            }
            
            // Tentar preencher fornecedor com retry
            if (dadosRascunho.fornecedor) {
                tentarPreencherFornecedor();
            }
            
            // Tentar preencher veículo com retry
            if (dadosRascunho.nomeVeiculo) {
                tentarPreencherVeiculo();
            }
            
            if (dadosRascunho.placaVeiculo) {
                const placaInput = document.getElementById('placaVeiculo');
                if (placaInput) {
                    placaInput.value = dadosRascunho.placaVeiculo;
                    console.log('✅ Placa preenchida:', dadosRascunho.placaVeiculo);
                } else {
                    console.warn('⚠️ Campo placaVeiculo não encontrado');
                }
            }
            
            if (dadosRascunho.observacoes) {
                const observacoesInput = document.getElementById('observacoesPedido');
                if (observacoesInput) {
                    observacoesInput.value = dadosRascunho.observacoes;
                    console.log('✅ Observações preenchidas:', dadosRascunho.observacoes);
                } else {
                    console.warn('⚠️ Campo observacoesPedido não encontrado');
                }
            }
            
            // Preencher itens
            if (dadosRascunho.itens && Array.isArray(dadosRascunho.itens)) {
                console.log('📦 Iniciando preenchimento de itens. Total:', dadosRascunho.itens.length);
                
                // Limpar itens existentes
                const tableBody = document.getElementById('itensTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '';
                    itemCounter = 0;
                    console.log('🗑️ Tabela de itens limpa');
                    
                    // Reinicializar array de itens
                    if (!window.itensAdicionados) {
                        window.itensAdicionados = [];
                    }
                    window.itensAdicionados = [];
                    
                } else {
                    console.error('❌ Tabela de itens não encontrada!');
                    return;
                }
                
                // Adicionar itens do rascunho diretamente à tabela
                dadosRascunho.itens.forEach((item, index) => {
                    console.log(`📦 Adicionando item ${index + 1} à tabela:`, item);
                    
                    // Incrementar contador
                    itemCounter++;
                    
                    // Calcular subtotal
                    const quantidade = parseFloat(item.quantidade) || 1;
                    const precoUnitario = parseFloat(item.precoUnitario) || 0;
                    const subtotal = quantidade * precoUnitario;
                    
                    // Criar nova linha na tabela
                    const row = document.createElement('tr');
                    row.setAttribute('data-item-id', itemCounter);
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900">${item.descricao || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 text-center">${quantidade.toLocaleString('pt-BR')}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 text-center">${item.unidade || ''}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 text-right">R$ ${precoUnitario.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 text-right">R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="px-6 py-4 text-center">
                            <button type="button" class="text-red-600 hover:text-red-800 font-medium" onclick="removerItem(${itemCounter})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    // Adicionar à tabela
                    tableBody.appendChild(row);
                    
                    // Armazenar dados do item
                    window.itensAdicionados.push({
                        id: itemCounter,
                        descricao: item.descricao || '',
                        quantidade: quantidade,
                        unidade: item.unidade || '',
                        precoUnitario: precoUnitario,
                        subtotal: subtotal // Usando 'subtotal' para compatibilidade com calcularTotalGeral()
                    });
                    
                    console.log(`✅ Item ${itemCounter} adicionado à tabela: ${item.descricao}`);
                });
                
                // Recalcular total geral
                setTimeout(() => {
                    console.log('🧮 Recalculando total geral...');
                    calcularTotalGeral();
                }, 200);
            } else {
                console.warn('⚠️ Nenhum item encontrado no rascunho ou itens não é um array');
            }
        }
        
        // Função para limpar dados de edição de rascunho
        function limparDadosEdicaoRascunho() {
            localStorage.removeItem('editandoRascunho');
            localStorage.removeItem('rascunhoId');
            localStorage.removeItem('dadosRascunho');
            console.log('🧹 Dados de edição de rascunho limpos');
        }
        
        function mostrarIndicadorRascunho(rascunhoId) {
            const draftStatus = document.getElementById('draft-status');
            if (draftStatus) {
                draftStatus.classList.remove('hidden');
                draftStatus.innerHTML = `<i class="fas fa-edit mr-2"></i>Editando Rascunho - ID: ${rascunhoId}`;
            }
        }

        // ===============================================
        // FUNÇÃO DE TESTE PARA VERIFICAR ESTADOS
        // ===============================================
        
        window.testarEstadosFornecedores = function() {
            console.log('🔍 === TESTE DE ESTADOS DOS FORNECEDORES ===');
            google.script.run
                .withSuccessHandler(fornecedores => {
                    console.log('📋 Total de fornecedores:', fornecedores.length);
                    fornecedores.forEach((f, index) => {
                        console.log(`${index + 1}. ${f.razao} - Estado: "${f.estado || 'VAZIO'}"`);
                    });
                    
                    const comEstado = fornecedores.filter(f => f.estado && f.estado.trim());
                    console.log(`✅ Fornecedores COM estado: ${comEstado.length}`);
                    console.log(`❌ Fornecedores SEM estado: ${fornecedores.length - comEstado.length}`);
                    
                    if (comEstado.length > 0) {
                        console.log('🎯 Fornecedores que podem ser usados para teste:');
                        comEstado.slice(0, 3).forEach(f => {
                            console.log(`   - ${f.razao} (${f.estado})`);
                        });
                    }
                })
                .withFailureHandler(err => {
                    console.error('❌ Erro ao buscar fornecedores:', err);
                })
                .getFornecedoresListv2();
        };
        
        window.testarCaptura = function(nomeFornecedor) {
            console.log('🔍 === TESTE DE CAPTURA DE ESTADO ===');
            console.log(`📋 Testando fornecedor: ${nomeFornecedor}`);
            google.script.run
                .withSuccessHandler(resultado => {
                    console.log('✅ Resultado do teste:', resultado);
                })
                .withFailureHandler(err => {
                    console.error('❌ Erro no teste:', err);
                })
                .testarEstadoFornecedor(nomeFornecedor);
        };
        
        // ===============================================
        // INICIALIZAÇÃO DO APP
        // ===============================================
        
        // Expor funções de teste globalmente
        //window.testarBotaoAdicionarItem = testarBotaoAdicionarItem;
       // window.testarEnterKeydown = testarEnterKeydown;
        window.itemCounter = itemCounter;
        
        document.addEventListener('DOMContentLoaded', () => {
            setupLoginScreen();
            setupCadastroScreen();
            showScreen('screen-login');
            document.getElementById('username').focus();
            //setupMenuScreen();

        });
    </script>
</body>
</html>
